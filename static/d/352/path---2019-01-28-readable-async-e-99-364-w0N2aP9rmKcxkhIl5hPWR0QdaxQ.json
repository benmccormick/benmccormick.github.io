{"data":{"markdownRemark":{"html":"<p>When it first became a part of JavaScript, I wasn’t sure how much I was going to use async-await.  I could see that it made things prettier in some cases, but I was pretty happy with my promise chains and thought that async-await might just be some extra language baggage.  Since then I’ve fully converted; it’s one of my favorite features added to the language in recent years.  The reason?  It helps you write code in a linear manner.</p>\n<p>A principle of readable code:</p>\n<blockquote>\n<p>Code should where possible be written in the order in which a reader needs to understand it.1</p>\n</blockquote>\n<p>For complex classes, this ideally means that the “entry points” are towards the top, with the helper methods below to be read as needed<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>. But for “linear” code that reflects a workflow, we want the code to progress in chronological order as much as possible.  With imperative code that tends to happen by default.  But JavaScript’s asynchronous constructs have tended to obscure chronological orders.</p>\n<p>As an example, here is a React component that displays the time remaining in a user session based off of some cookie values.  It checks a cookie on a regular interval to see whether it should display a warning about the session timeout.  Once it is showing the warning, it begins checking the cookie more frequently in order to show a timeout.  Once the session expires, it can stop checking.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// When time is less than this, we should show warning</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_TIME_TO_HIDE_WARNING</span> <span class=\"token operator\">=</span> <span class=\"token number\">1000</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// intervals in seconds to update timeout count</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">CHECK_INTERVAL_WHEN_HIDING</span> <span class=\"token operator\">=</span> <span class=\"token number\">30</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">CHECK_INTERVAL_WHEN_SHOWING</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ShowSessionTime</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            timeRemaining<span class=\"token punctuation\">:</span> <span class=\"token constant\">MAX_TIME_TO_HIDE_WARNING</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n   <span class=\"token comment\">/* Update the remaining time till session timeout */</span>\n    <span class=\"token function\">updateRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> currentTime <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> timeRemaining <span class=\"token operator\">=</span> <span class=\"token function\">getCookie</span><span class=\"token punctuation\">(</span><span class=\"token string\">'serverExpiry'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> currentTime<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            timeRemaining<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> timeRemaining<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// while the modal is open, update every cycle but stop when the time remaining is 0</span>\n        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">whileOpenCheck</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> timeRemaining <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">updateRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeRemaining <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>whileOpenCheck<span class=\"token punctuation\">,</span> <span class=\"token constant\">CHECK_INTERVAL_WHEN_SHOWING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// while the modal is closed, update every cycle but switch to the open cycle when we reach the threshold</span>\n        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">whileClosedCheck</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> timeRemaining <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">updateRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeRemaining <span class=\"token operator\">></span> <span class=\"token constant\">MAX_TIME_TO_HIDE_WARNING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>whileClosedCheck<span class=\"token punctuation\">,</span> <span class=\"token constant\">CHECK_INTERVAL_WHEN_HIDING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>whileOpenCheck<span class=\"token punctuation\">,</span> <span class=\"token constant\">CHECK_INTERVAL_WHEN_SHOWING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// kick off our timeout loop</span>\n        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>whileClosedCheck<span class=\"token punctuation\">,</span> <span class=\"token constant\">CHECK_INTERVAL_WHEN_HIDING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span>timeRemaining<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> showWarning <span class=\"token operator\">=</span> timeRemaining <span class=\"token operator\">></span> <span class=\"token constant\">MAX_TIME_TO_HIDE_WARNING</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> showWarning <span class=\"token operator\">?</span> <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>Time Remaining In Session<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>timeRemaining<span class=\"token punctuation\">}</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">componentDidMount</code> method is the interesting part here.  Notice how the setTimeout based flow has resulted in the flow being reversed?</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// THIS PART HAPPENS LAST IF AT ALL</span>\n        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">whileOpenCheck</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> timeRemaining <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">updateRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeRemaining <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>whileOpenCheck<span class=\"token punctuation\">,</span> <span class=\"token constant\">CHECK_INTERVAL_WHEN_SHOWING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// THIS IS THE FIRST RECURSIVE LOOP</span>\n        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">whileClosedCheck</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> timeRemaining <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">updateRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeRemaining <span class=\"token operator\">></span> <span class=\"token constant\">MAX_TIME_TO_HIDE_WARNING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>whileClosedCheck<span class=\"token punctuation\">,</span> <span class=\"token constant\">CHECK_INTERVAL_WHEN_HIDING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>whileOpenCheck<span class=\"token punctuation\">,</span> <span class=\"token constant\">CHECK_INTERVAL_WHEN_SHOWING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// THIS IS THE ENTRY POINT</span>\n        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>whileClosedCheck<span class=\"token punctuation\">,</span> <span class=\"token constant\">CHECK_INTERVAL_WHEN_HIDING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The code is super hard to follow because its defined all out of order.  You have to understand the whole thing before you can wrap your mind around any piece of it, and your eye is going to be wandering back and forth.  Compare that to this reimplementation with async/await:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">async</span> <span class=\"token function\">checkRemainingAtIntervals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">updateRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token constant\">MAX_TIME_TO_HIDE_WARNING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CHECK_INTERVAL_WHEN_HIDING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">updateRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CHECK_INTERVAL_WHEN_SHOWING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkRemainingAtIntervals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>We’ve pulled the logic out into a separate async function and suddenly everything is so much simpler: we’re just using basic loops, with each loop condition updating the remaining time and then checking to see if we should keep looping.  Sleep in this case is just a <a href=\"https://benmccormick.org/2015/12/30/es6-patterns-converting-callbacks-to-promises\">promisified</a> setTimeout:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">sleep</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">millisecs</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> millisecs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In fact this version is so much simpler that when I originally wrote the code that this post is based on, I immediately saw a bug that I had missed in the complex version: the time remaining in a session can go up as well as down.  If a user makes a request after I show the warning, the interval will go up and we should re-hide the warning.  But my first few takes both ignored that complexity.  Fortunately it’s easy enough to add:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">async</span> <span class=\"token function\">checkRemainingAtIntervals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> remaining <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">updateRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// keep checking until the session expires</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>remaining <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> warningIsShowing <span class=\"token operator\">=</span> remaining <span class=\"token operator\">></span> <span class=\"token constant\">MAX_TIME_TO_HIDE_WARNING</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">let</span> interval <span class=\"token operator\">=</span>  warningIsShowing <span class=\"token operator\">?</span>\n                <span class=\"token constant\">CHECK_INTERVAL_WHEN_HIDING</span> <span class=\"token punctuation\">:</span>\n                <span class=\"token constant\">CHECK_INTERVAL_WHEN_SHOWING</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">await</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>interval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            remaining <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">updateRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>We’ve actually gotten even simpler here, with a single loop that runs until the session\nexpires.  Each time the loop runs, it checks to see whether it should wait for a long or short interval before updating the remaining time again.  Everything happens in ~8 highly readable lines that will be easy to follow for anyone who has used a while loop.</p>\n<p>Compared to our original version we have</p>\n<ol>\n<li>Cut out several “intermediary variables” that were mostly managing complexity around async, but weren’t part of the core problem</li>\n<li>Matched the visual flow to the workflow</li>\n<li>Simplified enough to catch a bug that I missed originally</li>\n</ol>\n<p>I’m going to continue to use async-await as the basis for most of my asynchronous code going forward for benefits like this.  If you’ve been holding out, browser support has gotten very good and this is a great time to jump in.</p>\n<p><strong>TL;DR</strong></p>\n<ul>\n<li><strong>Async Await can help readability by matching code structure to the program workflow</strong></li>\n<li><strong>Code that is structured more naturally can be easier to debug and see errors in</strong></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>React’s convention of putting render at the bottom of class components has always annoyed me as a result of this.</p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","frontmatter":{"title":"Improving Code Readability With Async/Await","keywords":"async await","category":"javascript","date":"2019/01/28","path":"/2019/01/28/readable-async","layout":"post","hideFooter":null,"hideSidebar":null},"fields":{"slug":"/2019/01/28/readable-async"}}},"pageContext":{"slug":"/2019/01/28/readable-async","relatedPosts":[{"path":"/2015/12/30/es6-patterns-converting-callbacks-to-promises","data":{"title":"ES6 Patterns: Converting Callbacks to Promises","path":"/2015/12/30/es6-patterns-converting-callbacks-to-promises","description":"How to convert a callback driven API to a Promise-based one","date":"2015-12-30T03:30:47+00:00","category":"javascript"}},{"path":"/2019/01/07/the-concerns-of-fe-architecture/","data":{"title":"What's involved in Front End Architecture?","path":"/2019/01/07/the-concerns-of-fe-architecture/","description":"6 areas of interest in front end software design discussions","date":"2019/01/07","category":"fe-architecture"}},{"path":"/2019/01/14/value-from-code-reviews","data":{"title":"6 Keys To Valuable Code Reviews","path":"/2019/01/14/value-from-code-reviews","description":"Getting the most out of your code review process","date":"2019/01/14","category":"soft-skills"}}]}}