{"pageContext":{"posts":[{"node":{"frontmatter":{"readNext":"sieveoferatosthenes,evil-js,code-golf-array-holes","topics":["Math","Go"],"category":"computer-science","key":"prime-generation-revisited","title":"Prime Generation Revisited","description":"Implementing The Sieve Of Eratosthenes in Go","layout":"post","path":"/2018/07/15/prime-generation-revisited/","date":"2018/07/15","dontfeature":null,"isDraft":null},"html":"<p>I’ve been wanting to try learning a new programming language again for a while, and this weekend decided to play around with <a href=\"https://golang.org/\">Go</a> for the first time in a while.  Go is a statically typed, compiled language useful for systems programming, which makes it a nice complement to my 2 primary languages, JavaScript and Python.  To help myself learn, I decided to revisit the <a href=\"https://benmccormick.org/2017/11/28/sieveoferatosthenes/\">Sieve of Eratosthenes problem</a> that I wrote about last year.  I already had implementations in Python and JavaScript, and thought it would be interesting to see how the code and performance compared.</p>\n<p>As a refresher, the Sieve of Eratosthenes is a method for generating prime numbers by iterating through numbers and marking all multiples of primes we encounter as not prime.  The original algorithm is useful for finding small primes up to a limit, but will eventually consume infinite memory for computers or infinite time for humans.  I used a modified algorithm in my JavaScript implementation that only marks numbers as they become relevant, you can read more details about the problem in <a href=\"https://benmccormick.org/2017/11/28/sieveoferatosthenes/\">the original post</a> but using the JavaScript implementation to generate the 1 millionth prime looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">generatePrimes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> markedNotPrimeMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> valueToCheck <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>markedNotPrimeMap<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>valueToCheck<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">yield</span> valueToCheck\n            markedNotPrimeMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>valueToCheck<span class=\"token operator\">**</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>valueToCheck<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> primes <span class=\"token operator\">=</span>markedNotPrimeMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>valueToCheck<span class=\"token punctuation\">)</span>\n            primes<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">prime</span><span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">let</span> nextMultipleOfPrime <span class=\"token operator\">=</span> prime <span class=\"token operator\">+</span> valueToCheck<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>markedNotPrimeMap<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>nextMultipleOfPrime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    markedNotPrimeMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nextMultipleOfPrime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>prime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    markedNotPrimeMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nextMultipleOfPrime<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>prime<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            markedNotPrimeMap<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>valueToCheck<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        valueToCheck <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">let</span> counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> p <span class=\"token keyword\">of</span> <span class=\"token function\">generatePrimes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    counter <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>counter <span class=\"token operator\">>=</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That executes in ~10.5 seconds on my Macbook Pro, and the similar Python implementation averages about 23 seconds.  I was curious how fast a Go solution would execute, since it is known for being fast.</p>\n<p>I put a Go version together like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"fmt\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"strconv\"</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">generate_primes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span> <span class=\"token punctuation\">{</span>\n    c <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> marked_not_prime_map <span class=\"token operator\">=</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> value_to_check <span class=\"token operator\">:=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">;</span> value_to_check<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">var</span> primes<span class=\"token punctuation\">,</span> in_map <span class=\"token operator\">=</span> marked_not_prime_map<span class=\"token punctuation\">[</span>value_to_check<span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>in_map <span class=\"token punctuation\">{</span>\n                c <span class=\"token operator\">&lt;-</span> value_to_check\n                <span class=\"token keyword\">var</span> values <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span>\n                marked_not_prime_map<span class=\"token punctuation\">[</span>value_to_check<span class=\"token operator\">*</span>value_to_check<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">,</span> value_to_check<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> prime <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> primes <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">var</span> next_multiple_of_prime <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> prime <span class=\"token operator\">+</span> value_to_check\n                    <span class=\"token keyword\">var</span> next_multiples<span class=\"token punctuation\">,</span> next_in_map <span class=\"token operator\">=</span> marked_not_prime_map<span class=\"token punctuation\">[</span>next_multiple_of_prime<span class=\"token punctuation\">]</span>\n                    <span class=\"token keyword\">if</span> next_in_map <span class=\"token punctuation\">{</span>\n                        marked_not_prime_map<span class=\"token punctuation\">[</span>next_multiple_of_prime<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>next_multiples<span class=\"token punctuation\">,</span> prime<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">var</span> values <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span>\n                        marked_not_prime_map<span class=\"token punctuation\">[</span>next_multiple_of_prime<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">,</span> prime<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>marked_not_prime_map<span class=\"token punctuation\">,</span> value_to_check<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> c\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    c <span class=\"token operator\">:=</span> <span class=\"token function\">generate_primes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> counter <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">for</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> p <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;-</span>c\n        <span class=\"token keyword\">if</span> counter <span class=\"token operator\">>=</span> <span class=\"token number\">1000000</span> <span class=\"token punctuation\">{</span>\n            fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>strconv<span class=\"token punctuation\">.</span><span class=\"token function\">Itoa</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">break</span>\n        <span class=\"token punctuation\">}</span>\n        counter<span class=\"token operator\">++</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The Go version is about 50% longer than the JavaScript version due to boilerplate but is more or less a direct 1 to 1 translation of the JavaScript code.  In Go, generators are created using channels and goroutines.  Goroutines are special functions that can run concurrently to the main thread in Go, and channels are a mechanism for passing data from them, that block the goroutine until the message is received.  So a goroutine that will pass multiple messages through to a channel is essentially equivalent to a Python or JavaScript generator using <code class=\"language-text\">yield</code>.  Beyond that, most of the syntax difference is around the ceremony required for using slices in Go , and checking whether an item exists in a map.  Slices are Go’s version of a dynamic length array/list, they require an <code class=\"language-text\">append</code> function which returns a new slice to add a value.  Go doesn’t have a <code class=\"language-text\">has</code> method or equivalent on it’s map types.  Instead when you attempt to access a value from a map, the map returns 2 values: the received value or the “zero value” of the map’s type and a boolean saying whether the access was successful.  So you have code like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\">commits <span class=\"token operator\">:=</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"example\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">var</span> val<span class=\"token punctuation\">,</span> has_val <span class=\"token operator\">=</span> commits<span class=\"token punctuation\">[</span><span class=\"token string\">\"example\"</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\">// val == 100, has_val == true</span>\n<span class=\"token keyword\">var</span> val2<span class=\"token punctuation\">,</span> has_val2 <span class=\"token operator\">=</span> commits<span class=\"token punctuation\">[</span><span class=\"token string\">\"example2\"</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\">// val == 0, has_val == false</span></code></pre></div>\n<p>So does all of this ceremony buy us any performance?  Only a minimal amount in this case.  After timing each script several time the Python code averaged out to 23 seconds, the JavaScript averaged 10.5 seconds, and the Go version averaged 9.5 seconds.  It’s the fastest, but only by minimal amounts over the JavaScript.  A good reminder that the algorithm will generally matter more than the programming language for many things, and also that large companies have optimized the heck out of JavaScript in recent years to the point where it’s pretty competitive on single threaded performance for many tasks.</p>","fields":{"slug":"/2018/07/15/prime-generation-revisited/"}}}],"topic":"Go"}}