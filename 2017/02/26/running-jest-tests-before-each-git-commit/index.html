<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=yyxgnp97qG"/><link rel="icon" type="image/png" href="/favicon-32x32.png?v=yyxgnp97qG" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png?v=yyxgnp97qG" sizes="16x16"/><link rel="manifest" href="/manifest.json"/><link rel="mask-icon" href="/safari-pinned-tab.svg?v=yyxgnp97qG" color="#57a3e8"/><link rel="alternate" title="JSON Feed" type="application/json" href="/feed.json"/><link rel="shortcut icon" href="/favicon.ico?v=yyxgnp97qG"/><meta name="theme-color" content="#ffffff"/><script type="text/javascript" src="//use.typekit.net/msd6bqv.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script><title data-react-helmet="true">Running Jest Tests Before Each Git Commit | benmccormick.org</title><meta data-react-helmet="true" name="description" content="Ben McCormick&#x27;s blog on JavaScript and Web Development"/><meta data-react-helmet="true" name="keywords" content="Jest testing git pre-commit JavaScript"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:site" content="@benmccormickorg"/><meta data-react-helmet="true" name="twitter:creator" content="@ben336"/><meta data-react-helmet="true" name="twitter:title" content="Running Jest Tests Before Each Git Commit"/><meta data-react-helmet="true" name="twitter:description" content=""/><meta data-react-helmet="true" name="twitter:image" content="http://benmccormick.org/logo.png"/><script data-react-helmet="true" type="application/ld+json">{
                  "@context": "http://schema.org"
                  "@type": "BlogPosting",
                  "headline": "Running Jest Tests Before Each Git Commit",
                  "genre": "Software Development",
                  "keywords": "Jest testing git pre-commit JavaScript",
                  "url": "http://benmccormick.org/2017/02/26/running-jest-tests-before-each-git-commit/",
                  "image": "http://benmccormick.org/logo.png",
                  "datePublished": "2017-02-26",
                  
                  "articleBody": "<p>My main work project makes heavy use of <a href=\"https://facebook.github.io/jest/\">Jest</a> to test our JavaScript code.  For a while now I’ve wanted to set up a way to run tests every time I run a commit.  I knew that git provides <a href=\"https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks\">hooks</a> that allow scripting actions to occur before or after any commit or push, and in fact we were already using a <code>pre-commit</code> hook script to lint our code with <a href=\"http://eslint.org/\">ESLint</a>.  But it was non-obvious how to make that work well with Jest testing.  I eventually figured out a setup that worked, and the found a better way to do both the Jest and ESLint testing.  Since it took me a while to work through, I thought I’d share it here and save the rest of you some time.</p>
<h3>What didn’t work</h3>
<p>A naive approach to this problem would be to set up a pre-commit hook that simply ran <code>jest</code> to run all tests. The problem is that running our full test suite currently takes between 10 and 20 seconds to run all tests and that time is increasing as we grow our test suite.  Adding that overhead to every commit would cost my team a lot of time, and would be especially inefficient since the repo contains plenty non-JavaScript code that doesn’t require tests to be run when updated.</p>
<p>For our ESLint hook, we queried git to get a list of staged files, and then ran eslint against each one of them individually, displaying a pass/fail message.  That looked something like this:</p>
<div class=\"gatsby-highlight\">
      <pre class=\"language-bash\"><code>STAGED_FILES<span class=\"token operator\">=</span><span class=\"token punctuation\">$(</span>git <span class=\"token function\">diff</span> --cached --name-only --diff-filter<span class=\"token operator\">=</span>ACM <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"js$\"</span><span class=\"token punctuation\">)</span>
<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$STAGED_FILES</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>
    <span class=\"token keyword\">exit</span> 0
<span class=\"token keyword\">fi</span>

PASS<span class=\"token operator\">=</span>true

<span class=\"token keyword\">for</span> FILE <span class=\"token keyword\">in</span> <span class=\"token variable\">$STAGED_FILES</span>
<span class=\"token keyword\">do</span>
    eslint --quiet <span class=\"token string\">\"<span class=\"token variable\">$FILE</span>\"</span>

    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$?</span>\"</span> <span class=\"token operator\">==</span> 0 <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>
        <span class=\"token keyword\">echo</span> <span class=\"token string\">\"\t\033[32mESLint Passed: <span class=\"token variable\">$FILE</span>\033[0m\"</span>
    <span class=\"token keyword\">else</span>
        <span class=\"token keyword\">echo</span> <span class=\"token string\">\"\t\033[41mESLint Failed: <span class=\"token variable\">$FILE</span>\033[0m\"</span>
        PASS<span class=\"token operator\">=</span>false
    <span class=\"token keyword\">fi</span>
<span class=\"token keyword\">done</span>
</code></pre>
      </div>
<p>This works great for ESLint, but doesn’t work out of the box for Jest, because I don’t want Jest to run the files that changed, I want them to run any tests that changed AND any tests that might have been broken because of that.</p>
<p>Jest has a wonderful command line flag <code>jest --onlyChanged</code>/<code>jest -o</code> that runs only the tests related to files that have been changed according to git.  It is extremely helpful since it is smart enough to read the dependency structure for the project and run all tests that might be changed from updating a source file. It also has a <code>--lastCommit</code> option that does the same thing for files that were in the previous commit.  Unfortunately, these options aren’t helpful at the point of committing, since <code>onlyChanged</code> does not look at files that have been staged for commit, and we haven’t actually made a commit yet for <code>lastCommit</code> to read.</p>
<h3>What Did Work</h3>
<p>Fortunately Jest has a lower level command that uses the same logic as <code>onlyChanged</code> and <code>lastCommit</code>.  <code>--findRelatedTests</code> is a flag that tells Jest to run any tests related to the files passed to it instead of trying to run those files as tests as it would normally do.</p>

          <a
            class=\"gatsby-resp-image-link\"
            href=\"/static/9350cbcea06e8f1f423335d94d84ac98-a6c06.png\"
            style=\"display: block\"
            target=\"_blank\"
            rel=\"noopener\"
          >
            <span
              class=\"gatsby-resp-image-wrapper\"
              style=\"position: relative; z-index: -1; display: block; \"
            >
              <span
                class=\"gatsby-resp-image-background-image\"
                style=\"padding-bottom: 81.97573656845753%;position: relative; width: 100%; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAAB4klEQVQ4y6WTTW/TQBCG88u4ceOAxC/gzJ0T/4YDQohDVSGoQEhUqErTElzZ8ffaa69jJ3ZsJ7aTNi3wMrtBQNUDbjmMxh5p3p2PZwZl4cGLOXwyJrj6FunOVzlDW3r4vhH4cd7PBgefnmDvw2PUiwDFzAXzNUShjjQxkQqDRO3bCb588wDP9+6hrXyUcwvmZAjHPobnnoB5pwjZGKuFi8uW9xN8/e4RXuzfR0OtpUKHpn2GYRxB149g2yP47qkSLmYWVRr/W/DV24eqwo4qXBYOePAVSXQG1znBLDFU/HwV9G9ZRAeYJu9V0mXHcdGE2CwZutpXC1nXrHe7SpDTjGQlde4oEVmhnF+emajmNrJkoh7qLWhbx2rwMlkm7jbr9Ba4IShntG13rUovW9/eosUbglUZYDrnyrI8QjLjyIudb0pGfNJSOoGLtVB+S/5qI37HpG3Xf+KDw+Ez7H98iiwLIIQHxzPA2ARhaCHiBtLMRbGcomoSVKupsrZNsKT/BcVr8jXFFr/i1zjM0wnG40O4xJ/kMOaaiimwey7mGodFasIyh8TgiK5lRGf4BYKfIQ41dUW9wP6bQ2mNYs9XD0ge5UnKhX1bx3fgkJIDqkpyOKdWy//l8KqLMI11BfVdsfkJ8S6g9C3bagEAAAAASUVORK5CYII='); background-size: cover; display: block;\"
              >
                <img
                  class=\"gatsby-resp-image-image\"
                  style=\"width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"
                  alt=\"an example of findRelatedTests running against the redux repo\"
                  title=\"\"
                  src=\"/static/9350cbcea06e8f1f423335d94d84ac98-96365.png\"
                  srcset=\"/static/9350cbcea06e8f1f423335d94d84ac98-c0cbb.png 143w,
/static/9350cbcea06e8f1f423335d94d84ac98-0e313.png 285w,
/static/9350cbcea06e8f1f423335d94d84ac98-96365.png 570w,
/static/9350cbcea06e8f1f423335d94d84ac98-a6c06.png 577w\"
                  sizes=\"(max-width: 570px) 100vw, 570px\"
                />
              </span>
            </span>
          </a>
          
<p>This is a perfect fit for a pre-commit hook.  I was able to integrate it into my existing script like this:</p>
<div class=\"gatsby-highlight\">
      <pre class=\"language-bash\"><code>jest --bail --findRelatedTests <span class=\"token variable\">$STAGED_FILES</span>
<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$?</span>\"</span> <span class=\"token operator\">==</span> 0 <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>
    <span class=\"token keyword\">echo</span> <span class=\"token string\">\"\t\033[32mJest Tests Passed\033[0m\"</span>
<span class=\"token keyword\">else</span>
    <span class=\"token keyword\">echo</span> <span class=\"token string\">\"\t\033[41mJest Tests Failed\033[0m\"</span>
    PASS<span class=\"token operator\">=</span>false
<span class=\"token keyword\">fi</span>
</code></pre>
      </div>
<p><code>$STAGED_FILES</code> is re-used from the eslint portion of the script, and is just a space delimited list of files that are being committed.  The <code>--bail</code> option simply stops running tests as soon as one has failed.  Including that is optional, you won’t see all the tests that have failed, but the failure will happen faster and you’ll be able to decide how to proceed, including possibly running the full test script on your own.   </p>
<p>Those lines (along with some sanity checks for the existence of Jest and error handling when PASS is set to false) are enough to get a workable commit hook going, but they’re not ideal.  pre-commit hooks aren’t persisted by git, so each user has to install the hook script individually, and any updates aren’t shared automatically.  Plus I’m inefficiently passing all staged files to eslint and Jest regardless of whether they’re JavaScript that those tools are actually meant to work on.  My ESLint code was also written before ESLint developed robust <code>--fix</code> capabilities, and doesn’t try to fix the errors it is capable of fixing.  Finally, while this is just poor coding and not an inherent limitation of my other method, I’m using globally installed versions of Jest and ESLint instead of scoping them to my project.</p>
<h3>Making it better</h3>
<p>Fortunately I’d discovered a better solution the other day while working on something else.  There is an npm package for making this process easier, <a href=\"https://github.com/okonet/lint-staged\">lint-staged</a>.  Lint staged abstracts away the boilerplate of getting the staged files, and makes it easy to run local node executables against specific sets of files.  I was able to replace my whole pre-commit script and address all of the problems mentioned above with only a few lines in my package.json:</p>
<div class=\"gatsby-highlight\">
      <pre class=\"language-json\"><code><span class=\"token punctuation\">{</span>
  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>
    <span class=\"token property\">\"lint-staged\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"lint-staged\"</span><span class=\"token punctuation\">,</span>
  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>
  <span class=\"token property\">\"lint-staged\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>
    <span class=\"token property\">\"*.js\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>
      <span class=\"token string\">\"eslint --fix\"</span><span class=\"token punctuation\">,</span>
      <span class=\"token string\">\"git add\"</span><span class=\"token punctuation\">,</span>
      <span class=\"token string\">\"jest --bail --findRelatedTests\"</span>
    <span class=\"token punctuation\">]</span>
  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>
  <span class=\"token property\">\"devDependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>
    <span class=\"token property\">\"eslint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.16.1\"</span><span class=\"token punctuation\">,</span>
    <span class=\"token property\">\"jest\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"19.0.1\"</span><span class=\"token punctuation\">,</span>
    <span class=\"token property\">\"lint-staged\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.3.1\"</span><span class=\"token punctuation\">,</span>
  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>
<span class=\"token punctuation\">}</span>
</code></pre>
      </div>
<p><code>lint-staged</code> now handles making sure that I’m only running checks against JavaScript files, lets eslint autofix and stage any files that it can fix, and uses the local versions of jest and eslint.  It also adds a nice pretty interface for the results:</p>

          <a
            class=\"gatsby-resp-image-link\"
            href=\"/static/07049d14abcd3c0065c9779b76d22045-0957d.png\"
            style=\"display: block\"
            target=\"_blank\"
            rel=\"noopener\"
          >
            <span
              class=\"gatsby-resp-image-wrapper\"
              style=\"position: relative; z-index: -1; display: block; \"
            >
              <span
                class=\"gatsby-resp-image-background-image\"
                style=\"padding-bottom: 35.321100917431195%;position: relative; width: 100%; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAA3UlEQVQoz42R2RKCMAxF+///5oyOGyqLqIxABQqUze2aBngUfTiTNJO29yYilTYi6aJQHmrlQqc2iuSAKnOQxRbnfFYO19ryiHdz/oqolI2SLmhqfmgfj8rHqz4xz2pgOI9MPtilB1wvK1KzQ1d6uOtpBb8QbbxBfttDDdzCLVOSdWOzzl0ahYOGonExWv+mVPz78/jAL9siITWF3CMPlqxMXnvSyIIMLcSUG1VFQj0061zuoIi+1i9MZza7NFG0co0mmKMLFqjDJXS0hvJnHI01tkyY2Xa04TsxpfADQvERZDfQoGMAAAAASUVORK5CYII='); background-size: cover; display: block;\"
              >
                <img
                  class=\"gatsby-resp-image-image\"
                  style=\"width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"
                  alt=\"pretty lint-staged output\"
                  title=\"\"
                  src=\"/static/07049d14abcd3c0065c9779b76d22045-96365.png\"
                  srcset=\"/static/07049d14abcd3c0065c9779b76d22045-c0cbb.png 143w,
/static/07049d14abcd3c0065c9779b76d22045-0e313.png 285w,
/static/07049d14abcd3c0065c9779b76d22045-96365.png 570w,
/static/07049d14abcd3c0065c9779b76d22045-58e89.png 855w,
/static/07049d14abcd3c0065c9779b76d22045-0957d.png 872w\"
                  sizes=\"(max-width: 570px) 100vw, 570px\"
                />
              </span>
            </span>
          </a>
          
<p><code>lint-staged</code> docs recommend using an npm based hooks manager like <a href=\"https://github.com/observing/pre-commit\">pre-commit</a> for running the scripts, but due to some quirks in my setup (node_modules is symlinked, and I sometimes want to run these commands inside a docker container), I found it easier to maintain a custom pre-commit script and just replace the previous logic with <code>npm run lint-staged</code>.  Either way, all of the actual logic is now checked into the repository and shared between all users.  The only manual step is adding the call to a pre-commit hook or (if you’re using a helper lib) running npm install.</p>
<h3>More Resources</h3>
<ul>
<li>This maybe merits a future post on its own, but if you’re interested in automating away your code style maintenance look at combining <a href=\"https://github.com/prettier/prettier\">prettier</a> (and possibly  <a href=\"https://github.com/not-an-aardvark/eslint-plugin-prettier\">eslint-plugin-prettier</a>) with the pre-commit hooks from above.  Prettier will guarantee that your code follows a consistent style, and because it handles maximum line lengths, is much more robust than ESLint on its own.  Using its ESLint plugin within my editor and on pre-commit hooks has pretty much eliminated me manually fixing code style problems.</li>
</ul>",
                    "author": {
                      "@type": "Person",
                      "name": "Ben McCormick"
                      "email": "mailto:ben@benmccormick.org",
                      "image": "/profile_pic.jpg",
                      "jobTitle": "Software Engineer",
                      "alumniOf": "Duke",
                      "birthPlace": "Pittsburgh, PA",
                      "gender": "male",
                      "url": "http://benmccormick.org",
                	    "sameAs" : [
                        "https://www.linkedin.com/in/benmccormick",
                        "http://twitter.com/ben336",
                      ]
                   }
                }</script><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:125%/1.55em 'brandon-grotesque','Brandon Grotesque','Helvetica Neue','Helvetica','Arial','Lucida Sans','Geneva','Verdana','sans-serif';box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'brandon-grotesque','Brandon Grotesque','Helvetica Neue','Helvetica','Arial','Lucida Sans','Geneva','Verdana','sans-serif';font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;color:inherit;font-family:'brandon-grotesque','Brandon Grotesque','Helvetica Neue','Helvetica','Arial','Lucida Sans','Geneva','Verdana','sans-serif';font-weight:bold;text-rendering:optimizeLegibility;font-size:1.5rem;line-height:2.325rem;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;color:inherit;font-family:'brandon-grotesque','Brandon Grotesque','Helvetica Neue','Helvetica','Arial','Lucida Sans','Geneva','Verdana','sans-serif';font-weight:bold;text-rendering:optimizeLegibility;font-size:1.27542rem;line-height:1.55rem;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;color:inherit;font-family:'brandon-grotesque','Brandon Grotesque','Helvetica Neue','Helvetica','Arial','Lucida Sans','Geneva','Verdana','sans-serif';font-weight:bold;text-rendering:optimizeLegibility;font-size:1.17608rem;line-height:1.55rem;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;color:inherit;font-family:'brandon-grotesque','Brandon Grotesque','Helvetica Neue','Helvetica','Arial','Lucida Sans','Geneva','Verdana','sans-serif';font-weight:bold;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.55rem;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;color:inherit;font-family:'brandon-grotesque','Brandon Grotesque','Helvetica Neue','Helvetica','Arial','Lucida Sans','Geneva','Verdana','sans-serif';font-weight:bold;text-rendering:optimizeLegibility;font-size:0.92211rem;line-height:1.55rem;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;color:inherit;font-family:'brandon-grotesque','Brandon Grotesque','Helvetica Neue','Helvetica','Arial','Lucida Sans','Geneva','Verdana','sans-serif';font-weight:bold;text-rendering:optimizeLegibility;font-size:0.88547rem;line-height:1.55rem;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}ul{margin-left:1.55rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.55rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;font-size:0.85rem;line-height:1.1;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.1625rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;font-size:1rem;line-height:1.55rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}blockquote{margin-left:1.55rem;margin-right:1.55rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.1625rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.1625rem;}b{font-weight:bold;}strong{font-weight:bold;}dt{font-weight:bold;}th{font-weight:bold;}li{margin-bottom:calc(1.1625rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.55rem;margin-bottom:calc(1.1625rem / 2);margin-top:calc(1.1625rem / 2);}li > ul{margin-left:1.55rem;margin-bottom:calc(1.1625rem / 2);margin-top:calc(1.1625rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.1625rem / 2);}code{font-size:0.85rem;line-height:1.55rem;}kbd{font-size:0.85rem;line-height:1.55rem;}samp{font-size:0.85rem;line-height:1.55rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.03333rem;padding-right:1.03333rem;padding-top:0.775rem;padding-bottom:calc(0.775rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}tt,code{background-color:hsla(0,0%,0%,0.04);border-radius:3px;font-family:"SFMono-Regular", Consolas,"Roboto Mono","Droid Sans Mono","Liberation Mono",Menlo,Courier,monospace;padding:0;padding-top:0.2em;padding-bottom:0.2em;font-size:75%;}pre code{background:none;line-height:1.1;}code:before,code:after,tt:before,tt:after{letter-spacing:-0.2em;content:" ";}pre code:before,pre code:after,pre tt:before,pre tt:after{content:"";}h1,h2,h3,h4,h5,h6{line-height:1.1;}@media only screen and (max-width:480px){html{font-size:112.5%;}}</style><style></style><link rel="preload" href="/page-component---src-templates-blog-post-js-c75e7fa0f2d5fd914fab.js" as="script"/><link rel="preload" href="/path---2017-02-26-running-jest-tests-before-each-git-commit-af36998e5de4bccda260.js" as="script"/><link rel="preload" href="/layout-component---index-3087ff2ee65c4694426d.js" as="script"/><link rel="preload" href="/app-544248e365e246e0d6cc.js" as="script"/><link rel="preload" href="/commons-ab1577e11f4e28e88933.js" as="script"/><script id="webpack-manifest">
            //<![CDATA[
            window.webpackManifest = {"1":"page-component---src-pages-index-js-470937efd25f5ec670ed.js","2":"page-component---src-templates-blog-post-js-c75e7fa0f2d5fd914fab.js","3":"page-component---src-templates-category-page-js-f80f0405128e9939bc2e.js","4":"layout-component---index-3087ff2ee65c4694426d.js","5":"page-component---src-pages-archive-js-4634e5e218944d556cac.js","6":"path---subscribe-c383d66765216fc18b3d.js","7":"path---speaking-d13795d7778bc235925a.js","8":"path---readinglist-2b7f2cc5155b57020131.js","9":"path---offline-plugin-app-shell-fallback-586c7e095e534a3909ec.js","10":"path---marionette-explained-7241de961d5c58ad1124.js","11":"path---learning-vim-in-2014-c8250d620d2a2e96fc6e.js","12":"path---index-04d5e50fb99c1e1442e7.js","13":"path---category-tools-b0837a5cfaf1c4398f43.js","14":"path---category-software-productivity-427c731a429c3723d7eb.js","15":"path---category-reviews-8c5067e6364e69206ae5.js","16":"path---category-platform-e537747be3a4c3bf41c5.js","17":"path---category-opinion-86d274ddc9b2b1d5679e.js","18":"path---category-meta-7c3f8df95aa7d4060e7b.js","19":"path---category-javascript-87746ee016ccd32bc7ce.js","20":"path---category-frameworks-d734a07a7f8393c4323f.js","21":"path---archive-6df092fbd0823a1de0a9.js","22":"path---about-1529e2810ed40c6a3c03.js","23":"path---a-note-to-recruiters-ea9260de501a37576677.js","24":"path---404-html-090d2aa37087dda23f96.js","25":"path---2017-07-19-ten-things-javascript-56c45368e12682de8508.js","26":"path---2017-07-10-how-to-follow-the-javascript-roadmap-fe29f23439018651da97.js","27":"path---2017-06-03-rss-atom-json-gatsby-26b8cc57f3adfe30b876.js","28":"path---2017-05-29-atom-tips-8b401e72e8be639cec41.js","29":"path---2017-05-28-mariana-syntax-atom-051058caac512bbffda2.js","30":"path---2017-05-11-building-normal-curves-highcharts-21965690fd0998426e8e.js","31":"path---2017-04-14-grading-applications-on-config-portability-55d8c1fc82443e37bba9.js","32":"path---2017-03-28-the-mystery-of-docker-and-the-disk-eating-cow-e850473380d9cac52b5f.js","33":"path---2017-02-26-running-jest-tests-before-each-git-commit-af36998e5de4bccda260.js","34":"path---2017-02-18-context-to-best-practices-3ec9d5b81c2f6f161703.js","35":"path---2017-02-13-improving-site-performance-with-lighthouse-7b7996066e25ce3be26a.js","36":"path---2017-01-09-mobx-first-impressions-d486cff1b3650c752fdb.js","37":"path---2017-01-03-orthogonality-and-css-in-js-cd3551f778783a137b59.js","38":"path---2016-12-31-2016-roundup-9890d18133001e823530.js","39":"path---2016-12-14-what-are-higher-order-components-cbc5cb5fa12f9e54fd22.js","40":"path---2016-12-11-readable-code-audience-6d33df8202df2c9e1ceb.js","41":"path---2016-12-10-saving-time-with-jest-b701baceb50c43457a69.js","42":"path---2016-12-02-whole-new-site-2f2cc3e13372a28f096d.js","43":"path---2016-09-19-testing-with-jest-snapshots-first-impressions-0c2d311775ded811864d.js","44":"path---2016-06-26-quick-tip-take-advantage-of-lodash-collections-2-80c69108918c5e419797.js","45":"path---2016-06-04-what-are-mutable-and-immutable-data-structures-2-f3f3bb494fe2c583d2d2.js","46":"path---2016-05-02-digging-into-react-choosing-component-styles-f339ab75ab6db43e2e77.js","47":"path---2016-04-30-ack-tips-a75f569e3f970874b91f.js","48":"path---2016-03-09-stability-vs-decline-9e3c0491f187960e0c87.js","49":"path---2016-03-07-the-sad-state-of-the-backbone-ecosystem-52562d3107f7bd3a222c.js","50":"path---2016-01-25-staying-productive-8fafaea2ba185730aff3.js","51":"path---2016-01-11-the-most-interesting-atom-packages-ive-found-so-far-6955f81d86d20e6ba5bd.js","52":"path---2016-01-08-reusable-code-patterns-fd8919fabe7290706ab2.js","53":"path---2015-12-31-2015-roundup-2-0992f6d299070999cef3.js","54":"path---2015-12-30-es-6-patterns-converting-callbacks-to-promises-7da2213120a9da2c7156.js","55":"path---2015-11-30-es-6-patterns-clean-higher-order-functions-2f0e961654582c518327.js","56":"path---2015-11-25-productive-javascript-development-73cdf4bdaca5d09c2fd4.js","57":"path---2015-09-14-es-5-es-6-es-2016-es-next-whats-going-on-with-javascript-versioning-cc81979c7a6adeee647c.js","58":"path---2015-09-09-what-can-backbone-developers-learn-from-react-4ad4998813a3f42777f8.js","59":"path---2015-07-06-backbone-and-es-6-classes-revisited-634d3bdb17b8790cdcef.js","60":"path---2015-06-15-book-review-talking-with-tech-leads-1346643aa4bfb8af0602.js","61":"path---2015-06-14-mozilla-the-state-of-web-components-8417abda8ef3a932a54f.js","62":"path---2015-06-10-is-safari-being-left-behind-f14f99f61f488c2e52c3.js","63":"path---2015-06-08-how-jquery-works-an-introduction-f712bfe5494f682ec700.js","64":"path---2015-05-28-moving-past-requirejs-7deb3a6c307a744abc3e.js","65":"path---2015-05-25-marionette-service-service-objects-for-marionette-79c76b0af70af7698a77.js","66":"path---2015-04-07-es-6-classes-and-backbone-js-91342021734b9cd856a8.js","67":"path---2015-03-23-staying-dry-with-marionette-behaviors-d8d83a2fbb8af3737d93.js","68":"path---2015-02-22-rauchg-on-es-6-ace2cd35c857ae0a6bcf.js","69":"path---2015-01-26-backbone-radio-42bff190d20985130adf.js","70":"path---2015-01-22-is-bower-useful-1a093e9866c795782a9c.js","71":"path---2015-01-05-marionette-view-life-cycles-8cff955236bb35aff5ba.js","72":"path---2014-12-22-building-complex-layouts-with-marionette-js-d2999040c347196bee36.js","73":"path---2014-12-18-come-build-with-me-6f6b19400caee536f35c.js","74":"path---2014-12-10-marionette-explained-connecting-your-data-to-your-views-5815d9327575174fc6c5.js","75":"path---2014-12-02-the-case-for-marionette-js-dfea5ecc25269cf2344a.js","76":"path---2014-11-24-alternative-javascript-7567a5670c8052f19c67.js","77":"path---2014-11-12-underscore-vs-lodash-0312a9307fd392cf2625.js","78":"path---2014-11-10-vim-workflows-file-switching-strategies-07a0ed627cc668d9da87.js","79":"path---2014-11-08-all-about-angular-2-0-95bcc441289e1b01a12c.js","80":"path---2014-11-04-a-quick-review-of-google-inbox-45044ebd0081c41dae7f.js","81":"path---2014-10-13-setting-up-your-text-editor-for-javascript-development-3f431ee025bad1229a4b.js","82":"path---2014-08-28-custom-elements-by-example-bcdf57673735c2897a1e.js","83":"path---2014-08-19-the-debugging-toolbox-b9c4c38eb751930a626f.js","84":"path---2014-08-07-component-based-development-09a0e28f23321d6b09c4.js","85":"path---2014-08-04-learning-vim-in-2014-search-0abc5d6a39ea5a6f2c23.js","86":"path---2014-07-27-learning-vim-in-2014-copy-and-paste-the-vim-way-c918d6ef96da816d509a.js","87":"path---2014-07-24-one-day-left-in-practical-vim-giveaway-dac716d6851e25d35cee.js","88":"path---2014-07-21-learning-vim-in-2014-getting-more-from-vim-with-plugins-e6482f0b27bfb0111af7.js","89":"path---2014-07-16-learning-vim-in-2014-vim-as-art-132ed8a392ec9edad089.js","90":"path---2014-07-14-learning-vim-in-2014-configuring-vim-72279a8e2b2aaecd6f4e.js","91":"path---2014-07-11-new-twitter-feed-and-practical-vim-giveaway-8183c19875505a5f7890.js","92":"path---2014-07-09-understanding-the-backbone-mindset-a-review-of-building-backbone-plugins-by-derick-bailey-a4cb0e67cb4d2fa38cbe.js","93":"path---2014-07-07-learning-vim-in-2014-working-with-files-782a37ee935a364fbc55.js","94":"path---2014-07-02-learning-vim-in-2014-vim-as-language-b4284d02f6491068b5b9.js","95":"path---2014-06-30-learning-vim-in-2014-the-basics-7ed598a8ed90b5728c3d.js","96":"path---2014-06-02-discovering-vim-f5a591f54900cba64962.js","97":"path---2014-01-06-digging-into-knockout-builds-c19c1f30f0b529241ec1.js","98":"path---2013-12-30-meetings-and-concurrency-b28ea3d86347da44b927.js","99":"path---2013-11-25-a-look-at-ack-b6b9ce8862987c51c282.js","100":"path---2013-11-14-modern-dojo-exploring-dojo-basedeclare-fece8ddfc3f9b87845fe.js","101":"path---2013-11-13-modern-dojo-exploring-dojoquery-4314df98750e46f837bb.js","102":"path---2013-09-10-blendconf-2013-takeaways-from-a-very-human-tech-conference-33e9948a8beba8a1336a.js","103":"path---2013-08-16-searching-for-the-perfect-reading-device-my-nexus-7-2013-review-b4fbdcac8dae36113a45.js","104":"path---2013-08-15-somewhat-open-d76ddd348b9b814edcec.js","105":"path---2013-08-12-book-review-user-centered-design-8f3d826155d6392bb0dc.js","106":"path---2013-06-29-rss-roundup-d25364884e3848fbe9df.js","107":"path---2013-06-11-how-i-use-stack-overflow-58f329661a7ae62da8fb.js","108":"path---2013-06-11-evergreen-browsers-de1477d24f74704233da.js","109":"path---2013-06-09-90-done-halfway-there-d99300ce5fe3af702f63.js","110":"path---2013-06-08-customer-culture-revisited-ba86ae4f4219e632d2db.js","111":"path---2013-05-07-revertible-observables-in-knockout-6616d1189a1c3da800cf.js","112":"path---2013-05-04-irreplaceable-73c900410953d257bdca.js","113":"path---2013-04-23-book-review-javascript-testing-with-jasmine-625d2771a6ba6706a98e.js","114":"path---2013-04-06-a-new-look-f7589e680b64f07c58e1.js","115":"path---2013-03-23-creating-a-build-system-for-a-coffeescript-project-with-ant-baec590327bda694a9ff.js","116":"path---2013-02-23-coffeescript-is-great-6f5cb208c784883e4479.js","117":"path---2013-02-13-simple-publish-subscribe-with-jquery-14ce12b4c4a73980db51.js","118":"path---2013-02-03-how-i-work-refactoring-cef4deabb3ae74bf4bb9.js","119":"path---2013-01-25-career-fairs-how-to-not-get-hired-and-how-to-give-yourself-a-chance-158e6ff16d95587b9999.js","120":"path---2013-01-15-unexpected-javascript-that-doesnt-do-what-you-think-8702b0d95375a3e95b21.js","121":"path---2013-01-12-explaining-javascript-object-oriented-programming-51b61f53a6d5b7de9527.js","122":"path---2013-01-08-explaining-javascript-closures-a1c418218266a52fd908.js","123":"path---2013-01-06-book-review-effective-javascript-1cfdf43d0db246bf025d.js","124":"path---2013-01-03-sublime-text-for-javascript-plugins-304efb27bbea9ec2cd23.js","125":"path---2013-01-01-sublime-text-for-javascript-configuration-0940c6cf9718b81e7cac.js","126":"path---2012-12-30-sublime-text-for-javascript-keyboard-shortcuts-e0a18d2bc9987036341f.js","127":"path---2012-12-29-i-hate-computing-ecosystems-c3ec3c5601592d7f6b22.js","128":"path---2012-12-29-cleaning-my-digital-house-d5ef4fd8f0bd820e3c8c.js","129":"path---2012-12-25-medium-the-end-of-history-and-the-last-website-22b408d60be273e145ac.js","130":"path---2012-12-20-awesome-software-trello-fea0d4059c45c1909b90.js","131":"path---2012-11-09-bayesian-witch-hunt-44f948c2736c3a320545.js","132":"path---2012-11-08-shutdown-tiles-for-windows-8-start-screen-180870cfc57ff46650ed.js","133":"path---2012-11-07-sync-multiple-google-calendars-in-windows-8-a1b75ee3590d8b6aa2fc.js","134":"path---2012-10-06-it-took-a-month-to-get-sick-of-php-7d629a70cbf4e317274a.js","135":"path---2012-09-19-the-iphone-5-conversation-so-far-865c857ba544c680cccb.js","136":"page-component---node-modules-gatsby-plugin-offline-app-shell-js-4f0dddda43ae15168f16.js","137":"app-544248e365e246e0d6cc.js"}
            //]]>
            </script><script>
  !function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",[
  "/commons-ab1577e11f4e28e88933.js","/app-544248e365e246e0d6cc.js","/layout-component---index-3087ff2ee65c4694426d.js","/path---2017-02-26-running-jest-tests-before-each-git-commit-af36998e5de4bccda260.js","/page-component---src-templates-blog-post-js-c75e7fa0f2d5fd914fab.js"
])
  </script></head><body class="landing-page" style="background:#FCFCFC;padding:0 10px;"><div id="___gatsby"><div style="max-width:40.3rem;margin-left:auto;margin-right:auto;padding:2.325rem 1.1625rem;" data-reactroot="" data-reactid="1" data-react-checksum="-354374171"><div style="display:flex;padding-bottom:0.5rem;margin-bottom:0.5rem;" data-reactid="2"><div style="flex-grow:3;display:flex;flex-direction:column;justify-content:space-around;" data-reactid="3"><h3 style="margin:0;padding-bottom:0;" data-reactid="4"><a style="box-shadow:none;text-decoration:none;color:inherit;" name="title" href="/" data-reactid="5">benmccormick.org</a></h3><div style="color:rgba(100,100,100, 0.7);" data-reactid="6"><a class="header-link" href="/subscribe/" data-reactid="7">Subscribe</a><span style="padding:0 0.33rem;" data-reactid="8">•</span><a class="header-link" href="/archive/" data-reactid="9">Archive</a><span style="padding:0 0.33rem;" data-reactid="10">•</span><a class="header-link" href="http://twitter.com/ben336" data-reactid="11">Twitter</a><span style="padding:0 0.33rem;" data-reactid="12">•</span><a class="header-link" href="/about/" data-reactid="13">About</a></div></div><div style="flex-shrink:2;" data-reactid="14"><span data-reactid="15"></span></div></div><div class="markdown" data-reactid="16"><!-- react-empty: 17 --><h5 style="display:block;color:rgba(100,100,100, 0.7);margin-bottom:0.3875rem;" data-reactid="18">February 26, 2017</h5><h1 style="margin-top:0;margin-bottom:1rem;" data-reactid="19">Running Jest Tests Before Each Git Commit</h1><div class="article-body" data-reactid="20"><p>My main work project makes heavy use of <a href="https://facebook.github.io/jest/">Jest</a> to test our JavaScript code.  For a while now I’ve wanted to set up a way to run tests every time I run a commit.  I knew that git provides <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">hooks</a> that allow scripting actions to occur before or after any commit or push, and in fact we were already using a <code>pre-commit</code> hook script to lint our code with <a href="http://eslint.org/">ESLint</a>.  But it was non-obvious how to make that work well with Jest testing.  I eventually figured out a setup that worked, and the found a better way to do both the Jest and ESLint testing.  Since it took me a while to work through, I thought I’d share it here and save the rest of you some time.</p>
<h3>What didn’t work</h3>
<p>A naive approach to this problem would be to set up a pre-commit hook that simply ran <code>jest</code> to run all tests. The problem is that running our full test suite currently takes between 10 and 20 seconds to run all tests and that time is increasing as we grow our test suite.  Adding that overhead to every commit would cost my team a lot of time, and would be especially inefficient since the repo contains plenty non-JavaScript code that doesn’t require tests to be run when updated.</p>
<p>For our ESLint hook, we queried git to get a list of staged files, and then ran eslint against each one of them individually, displaying a pass/fail message.  That looked something like this:</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code>STAGED_FILES<span class="token operator">=</span><span class="token punctuation">$(</span>git <span class="token function">diff</span> --cached --name-only --diff-filter<span class="token operator">=</span>ACM <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"js$"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$STAGED_FILES</span>"</span> <span class="token operator">=</span> <span class="token string">""</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token keyword">exit</span> 0
<span class="token keyword">fi</span>

PASS<span class="token operator">=</span>true

<span class="token keyword">for</span> FILE <span class="token keyword">in</span> <span class="token variable">$STAGED_FILES</span>
<span class="token keyword">do</span>
    eslint --quiet <span class="token string">"<span class="token variable">$FILE</span>"</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$?</span>"</span> <span class="token operator">==</span> 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">"\t\033[32mESLint Passed: <span class="token variable">$FILE</span>\033[0m"</span>
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">"\t\033[41mESLint Failed: <span class="token variable">$FILE</span>\033[0m"</span>
        PASS<span class="token operator">=</span>false
    <span class="token keyword">fi</span>
<span class="token keyword">done</span>
</code></pre>
      </div>
<p>This works great for ESLint, but doesn’t work out of the box for Jest, because I don’t want Jest to run the files that changed, I want them to run any tests that changed AND any tests that might have been broken because of that.</p>
<p>Jest has a wonderful command line flag <code>jest --onlyChanged</code>/<code>jest -o</code> that runs only the tests related to files that have been changed according to git.  It is extremely helpful since it is smart enough to read the dependency structure for the project and run all tests that might be changed from updating a source file. It also has a <code>--lastCommit</code> option that does the same thing for files that were in the previous commit.  Unfortunately, these options aren’t helpful at the point of committing, since <code>onlyChanged</code> does not look at files that have been staged for commit, and we haven’t actually made a commit yet for <code>lastCommit</code> to read.</p>
<h3>What Did Work</h3>
<p>Fortunately Jest has a lower level command that uses the same logic as <code>onlyChanged</code> and <code>lastCommit</code>.  <code>--findRelatedTests</code> is a flag that tells Jest to run any tests related to the files passed to it instead of trying to run those files as tests as it would normally do.</p>

          <a
            class="gatsby-resp-image-link"
            href="/static/9350cbcea06e8f1f423335d94d84ac98-a6c06.png"
            style="display: block"
            target="_blank"
            rel="noopener"
          >
            <span
              class="gatsby-resp-image-wrapper"
              style="position: relative; z-index: -1; display: block; "
            >
              <span
                class="gatsby-resp-image-background-image"
                style="padding-bottom: 81.97573656845753%;position: relative; width: 100%; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAAB4klEQVQ4y6WTTW/TQBCG88u4ceOAxC/gzJ0T/4YDQohDVSGoQEhUqErTElzZ8ffaa69jJ3ZsJ7aTNi3wMrtBQNUDbjmMxh5p3p2PZwZl4cGLOXwyJrj6FunOVzlDW3r4vhH4cd7PBgefnmDvw2PUiwDFzAXzNUShjjQxkQqDRO3bCb588wDP9+6hrXyUcwvmZAjHPobnnoB5pwjZGKuFi8uW9xN8/e4RXuzfR0OtpUKHpn2GYRxB149g2yP47qkSLmYWVRr/W/DV24eqwo4qXBYOePAVSXQG1znBLDFU/HwV9G9ZRAeYJu9V0mXHcdGE2CwZutpXC1nXrHe7SpDTjGQlde4oEVmhnF+emajmNrJkoh7qLWhbx2rwMlkm7jbr9Ba4IShntG13rUovW9/eosUbglUZYDrnyrI8QjLjyIudb0pGfNJSOoGLtVB+S/5qI37HpG3Xf+KDw+Ez7H98iiwLIIQHxzPA2ARhaCHiBtLMRbGcomoSVKupsrZNsKT/BcVr8jXFFr/i1zjM0wnG40O4xJ/kMOaaiimwey7mGodFasIyh8TgiK5lRGf4BYKfIQ41dUW9wP6bQ2mNYs9XD0ge5UnKhX1bx3fgkJIDqkpyOKdWy//l8KqLMI11BfVdsfkJ8S6g9C3bagEAAAAASUVORK5CYII='); background-size: cover; display: block;"
              >
                <img
                  class="gatsby-resp-image-image"
                  style="width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
                  alt="an example of findRelatedTests running against the redux repo"
                  title=""
                  src="/static/9350cbcea06e8f1f423335d94d84ac98-96365.png"
                  srcset="/static/9350cbcea06e8f1f423335d94d84ac98-c0cbb.png 143w,
/static/9350cbcea06e8f1f423335d94d84ac98-0e313.png 285w,
/static/9350cbcea06e8f1f423335d94d84ac98-96365.png 570w,
/static/9350cbcea06e8f1f423335d94d84ac98-a6c06.png 577w"
                  sizes="(max-width: 570px) 100vw, 570px"
                />
              </span>
            </span>
          </a>
          
<p>This is a perfect fit for a pre-commit hook.  I was able to integrate it into my existing script like this:</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code>jest --bail --findRelatedTests <span class="token variable">$STAGED_FILES</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$?</span>"</span> <span class="token operator">==</span> 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token keyword">echo</span> <span class="token string">"\t\033[32mJest Tests Passed\033[0m"</span>
<span class="token keyword">else</span>
    <span class="token keyword">echo</span> <span class="token string">"\t\033[41mJest Tests Failed\033[0m"</span>
    PASS<span class="token operator">=</span>false
<span class="token keyword">fi</span>
</code></pre>
      </div>
<p><code>$STAGED_FILES</code> is re-used from the eslint portion of the script, and is just a space delimited list of files that are being committed.  The <code>--bail</code> option simply stops running tests as soon as one has failed.  Including that is optional, you won’t see all the tests that have failed, but the failure will happen faster and you’ll be able to decide how to proceed, including possibly running the full test script on your own.   </p>
<p>Those lines (along with some sanity checks for the existence of Jest and error handling when PASS is set to false) are enough to get a workable commit hook going, but they’re not ideal.  pre-commit hooks aren’t persisted by git, so each user has to install the hook script individually, and any updates aren’t shared automatically.  Plus I’m inefficiently passing all staged files to eslint and Jest regardless of whether they’re JavaScript that those tools are actually meant to work on.  My ESLint code was also written before ESLint developed robust <code>--fix</code> capabilities, and doesn’t try to fix the errors it is capable of fixing.  Finally, while this is just poor coding and not an inherent limitation of my other method, I’m using globally installed versions of Jest and ESLint instead of scoping them to my project.</p>
<h3>Making it better</h3>
<p>Fortunately I’d discovered a better solution the other day while working on something else.  There is an npm package for making this process easier, <a href="https://github.com/okonet/lint-staged">lint-staged</a>.  Lint staged abstracts away the boilerplate of getting the staged files, and makes it easy to run local node executables against specific sets of files.  I was able to replace my whole pre-commit script and address all of the problems mentioned above with only a few lines in my package.json:</p>
<div class="gatsby-highlight">
      <pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"lint-staged"</span><span class="token operator">:</span> <span class="token string">"lint-staged"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"lint-staged"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"*.js"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"eslint --fix"</span><span class="token punctuation">,</span>
      <span class="token string">"git add"</span><span class="token punctuation">,</span>
      <span class="token string">"jest --bail --findRelatedTests"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"eslint"</span><span class="token operator">:</span> <span class="token string">"3.16.1"</span><span class="token punctuation">,</span>
    <span class="token property">"jest"</span><span class="token operator">:</span> <span class="token string">"19.0.1"</span><span class="token punctuation">,</span>
    <span class="token property">"lint-staged"</span><span class="token operator">:</span> <span class="token string">"3.3.1"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p><code>lint-staged</code> now handles making sure that I’m only running checks against JavaScript files, lets eslint autofix and stage any files that it can fix, and uses the local versions of jest and eslint.  It also adds a nice pretty interface for the results:</p>

          <a
            class="gatsby-resp-image-link"
            href="/static/07049d14abcd3c0065c9779b76d22045-0957d.png"
            style="display: block"
            target="_blank"
            rel="noopener"
          >
            <span
              class="gatsby-resp-image-wrapper"
              style="position: relative; z-index: -1; display: block; "
            >
              <span
                class="gatsby-resp-image-background-image"
                style="padding-bottom: 35.321100917431195%;position: relative; width: 100%; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAA3UlEQVQoz42R2RKCMAxF+///5oyOGyqLqIxABQqUze2aBngUfTiTNJO29yYilTYi6aJQHmrlQqc2iuSAKnOQxRbnfFYO19ryiHdz/oqolI2SLmhqfmgfj8rHqz4xz2pgOI9MPtilB1wvK1KzQ1d6uOtpBb8QbbxBfttDDdzCLVOSdWOzzl0ahYOGonExWv+mVPz78/jAL9siITWF3CMPlqxMXnvSyIIMLcSUG1VFQj0061zuoIi+1i9MZza7NFG0co0mmKMLFqjDJXS0hvJnHI01tkyY2Xa04TsxpfADQvERZDfQoGMAAAAASUVORK5CYII='); background-size: cover; display: block;"
              >
                <img
                  class="gatsby-resp-image-image"
                  style="width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
                  alt="pretty lint-staged output"
                  title=""
                  src="/static/07049d14abcd3c0065c9779b76d22045-96365.png"
                  srcset="/static/07049d14abcd3c0065c9779b76d22045-c0cbb.png 143w,
/static/07049d14abcd3c0065c9779b76d22045-0e313.png 285w,
/static/07049d14abcd3c0065c9779b76d22045-96365.png 570w,
/static/07049d14abcd3c0065c9779b76d22045-58e89.png 855w,
/static/07049d14abcd3c0065c9779b76d22045-0957d.png 872w"
                  sizes="(max-width: 570px) 100vw, 570px"
                />
              </span>
            </span>
          </a>
          
<p><code>lint-staged</code> docs recommend using an npm based hooks manager like <a href="https://github.com/observing/pre-commit">pre-commit</a> for running the scripts, but due to some quirks in my setup (node_modules is symlinked, and I sometimes want to run these commands inside a docker container), I found it easier to maintain a custom pre-commit script and just replace the previous logic with <code>npm run lint-staged</code>.  Either way, all of the actual logic is now checked into the repository and shared between all users.  The only manual step is adding the call to a pre-commit hook or (if you’re using a helper lib) running npm install.</p>
<h3>More Resources</h3>
<ul>
<li>This maybe merits a future post on its own, but if you’re interested in automating away your code style maintenance look at combining <a href="https://github.com/prettier/prettier">prettier</a> (and possibly  <a href="https://github.com/not-an-aardvark/eslint-plugin-prettier">eslint-plugin-prettier</a>) with the pre-commit hooks from above.  Prettier will guarantee that your code follows a consistent style, and because it handles maximum line lengths, is much more robust than ESLint on its own.  Using its ESLint plugin within my editor and on pre-commit hooks has pretty much eliminated me manually fixing code style problems.</li>
</ul></div><div data-reactid="21"><hr data-reactid="22"/><div class="subscribe-container" data-reactid="23"><div class="subscribe-block" data-reactid="24"><p data-reactid="25"><!-- react-text: 26 -->Thanks for taking the time to read this post!<!-- /react-text --><!-- react-text: 27 --> Software tooling<!-- /react-text --><!-- react-text: 28 --> is one of the main topics of this blog, so if you enjoyed the post, please consider subscribing by using the feed, Twitter or my mailing list.<!-- /react-text --></p><div style="margin-bottom:3.875rem;" data-reactid="29"><div id="mc_embed_signup" data-reactid="30"><h6 style="margin:0;font-size:0.8165rem;line-height:1.55rem;letter-spacing:-0.25px;" data-reactid="31">EMAIL</h6><form action="//benmccormick.us8.list-manage.com/subscribe/post?u=115446b80fd9d930ba091cc27&amp;id=f5b9f5acf2" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="" data-reactid="32"><div id="mc_embed_signup_scroll" data-reactid="33"><div class="mc-field-group" style="padding-right:30px;" data-reactid="34"><input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address" data-reactid="35"/><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button" data-reactid="36"/></div><div id="mce-responses" class="clear" data-reactid="37"><div class="response" id="mce-error-response" style="display:none;" data-reactid="38"></div><div class="response" id="mce-success-response" style="display:none;" data-reactid="39"></div></div><div style="position:absolute;left:-5000px;" aria-hidden="true" data-reactid="40"><input type="text" name="b_115446b80fd9d930ba091cc27_f5b9f5acf2" tabindex="-1" value="" data-reactid="41"/></div><div class="clear" data-reactid="42"></div></div></form></div><div class="rss" data-reactid="43"><h6 style="margin:0;font-size:0.8165rem;line-height:1.55rem;letter-spacing:-0.25px;" data-reactid="44">RSS</h6><a href="/rss/" data-reactid="45"><i class="rss-icon" data-reactid="46"><svg viewBox="0 0 10 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>rss</title><desc>Created with Sketch.</desc><defs></defs><g id="Octicons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="rss" fill="#000000"><path d="M2,13 L0,13 L0,11 C1.11,11 2,11.89 2,13 L2,13 Z M0,3 L0,4 C4.97,4 9,8.03 9,13 L10,13 C10,7.48 5.52,3 0,3 L0,3 Z M0,7 L0,8 C2.75,8 5,10.25 5,13 L6,13 C6,9.69 3.31,7 0,7 L0,7 Z" id="Shape"></path></g></g></svg></i><!-- react-text: 47 --> <!-- /react-text --><span data-reactid="48">RSS</span></a></div><div data-reactid="49"><h6 style="margin:0;font-size:0.8165rem;line-height:1.55rem;letter-spacing:-0.25px;" data-reactid="50">TWITTER</h6><div class="twitter-item" data-reactid="51"><span data-reactid="52">Site Feed: </span><a href="https://twitter.com/benmccormickorg" class="twitter-follow-button" data-show-count="false" data-reactid="53">Follow @benmccormickorg</a></div></div><div data-reactid="54"><div class="twitter-item" data-reactid="55"><span data-reactid="56">Personal Feed: </span><a href="https://twitter.com/ben336" class="twitter-follow-button" data-show-count="false" data-reactid="57">Follow @ben336</a></div></div></div></div><div class="up-next-block" data-reactid="58"><h6 style="margin:0;font-size:0.8165rem;line-height:1.55rem;letter-spacing:-0.25px;" data-reactid="59">You Might Also Like:</h6><div data-reactid="60"><h3 style="margin-top:0;margin-bottom:0.3875rem;" data-reactid="61"><a href="/[object Object]" data-reactid="62">MobX: First Impressions</a></h3><p data-reactid="63">First impression of managing data with MobX</p></div><div data-reactid="64"><hr data-reactid="65"/><h3 style="margin-top:0;margin-bottom:0.3875rem;" data-reactid="66"><a href="/[object Object]" data-reactid="67">Saving Time With Jest: Meetup Summary</a></h3><p data-reactid="68">A summary of my meetup talk on saving time with Jest</p></div><div data-reactid="69"><hr data-reactid="70"/><h3 style="margin-top:0;margin-bottom:0.3875rem;" data-reactid="71"><a href="/[object Object]" data-reactid="72">Testing with Jest Snapshots: First Impressions</a></h3><p data-reactid="73">First impression of testing UI components using Jest snapshots</p></div></div></div></div><hr style="margin-bottom:3.1rem;" data-reactid="74"/><div title="Running Jest Tests Before Each Git Commit" data-reactid="75"><div id="disqus_thread" data-reactid="76"></div><noscript data-reactid="77"><span data-reactid="78"><!-- react-text: 79 -->Please enable JavaScript to view the<!-- /react-text --><a href="http://disqus.com/?ref_noscript" data-reactid="80">comments powered by Disqus.</a></span></noscript><a href="http://disqus.com" class="dsq-brlink" data-reactid="81"><!-- react-text: 82 -->Blog comments powered by <!-- /react-text --><span class="logo-disqus" data-reactid="83">Disqus</span><!-- react-text: 84 -->.<!-- /react-text --></a></div></div><span style="display:block;clear:both;" data-reactid="85"> </span></div></div><script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-37323973-1', 'auto');
            ga('send', 'pageview');
        </script><script>
          window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
      </script></body></html>