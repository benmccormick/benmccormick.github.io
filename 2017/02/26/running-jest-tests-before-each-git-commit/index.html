<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=yyxgnp97qG"/><link rel="icon" type="image/png" href="/favicon-32x32.png?v=yyxgnp97qG" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png?v=yyxgnp97qG" sizes="16x16"/><link rel="manifest" href="/manifest.json"/><link rel="mask-icon" href="/safari-pinned-tab.svg?v=yyxgnp97qG" color="##0193e8"/><link rel="alternate" title="JSON Feed" type="application/json" href="/feed.json"/><link rel="shortcut icon" href="/favicon.ico?v=yyxgnp97qG"/><meta name="theme-color" content="#ffffff"/><title data-react-helmet="true"></title><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.4 'Work Sans','Helvetica Neue','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'Work Sans','Helvetica Neue','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:'Inter','Helvetica Neue','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:bold;text-rendering:optimizeLegibility;font-size:1.6rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:'Inter','Helvetica Neue','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:bold;text-rendering:optimizeLegibility;font-size:1.32578rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:'Inter','Helvetica Neue','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:bold;text-rendering:optimizeLegibility;font-size:1.20684rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:'Inter','Helvetica Neue','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:bold;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:'Inter','Helvetica Neue','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:bold;text-rendering:optimizeLegibility;font-size:0.91028rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:'Inter','Helvetica Neue','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:bold;text-rendering:optimizeLegibility;font-size:0.86849rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}ul{margin-left:1.4rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.4rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;font-size:0.85rem;line-height:1.1;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.05rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;font-size:1rem;line-height:1.4rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}blockquote{margin-left:1.4rem;margin-right:1.4rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.05rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}b{font-weight:bold;}strong{font-weight:bold;}dt{font-weight:bold;}th{font-weight:bold;}li{margin-bottom:calc(1.05rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.4rem;margin-bottom:calc(1.05rem / 2);margin-top:calc(1.05rem / 2);}li > ul{margin-left:1.4rem;margin-bottom:calc(1.05rem / 2);margin-top:calc(1.05rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.05rem / 2);}code{font-size:0.85rem;line-height:1.4rem;}kbd{font-size:0.85rem;line-height:1.4rem;}samp{font-size:0.85rem;line-height:1.4rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:0.93333rem;padding-right:0.93333rem;padding-top:0.7rem;padding-bottom:calc(0.7rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}tt,code{background-color:hsla(0,0%,0%,0.04);border-radius:3px;font-family:"SFMono-Regular", Consolas,"Roboto Mono","Droid Sans Mono","Liberation Mono",Menlo,Courier,monospace;padding:0;padding-top:0.2em;padding-bottom:0.2em;font-size:12px;}pre code{background:none;line-height:1.1;}code:before,code:after,tt:before,tt:after{letter-spacing:-0.2em;content:" ";}pre code:before,pre code:after,pre tt:before,pre tt:after{content:"";}h1,h2,h3,h4,h5,h6{line-height:1.2;}@media only screen and (max-width:480px){html{font-size:112.5%;}}</style><style data-href="/styles.4ed8b69a7409346ab9ca.css" id="gatsby-global-css">.markdown pre{display:block;background:#343d46;color:#d8dee9;padding:.8rem}.markdown pre code:after{content:unset}.token.comment,.token.quote{color:#a7adba}.token.addition,.token.attr,.token.selector-tag,.token.string{color:#99c794}.token.doctag,.token.meta .token.meta-string,.token.regexp{color:#89ddf3}.token.built_in,.token.function{color:#5fb3b3}.token.name,.token.section,.token.selector-class,.token.selector-id,.token.title{color:#69c}.token.attribute,.token.class .token.title,.token.template-variable,.token.type,.token.variable{color:#fac863}.token.bullet,.token.link,.token.meta,.token.meta .token.keyword,.token.selector-attr,.token.selector-pseudo,.token.subst,.token.symbol{color:#f9ae58}.token.boolean,.token.deletion,.token.literal,.token.number{color:#f07178}.token.keyword{color:#c594c5}.token.formula{background:#a7adba}.token.emphasis{font-style:italic}.token.strong{font-weight:700}.gatsby-resp-image-wrapper{max-width:75%;display:block;margin:40px auto 20px}.bordered-img{border:3px solid ##0193e8}.img-group{display:flex;justify-content:space-between}.img-group img{padding:0;height:auto}.inline-img{width:45%;display:inline-block;float:right;padding:2rem}#bd-label{font-family:Inter,Helvetica Neue,Arial,sans-serif;font-weight:700}#bd-label.large-label{font-size:20px}#bd-email{padding-left:5px}#bd-email,#bd-submit{font-family:Inter,Helvetica Neue,Arial,sans-serif;font-size:14px}#bd-submit{background:#f1684e;color:#fff;border-radius:4px;border:none}@media (max-width:960px){#bd-email,#bd-submit{font-size:10px}#bd-label{font-size:12px}}.large-row #bd-email,.large-row #bd-submit{font-size:20px}@media (max-width:700px){.large-row #bd-email,.large-row #bd-submit{font-size:18px}}.bd-subscribe-form{margin:30px 0 50px;display:block}.bd-subscribe-row{display:grid;grid-template-columns:60% 35%;grid-column-gap:5%;grid-template-rows:1fr;margin-top:10px}@media (max-width:960px){.bd-subscribe-row{grid-template-columns:1fr;grid-row-gap:10%;grid-template-rows:1fr 1fr}}.twitter-tweet,twitterwidget{margin-left:auto;margin-right:auto}.carbon-wrap{display:grid;grid-template-columns:1fr 1fr;grid-column-gap:10px;grid-template-rows:1fr;margin-bottom:30px;align-items:center;padding-left:5px}@media (max-width:960px){.carbon-wrap{grid-template-columns:1fr;grid-template-rows:110px 1fr;grid-row-gap:10px;justify-items:center}}.carbon-wrap img{margin-bottom:0}.carbon-text{padding:5px 5px 5px 0;display:inline-block;overflow:hidden;line-height:1.3}.carbon-poweredby{color:#777;position:absolute;right:5px;bottom:0}.columns{display:grid;grid-template-columns:665px 270px;grid-template-rows:1fr;grid-column-gap:25px}@media (max-width:960px){.columns{display:grid;grid-template-columns:70% 28%;grid-column-gap:2%}}@media (max-width:700px){.columns{display:flex;flex-direction:column;align-items:center}.no-mobile{display:none}}@media (max-width:321px){html{font-size:100%!important}}body{color:#474747}a{color:#f1684e;text-decoration:none;cursor:pointer}a:hover{text-decoration:underline}.footnote-backref,.footnote-ref{text-decoration:none;padding-left:3px}blockquote{border-left:5px solid #0193e8;background:#eee;font-weight:400;font-size:.9rem;padding:1.5rem 2rem;margin:0 0 1rem}blockquote p{margin-bottom:.667em}h3{color:#0193e8}h4{font-size:110%}.explanation{padding:10px;background:#eee;border-radius:10px;margin:20px auto;font-size:.85em}.footnotes{font-size:80%}.footnotes li>*{display:inline;margin-bottom:0}strong{color:#222}em{color:#666}.markdown iframe{margin:0 auto}</style><meta name="generator" content="Gatsby 2.32.13"/><style id="glamor-styles">.css-1yerfx4,[data-css-1yerfx4]{color:#777777;font-size:16px;font-family:"Inter", "Helvetica Neue", "Helvetica", Arial, sans-serif;}.css-1yerfx4:hover,[data-css-1yerfx4]:hover{color:#F1684E;}.css-pe78rs,[data-css-pe78rs]{font-size:16px;font-family:"Inter", "Helvetica Neue", "Helvetica", Arial, sans-serif;}</style><script id="glamor-ids">
        // <![CDATA[
        window._glamor = ["1yerfx4","pe78rs"]
        // ]]>
        </script><title data-react-helmet="true">Running Jest Tests Before Each Git Commit | benmccormick.org</title><meta data-react-helmet="true" name="description" content="Ben McCormick&#x27;s blog on JavaScript and Web Development"/><meta data-react-helmet="true" name="keywords" content="Jest testing git pre-commit JavaScript"/><script data-react-helmet="true" type="application/ld+json">{
                  "@context": "http://schema.org"
                  "@type": "BlogPosting",
                  "headline": "Running Jest Tests Before Each Git Commit",
                  "genre": "Software Development",
                  "keywords": "Jest testing git pre-commit JavaScript",
                  "url": "http://benmccormick.org//2017/02/26/running-jest-tests-before-each-git-commit/",
                  "image": "http://benmccormick.org/logo.png",
                  "datePublished": "2017-02-26",
                  
                  "articleBody": "<p>My main work project makes heavy use of <a href=\"https://facebook.github.io/jest/\">Jest</a> to test our JavaScript code.  For a while now I’ve wanted to set up a way to run tests every time I run a commit.  I knew that git provides <a href=\"https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks\">hooks</a> that allow scripting actions to occur before or after any commit or push, and in fact we were already using a <code class=\"language-text\">pre-commit</code> hook script to lint our code with <a href=\"http://eslint.org/\">ESLint</a>.  But it was non-obvious how to make that work well with Jest testing.  I eventually figured out a setup that worked, and the found a better way to do both the Jest and ESLint testing.  Since it took me a while to work through, I thought I’d share it here and save the rest of you some time.</p>
<h3>What didn’t work</h3>
<p>A naive approach to this problem would be to set up a pre-commit hook that simply ran <code class=\"language-text\">jest</code> to run all tests. The problem is that running our full test suite currently takes between 10 and 20 seconds to run all tests and that time is increasing as we grow our test suite.  Adding that overhead to every commit would cost my team a lot of time, and would be especially inefficient since the repo contains plenty non-JavaScript code that doesn’t require tests to be run when updated.</p>
<p>For our ESLint hook, we queried git to get a list of staged files, and then ran eslint against each one of them individually, displaying a pass/fail message.  That looked something like this:</p>
<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">STAGED_FILES</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">git</span> <span class=\"token function\">diff</span> --cached --name-only --diff-filter<span class=\"token operator\">=</span>ACM <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"js$\"</span><span class=\"token variable\">)</span></span>
<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$STAGED_FILES</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>
    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span>
<span class=\"token keyword\">fi</span>

<span class=\"token assign-left variable\">PASS</span><span class=\"token operator\">=</span>true

<span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">FILE</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$STAGED_FILES</span>
<span class=\"token keyword\">do</span>
    eslint --quiet <span class=\"token string\">\"<span class=\"token variable\">$FILE</span>\"</span>

    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$?</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>
        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\t\">\t</span><span class=\"token entity\" title=\"\033\">\033</span>[32mESLint Passed: <span class=\"token variable\">$FILE</span><span class=\"token entity\" title=\"\033\">\033</span>[0m\"</span>
    <span class=\"token keyword\">else</span>
        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\t\">\t</span><span class=\"token entity\" title=\"\033\">\033</span>[41mESLint Failed: <span class=\"token variable\">$FILE</span><span class=\"token entity\" title=\"\033\">\033</span>[0m\"</span>
        <span class=\"token assign-left variable\">PASS</span><span class=\"token operator\">=</span>false
    <span class=\"token keyword\">fi</span>
<span class=\"token keyword\">done</span></code></pre></div>
<p>This works great for ESLint, but doesn’t work out of the box for Jest, because I don’t want Jest to run the files that changed, I want them to run any tests that changed AND any tests that might have been broken because of that.</p>
<p>Jest has a wonderful command line flag <code class=\"language-text\">jest --onlyChanged</code>/<code class=\"language-text\">jest -o</code> that runs only the tests related to files that have been changed according to git.  It is extremely helpful since it is smart enough to read the dependency structure for the project and run all tests that might be changed from updating a source file. It also has a <code class=\"language-text\">--lastCommit</code> option that does the same thing for files that were in the previous commit.  Unfortunately, these options aren’t helpful at the point of committing, since <code class=\"language-text\">onlyChanged</code> does not look at files that have been staged for commit, and we haven’t actually made a commit yet for <code class=\"language-text\">lastCommit</code> to read.</p>
<h3>What Did Work</h3>
<p>Fortunately Jest has a lower level command that uses the same logic as <code class=\"language-text\">onlyChanged</code> and <code class=\"language-text\">lastCommit</code>.  <code class=\"language-text\">--findRelatedTests</code> is a flag that tells Jest to run any tests related to the files passed to it instead of trying to run those files as tests as it would normally do.</p>
<a class=\"gatsby-resp-image-link\" href=\"/static/9350cbcea06e8f1f423335d94d84ac98/e8146/jest-related-tests.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">
    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block;  max-width: 570px; margin-left: auto; margin-right: auto;\">
    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 81.97573656845753%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAACYElEQVQ4y41UyW7TUBT1t7GoxA4EWzZsQCz4KYSEQKBSAWppJVQQlDYNbVzHyYsd2+95SNI4djwl6Xi4fulAUJtmcXSvh3feHc69yiA0YbochrAJDizPAfcdmOQP6dto2MbZyCUInI+n9ozs+S1Q1jafY3XzJeK+gcOgBbtdg8s1eEJHL2hIQhx5V2Tnc8gk4auP9/Dm0xLymBGhjrr2C6y5jRbbgWXu0gV/MOg1MUnt6wjnECvvvjzAh7VHSMIGhF3DduUbNG0LqvqTCKtwiNB1asgiczHC96sPsfz1MYphi0gNdLwD+EKFY+1RxHWkAwPHuQNMvMVSDtzv6He35MGjzKGaWeS3kFNESUg2NnFa8KvIpphDaJs1cEuVdSrocFmzFqtg2G9JwuiQzXb4gvA2KAbbhsf3ZTePqPAdT5PRYXJ9610kM4SjhONk5GOScYzLlFNH+ieFkKmeFlS/sVgYymFPhcGbsKWgOdyOQNAV4AFHMrAQRhyDJECUeGR9pJmHLJv6ESFOPcRkh+n0vbKy8QTL608R9hh8t4G6XiEdVsHYHoSjwnXriGMHRe5JjHMXk8JFnnlX7wryRxfflNcrS3j7+T51VkdAcqmQDpuN31LgnKTTJ+lEXR2TpC3remfKa5vPsP7jBcZ0IKIohbOPwD2gRtWkDnu+hrBLI5hYCzVICbsayaNJMmEkm5K0KQnKySiRX0zIrGzEzMT86yussQOD7dJyYFI6baMqcUlYTg/ox3JS/sdNC0MRNtWpo1PKFk2KTRtGl0TluB3nXC6F8rkU+uUF5VSVE3TTwvgL5+Ghb81Fxi8AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>
    <img class=\"gatsby-resp-image-image\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\" alt=\"an example of findRelatedTests running against the redux repo\" title=\"\" src=\"/static/9350cbcea06e8f1f423335d94d84ac98/a9e6e/jest-related-tests.png\" srcset=\"/static/9350cbcea06e8f1f423335d94d84ac98/40f08/jest-related-tests.png 143w,
/static/9350cbcea06e8f1f423335d94d84ac98/d4502/jest-related-tests.png 285w,
/static/9350cbcea06e8f1f423335d94d84ac98/a9e6e/jest-related-tests.png 570w,
/static/9350cbcea06e8f1f423335d94d84ac98/e8146/jest-related-tests.png 577w\" sizes=\"(max-width: 570px) 100vw, 570px\">
  </span>
  </a>
<p>This is a perfect fit for a pre-commit hook.  I was able to integrate it into my existing script like this:</p>
<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">jest --bail --findRelatedTests <span class=\"token variable\">$STAGED_FILES</span>
<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$?</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>
    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\t\">\t</span><span class=\"token entity\" title=\"\033\">\033</span>[32mJest Tests Passed<span class=\"token entity\" title=\"\033\">\033</span>[0m\"</span>
<span class=\"token keyword\">else</span>
    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\t\">\t</span><span class=\"token entity\" title=\"\033\">\033</span>[41mJest Tests Failed<span class=\"token entity\" title=\"\033\">\033</span>[0m\"</span>
    <span class=\"token assign-left variable\">PASS</span><span class=\"token operator\">=</span>false
<span class=\"token keyword\">fi</span></code></pre></div>
<p><code class=\"language-text\">$STAGED_FILES</code> is re-used from the eslint portion of the script, and is just a space delimited list of files that are being committed.  The <code class=\"language-text\">--bail</code> option simply stops running tests as soon as one has failed.  Including that is optional, you won’t see all the tests that have failed, but the failure will happen faster and you’ll be able to decide how to proceed, including possibly running the full test script on your own.   </p>
<p>Those lines (along with some sanity checks for the existence of Jest and error handling when PASS is set to false) are enough to get a workable commit hook going, but they’re not ideal.  pre-commit hooks aren’t persisted by git, so each user has to install the hook script individually, and any updates aren’t shared automatically.  Plus I’m inefficiently passing all staged files to eslint and Jest regardless of whether they’re JavaScript that those tools are actually meant to work on.  My ESLint code was also written before ESLint developed robust <code class=\"language-text\">--fix</code> capabilities, and doesn’t try to fix the errors it is capable of fixing.  Finally, while this is just poor coding and not an inherent limitation of my other method, I’m using globally installed versions of Jest and ESLint instead of scoping them to my project.</p>
<h3>Making it better</h3>
<p>Fortunately I’d discovered a better solution the other day while working on something else.  There is an npm package for making this process easier, <a href=\"https://github.com/okonet/lint-staged\">lint-staged</a>.  Lint staged abstracts away the boilerplate of getting the staged files, and makes it easy to run local node executables against specific sets of files.  I was able to replace my whole pre-commit script and address all of the problems mentioned above with only a few lines in my package.json:</p>
<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>
  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>
    <span class=\"token property\">\"lint-staged\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"lint-staged\"</span><span class=\"token punctuation\">,</span>
  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>
  <span class=\"token property\">\"lint-staged\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>
    <span class=\"token property\">\"*.js\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>
      <span class=\"token string\">\"eslint --fix\"</span><span class=\"token punctuation\">,</span>
      <span class=\"token string\">\"git add\"</span><span class=\"token punctuation\">,</span>
      <span class=\"token string\">\"jest --bail --findRelatedTests\"</span>
    <span class=\"token punctuation\">]</span>
  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>
  <span class=\"token property\">\"devDependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>
    <span class=\"token property\">\"eslint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.16.1\"</span><span class=\"token punctuation\">,</span>
    <span class=\"token property\">\"jest\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"19.0.1\"</span><span class=\"token punctuation\">,</span>
    <span class=\"token property\">\"lint-staged\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.3.1\"</span><span class=\"token punctuation\">,</span>
  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>
<span class=\"token punctuation\">}</span></code></pre></div>
<p><code class=\"language-text\">lint-staged</code> now handles making sure that I’m only running checks against JavaScript files, lets eslint autofix and stage any files that it can fix, and uses the local versions of jest and eslint.  It also adds a nice pretty interface for the results:</p>
<a class=\"gatsby-resp-image-link\" href=\"/static/07049d14abcd3c0065c9779b76d22045/27d9c/lint-staged-errors.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">
    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block;  max-width: 570px; margin-left: auto; margin-right: auto;\">
    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 35.321100917431195%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABCElEQVQoz3WR63KCMBCF8/6P15ZWEUXBCnJLMFwD9nQ3gU7r2B/fbNhkz5zDClkEuFxD6DrEqEO0co+mCtCpPerCt+eGetzv6wOm5oSvPsa9i2x9RHRyB5Vt7OBwc6KmOdrBgQRG2zvCMNSf2+iP4KOwGFWAJH6DzLfk6mBFWYwfYjj/InYsg3z/DGHKLRoSslEJFla5b88szvSLU6597XrP4jqHMsBMyoZccdy5de44GvemBY7LsccFvue3juhnTlTkRl83qOMX8Dn99JAlH8hTgmpy9nArd9AEL0lRAv5uFScKoJel6dLtQBjpY8w8TPk7TOWjK2hB6Sv60rdO1tiry/X//hf5G+jMEWFL2TQIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>
    <img class=\"gatsby-resp-image-image\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\" alt=\"pretty lint-staged output\" title=\"\" src=\"/static/07049d14abcd3c0065c9779b76d22045/a9e6e/lint-staged-errors.png\" srcset=\"/static/07049d14abcd3c0065c9779b76d22045/40f08/lint-staged-errors.png 143w,
/static/07049d14abcd3c0065c9779b76d22045/d4502/lint-staged-errors.png 285w,
/static/07049d14abcd3c0065c9779b76d22045/a9e6e/lint-staged-errors.png 570w,
/static/07049d14abcd3c0065c9779b76d22045/c2e96/lint-staged-errors.png 855w,
/static/07049d14abcd3c0065c9779b76d22045/27d9c/lint-staged-errors.png 872w\" sizes=\"(max-width: 570px) 100vw, 570px\">
  </span>
  </a>
<p><code class=\"language-text\">lint-staged</code> docs recommend using an npm based hooks manager like <a href=\"https://github.com/observing/pre-commit\">pre-commit</a> for running the scripts, but due to some quirks in my setup (node_modules is symlinked, and I sometimes want to run these commands inside a docker container), I found it easier to maintain a custom pre-commit script and just replace the previous logic with <code class=\"language-text\">npm run lint-staged</code>.  Either way, all of the actual logic is now checked into the repository and shared between all users.  The only manual step is adding the call to a pre-commit hook or (if you’re using a helper lib) running npm install.</p>
<h3>More Resources</h3>
<ul>
<li>This maybe merits a future post on its own, but if you’re interested in automating away your code style maintenance look at combining <a href=\"https://github.com/prettier/prettier\">prettier</a> (and possibly  <a href=\"https://github.com/not-an-aardvark/eslint-plugin-prettier\">eslint-plugin-prettier</a>) with the pre-commit hooks from above.  Prettier will guarantee that your code follows a consistent style, and because it handles maximum line lengths, is much more robust than ESLint on its own.  Using its ESLint plugin within my editor and on pre-commit hooks has pretty much eliminated me manually fixing code style problems.</li>
</ul>",
                    "author": {
                      "@type": "Person",
                      "name": "Ben McCormick"
                      "email": "mailto:ben@benmccormick.org",
                      "image": "/profile_pic.jpg",
                      "jobTitle": "Software Engineer",
                      "alumniOf": "Duke",
                      "birthPlace": "Pittsburgh, PA",
                      "gender": "male",
                      "url": "http://benmccormick.org",
                	    "sameAs" : [
                        "https://www.linkedin.com/in/benmccormick",
                        "http://twitter.com/_benmccormick",
                      ]
                   }
                }</script><link href="https://fonts.googleapis.com/css?family=Inter|Work+Sans&amp;display=swap" rel="stylesheet"/><link as="script" rel="preload" href="/webpack-runtime-bd5aca0bc92760bfef0f.js"/><link as="script" rel="preload" href="/framework-beda7bde9d7dca0755ce.js"/><link as="script" rel="preload" href="/app-7099fdfd5aecf07773ba.js"/><link as="script" rel="preload" href="/styles-e9d24b1846c7d6eb9685.js"/><link as="script" rel="preload" href="/commons-d750081a92f32f033430.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-7f435882c318538af698.js"/><link as="fetch" rel="preload" href="/page-data/2017/02/26/running-jest-tests-before-each-git-commit/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body class="landing-page" style="background:#FCFCFC"><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="hkr7jf">.css-hkr7jf{width:100%;max-width:1000px;margin:0 auto;padding:2.1rem 20px;}</style><div class="css-hkr7jf em100y90"><style data-emotion-css="13vv67v">.css-13vv67v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding-bottom:2rem;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}</style><div class="css-13vv67v e1b8f8ar0"><style data-emotion-css="txnzm6">.css-txnzm6{margin:0 20px 0 0;padding-bottom:0;}.css-txnzm6 a{box-shadow:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;}.css-txnzm6 a:hover{-webkit-text-decoration:none;text-decoration:none;}</style><h3 class="css-txnzm6 e1b8f8ar2"><a name="title" href="/">Ben McCormick</a></h3><style data-emotion-css="1d1g5io">.css-1d1g5io{color:#777777;}</style><div class="css-1d1g5io e1b8f8ar3"><a class="css-1yerfx4" href="/archive/">Blog</a><style data-emotion-css="12jh0su">.css-12jh0su{padding:0 0.5rem;}@media all and (max-width:400px){.css-12jh0su{padding:0 0.25rem;}}</style><span class="css-12jh0su e1b8f8ar1"></span><a class="css-1yerfx4" href="/subscribe/">Subscribe</a><span class="css-12jh0su e1b8f8ar1"></span><a class="css-1yerfx4" href="/speaking/">Speaking</a><span class="css-12jh0su e1b8f8ar1"></span><a class="css-1yerfx4" href="http://twitter.com/_benmccormick">Twitter</a><span class="css-12jh0su e1b8f8ar1"></span><a class="css-1yerfx4" href="/about/">About</a></div></div><article class="markdown"><div class="post-title-area"><style data-emotion-css="92repi">.css-92repi{display:block;max-width:100%;}</style><h1 class="css-92repi e15djruj0">Running Jest Tests Before Each Git Commit</h1></div><div class="columns"><style data-emotion-css="qsg3oo">.css-qsg3oo{max-width:100%;}.css-qsg3oo li{padding-left:10px;}.css-qsg3oo .reading-img img{width:150px;float:right;margin:0px 10px 20px 10px;}.css-qsg3oo img.full-width{max-height:none;}.css-qsg3oo img.half-width{max-height:none;width:50%;}</style><div class="css-qsg3oo e15djruj2"><p>My main work project makes heavy use of <a href="https://facebook.github.io/jest/">Jest</a> to test our JavaScript code.  For a while now I’ve wanted to set up a way to run tests every time I run a commit.  I knew that git provides <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">hooks</a> that allow scripting actions to occur before or after any commit or push, and in fact we were already using a <code class="language-text">pre-commit</code> hook script to lint our code with <a href="http://eslint.org/">ESLint</a>.  But it was non-obvious how to make that work well with Jest testing.  I eventually figured out a setup that worked, and the found a better way to do both the Jest and ESLint testing.  Since it took me a while to work through, I thought I’d share it here and save the rest of you some time.</p>
<h3>What didn’t work</h3>
<p>A naive approach to this problem would be to set up a pre-commit hook that simply ran <code class="language-text">jest</code> to run all tests. The problem is that running our full test suite currently takes between 10 and 20 seconds to run all tests and that time is increasing as we grow our test suite.  Adding that overhead to every commit would cost my team a lot of time, and would be especially inefficient since the repo contains plenty non-JavaScript code that doesn’t require tests to be run when updated.</p>
<p>For our ESLint hook, we queried git to get a list of staged files, and then ran eslint against each one of them individually, displaying a pass/fail message.  That looked something like this:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token assign-left variable">STAGED_FILES</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> <span class="token function">diff</span> --cached --name-only --diff-filter<span class="token operator">=</span>ACM <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"js$"</span><span class="token variable">)</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$STAGED_FILES</span>"</span> <span class="token operator">=</span> <span class="token string">""</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">exit</span> <span class="token number">0</span>
<span class="token keyword">fi</span>

<span class="token assign-left variable">PASS</span><span class="token operator">=</span>true

<span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> <span class="token variable">$STAGED_FILES</span>
<span class="token keyword">do</span>
    eslint --quiet <span class="token string">"<span class="token variable">$FILE</span>"</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$?</span>"</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\t">\t</span><span class="token entity" title="\033">\033</span>[32mESLint Passed: <span class="token variable">$FILE</span><span class="token entity" title="\033">\033</span>[0m"</span>
    <span class="token keyword">else</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\t">\t</span><span class="token entity" title="\033">\033</span>[41mESLint Failed: <span class="token variable">$FILE</span><span class="token entity" title="\033">\033</span>[0m"</span>
        <span class="token assign-left variable">PASS</span><span class="token operator">=</span>false
    <span class="token keyword">fi</span>
<span class="token keyword">done</span></code></pre></div>
<p>This works great for ESLint, but doesn’t work out of the box for Jest, because I don’t want Jest to run the files that changed, I want them to run any tests that changed AND any tests that might have been broken because of that.</p>
<p>Jest has a wonderful command line flag <code class="language-text">jest --onlyChanged</code>/<code class="language-text">jest -o</code> that runs only the tests related to files that have been changed according to git.  It is extremely helpful since it is smart enough to read the dependency structure for the project and run all tests that might be changed from updating a source file. It also has a <code class="language-text">--lastCommit</code> option that does the same thing for files that were in the previous commit.  Unfortunately, these options aren’t helpful at the point of committing, since <code class="language-text">onlyChanged</code> does not look at files that have been staged for commit, and we haven’t actually made a commit yet for <code class="language-text">lastCommit</code> to read.</p>
<h3>What Did Work</h3>
<p>Fortunately Jest has a lower level command that uses the same logic as <code class="language-text">onlyChanged</code> and <code class="language-text">lastCommit</code>.  <code class="language-text">--findRelatedTests</code> is a flag that tells Jest to run any tests related to the files passed to it instead of trying to run those files as tests as it would normally do.</p>
<a class="gatsby-resp-image-link" href="/static/9350cbcea06e8f1f423335d94d84ac98/e8146/jest-related-tests.png" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-wrapper" style="position: relative; display: block;  max-width: 570px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 81.97573656845753%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAACYElEQVQ4y41UyW7TUBT1t7GoxA4EWzZsQCz4KYSEQKBSAWppJVQQlDYNbVzHyYsd2+95SNI4djwl6Xi4fulAUJtmcXSvh3feHc69yiA0YbochrAJDizPAfcdmOQP6dto2MbZyCUInI+n9ozs+S1Q1jafY3XzJeK+gcOgBbtdg8s1eEJHL2hIQhx5V2Tnc8gk4auP9/Dm0xLymBGhjrr2C6y5jRbbgWXu0gV/MOg1MUnt6wjnECvvvjzAh7VHSMIGhF3DduUbNG0LqvqTCKtwiNB1asgiczHC96sPsfz1MYphi0gNdLwD+EKFY+1RxHWkAwPHuQNMvMVSDtzv6He35MGjzKGaWeS3kFNESUg2NnFa8KvIpphDaJs1cEuVdSrocFmzFqtg2G9JwuiQzXb4gvA2KAbbhsf3ZTePqPAdT5PRYXJ9610kM4SjhONk5GOScYzLlFNH+ieFkKmeFlS/sVgYymFPhcGbsKWgOdyOQNAV4AFHMrAQRhyDJECUeGR9pJmHLJv6ESFOPcRkh+n0vbKy8QTL608R9hh8t4G6XiEdVsHYHoSjwnXriGMHRe5JjHMXk8JFnnlX7wryRxfflNcrS3j7+T51VkdAcqmQDpuN31LgnKTTJ+lEXR2TpC3remfKa5vPsP7jBcZ0IKIohbOPwD2gRtWkDnu+hrBLI5hYCzVICbsayaNJMmEkm5K0KQnKySiRX0zIrGzEzMT86yussQOD7dJyYFI6baMqcUlYTg/ox3JS/sdNC0MRNtWpo1PKFk2KTRtGl0TluB3nXC6F8rkU+uUF5VSVE3TTwvgL5+Ghb81Fxi8AAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
    <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;" alt="an example of findRelatedTests running against the redux repo" title="" src="/static/9350cbcea06e8f1f423335d94d84ac98/a9e6e/jest-related-tests.png" srcset="/static/9350cbcea06e8f1f423335d94d84ac98/40f08/jest-related-tests.png 143w,
/static/9350cbcea06e8f1f423335d94d84ac98/d4502/jest-related-tests.png 285w,
/static/9350cbcea06e8f1f423335d94d84ac98/a9e6e/jest-related-tests.png 570w,
/static/9350cbcea06e8f1f423335d94d84ac98/e8146/jest-related-tests.png 577w" sizes="(max-width: 570px) 100vw, 570px">
  </span>
  </a>
<p>This is a perfect fit for a pre-commit hook.  I was able to integrate it into my existing script like this:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">jest --bail --findRelatedTests <span class="token variable">$STAGED_FILES</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$?</span>"</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\t">\t</span><span class="token entity" title="\033">\033</span>[32mJest Tests Passed<span class="token entity" title="\033">\033</span>[0m"</span>
<span class="token keyword">else</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\t">\t</span><span class="token entity" title="\033">\033</span>[41mJest Tests Failed<span class="token entity" title="\033">\033</span>[0m"</span>
    <span class="token assign-left variable">PASS</span><span class="token operator">=</span>false
<span class="token keyword">fi</span></code></pre></div>
<p><code class="language-text">$STAGED_FILES</code> is re-used from the eslint portion of the script, and is just a space delimited list of files that are being committed.  The <code class="language-text">--bail</code> option simply stops running tests as soon as one has failed.  Including that is optional, you won’t see all the tests that have failed, but the failure will happen faster and you’ll be able to decide how to proceed, including possibly running the full test script on your own.   </p>
<p>Those lines (along with some sanity checks for the existence of Jest and error handling when PASS is set to false) are enough to get a workable commit hook going, but they’re not ideal.  pre-commit hooks aren’t persisted by git, so each user has to install the hook script individually, and any updates aren’t shared automatically.  Plus I’m inefficiently passing all staged files to eslint and Jest regardless of whether they’re JavaScript that those tools are actually meant to work on.  My ESLint code was also written before ESLint developed robust <code class="language-text">--fix</code> capabilities, and doesn’t try to fix the errors it is capable of fixing.  Finally, while this is just poor coding and not an inherent limitation of my other method, I’m using globally installed versions of Jest and ESLint instead of scoping them to my project.</p>
<h3>Making it better</h3>
<p>Fortunately I’d discovered a better solution the other day while working on something else.  There is an npm package for making this process easier, <a href="https://github.com/okonet/lint-staged">lint-staged</a>.  Lint staged abstracts away the boilerplate of getting the staged files, and makes it easy to run local node executables against specific sets of files.  I was able to replace my whole pre-commit script and address all of the problems mentioned above with only a few lines in my package.json:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"lint-staged"</span><span class="token operator">:</span> <span class="token string">"lint-staged"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"lint-staged"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"*.js"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"eslint --fix"</span><span class="token punctuation">,</span>
      <span class="token string">"git add"</span><span class="token punctuation">,</span>
      <span class="token string">"jest --bail --findRelatedTests"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"eslint"</span><span class="token operator">:</span> <span class="token string">"3.16.1"</span><span class="token punctuation">,</span>
    <span class="token property">"jest"</span><span class="token operator">:</span> <span class="token string">"19.0.1"</span><span class="token punctuation">,</span>
    <span class="token property">"lint-staged"</span><span class="token operator">:</span> <span class="token string">"3.3.1"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">lint-staged</code> now handles making sure that I’m only running checks against JavaScript files, lets eslint autofix and stage any files that it can fix, and uses the local versions of jest and eslint.  It also adds a nice pretty interface for the results:</p>
<a class="gatsby-resp-image-link" href="/static/07049d14abcd3c0065c9779b76d22045/27d9c/lint-staged-errors.png" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-wrapper" style="position: relative; display: block;  max-width: 570px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.321100917431195%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABCElEQVQoz3WR63KCMBCF8/6P15ZWEUXBCnJLMFwD9nQ3gU7r2B/fbNhkz5zDClkEuFxD6DrEqEO0co+mCtCpPerCt+eGetzv6wOm5oSvPsa9i2x9RHRyB5Vt7OBwc6KmOdrBgQRG2zvCMNSf2+iP4KOwGFWAJH6DzLfk6mBFWYwfYjj/InYsg3z/DGHKLRoSslEJFla5b88szvSLU6597XrP4jqHMsBMyoZccdy5de44GvemBY7LsccFvue3juhnTlTkRl83qOMX8Dn99JAlH8hTgmpy9nArd9AEL0lRAv5uFScKoJel6dLtQBjpY8w8TPk7TOWjK2hB6Sv60rdO1tiry/X//hf5G+jMEWFL2TQIAAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
    <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;" alt="pretty lint-staged output" title="" src="/static/07049d14abcd3c0065c9779b76d22045/a9e6e/lint-staged-errors.png" srcset="/static/07049d14abcd3c0065c9779b76d22045/40f08/lint-staged-errors.png 143w,
/static/07049d14abcd3c0065c9779b76d22045/d4502/lint-staged-errors.png 285w,
/static/07049d14abcd3c0065c9779b76d22045/a9e6e/lint-staged-errors.png 570w,
/static/07049d14abcd3c0065c9779b76d22045/c2e96/lint-staged-errors.png 855w,
/static/07049d14abcd3c0065c9779b76d22045/27d9c/lint-staged-errors.png 872w" sizes="(max-width: 570px) 100vw, 570px">
  </span>
  </a>
<p><code class="language-text">lint-staged</code> docs recommend using an npm based hooks manager like <a href="https://github.com/observing/pre-commit">pre-commit</a> for running the scripts, but due to some quirks in my setup (node_modules is symlinked, and I sometimes want to run these commands inside a docker container), I found it easier to maintain a custom pre-commit script and just replace the previous logic with <code class="language-text">npm run lint-staged</code>.  Either way, all of the actual logic is now checked into the repository and shared between all users.  The only manual step is adding the call to a pre-commit hook or (if you’re using a helper lib) running npm install.</p>
<h3>More Resources</h3>
<ul>
<li>This maybe merits a future post on its own, but if you’re interested in automating away your code style maintenance look at combining <a href="https://github.com/prettier/prettier">prettier</a> (and possibly  <a href="https://github.com/not-an-aardvark/eslint-plugin-prettier">eslint-plugin-prettier</a>) with the pre-commit hooks from above.  Prettier will guarantee that your code follows a consistent style, and because it handles maximum line lengths, is much more robust than ESLint on its own.  Using its ESLint plugin within my editor and on pre-commit hooks has pretty much eliminated me manually fixing code style problems.</li>
</ul></div><style data-emotion-css="rd3zyi">.css-rd3zyi{padding-left:2rem;overflow:hidden;}</style><div class="no-mobile css-rd3zyi e15djruj3"><style data-emotion-css="1y23a7j">.css-1y23a7j{overflow:hidden;margin:0;}.css-1y23a7j #mc_embed_signup form{margin-bottom:20px;}@media all and (max-width:700px){.css-1y23a7j{padding-right:0;width:100% !important;padding:0 10px;}.css-1y23a7j .mc-field-group{width:100% !important;}.css-1y23a7j .mc-field-group input{width:100% !important;font-size:0.8em;height:2.4em;}}</style><div class="css-1y23a7j e1qbom70"><form action="https://buttondown.email/api/emails/embed-subscribe/benmccormick" method="post" target="popupwindow" class="embeddable-buttondown-form"><label for="bd-email" id="bd-label">Subscribe to the Newsletter</label><input type="hidden" value="1" name="embed"/><div class="bd-subscribe-row"><input type="email" name="email" id="bd-email" placeholder="Your Email"/><input type="submit" value="Subscribe" id="bd-submit"/></div></form></div><style data-emotion-css="1cdsqjf">.css-1cdsqjf{width:100%;overflow:hidden;margin:0 0 1rem 0;font-size:14px;position:relative;font-family:"Inter","Helvetica Neue","Helvetica",Arial,sans-serif;background:rgba(99,159,110,0.25);border:1px solid rgba(90,150,100,0.5);padding:4px;min-height:100px;opacity:0;-webkit-transition:opacity ease 3s;transition:opacity ease 3s;}@media all and (max-width:700px){.css-1cdsqjf{display:none;}}</style><div class="css-1cdsqjf etmlefq0"></div><style data-emotion-css="nczh1z">.css-nczh1z{font-size:13px;background-color:rgba(150,178,198,0.4);border:1px solid rgb(150,178,198);padding:0.5rem;}.css-nczh1z > h4{font-size:20px;margin-bottom:6px;}.css-nczh1z > h6{font-size:16px;margin-bottom:6px;margin-top:12px;}</style><div class="css-nczh1z e15djruj1"><h4>Article Info</h4><h6>Author</h6><a href="/about">Ben McCormick</a><h6>Publish Date</h6>February 26th 2017<h6>Category</h6><a href="/category/tools"><style data-emotion-css="1bs7qd7">.css-1bs7qd7:hover{-webkit-text-decoration:none;text-decoration:none;}</style><div class="css-1bs7qd7 e1nsgn8x0">Software Tools</div></a></div></div></div></article></div><style data-emotion-css="qyaqf1">.css-qyaqf1{width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:3em 0 1em 0;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;background-color:rgba(150,178,198,0.4);border-top:1px solid rgb(150,178,198);}</style><div class="css-qyaqf1 e7oz9l30"><style data-emotion-css="1iyv46l">.css-1iyv46l{width:100%;min-height:200px;max-width:960px;margin:0 auto;padding:0 1.05rem;display:grid;grid-template-columns:45% 45%;grid-column-gap:10%;grid-row-gap:30px;}@media all and (max-width:450px){.css-1iyv46l{grid-template-columns:100%;}}</style><div class="css-1iyv46l e7oz9l31"><div><h2 class="css-0 e7oz9l33">Content</h2><style data-emotion-css="1xfqzqa">.css-1xfqzqa{display:grid;grid-template-columns:1fr;grid-auto-rows:1fr;grid-row-gap:20px;}</style><div class="css-1xfqzqa e7oz9l32"><a class="css-pe78rs" href="/archive/">Blog Archive</a><a class="css-pe78rs" href="/reviews-archive/">Book Reviews</a><a class="css-pe78rs" href="https://buttondown.email/benmccormick">Newsletter Archives</a><a class="css-pe78rs" href="/speaking/">Speaking</a></div></div><div><h2 class="css-0 e7oz9l33">Meta</h2><div class="css-1xfqzqa e7oz9l32"><a class="css-pe78rs" href="/subscribe/">Subscribe To The Newsletter</a><a class="css-pe78rs" href="/built-with/">Built With</a><a class="css-pe78rs" href="http://twitter.com/_benmccormick">Personal Twitter</a><a class="css-pe78rs" href="http://twitter.com/benmccormickorg">Blog Twitter</a><a class="css-pe78rs" href="/about/">About Me</a></div></div><style data-emotion-css="lfoydm">.css-lfoydm{font-family:"Inter","Helvetica Neue","Helvetica",Arial,sans-serif;font-size:14px;overflow:visible;white-space:nowrap;}</style><div class="css-lfoydm e7oz9l34">Copyright © 2012-2021 · Ben McCormick</div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-37323973-1', 'auto');
            ga('send', 'pageview');
        </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2017/02/26/running-jest-tests-before-each-git-commit/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-404a8fe84b9b126210e7.js"],"app":["/app-7099fdfd5aecf07773ba.js"],"component---src-pages-archive-js":["/component---src-pages-archive-js-d21aa8872171cc4f2a81.js"],"component---src-pages-index-js":["/component---src-pages-index-js-df2deb8169a04717b7d5.js"],"component---src-pages-links-archive-js":["/component---src-pages-links-archive-js-5e73a19b153d9cf24490.js"],"component---src-pages-lions-archive-js":["/component---src-pages-lions-archive-js-06f1e50f606afe098e40.js"],"component---src-pages-reviews-archive-js":["/component---src-pages-reviews-archive-js-5b92b07e1659a8dea180.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-7f435882c318538af698.js"],"component---src-templates-category-page-js":["/component---src-templates-category-page-js-7c6fb1b940d7b16b933f.js"],"component---src-templates-topic-page-js":["/component---src-templates-topic-page-js-72580c9a638236569bc8.js"]};/*]]>*/</script><script src="/polyfill-404a8fe84b9b126210e7.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-7f435882c318538af698.js" async=""></script><script src="/commons-d750081a92f32f033430.js" async=""></script><script src="/styles-e9d24b1846c7d6eb9685.js" async=""></script><script src="/app-7099fdfd5aecf07773ba.js" async=""></script><script src="/framework-beda7bde9d7dca0755ce.js" async=""></script><script src="/webpack-runtime-bd5aca0bc92760bfef0f.js" async=""></script></body></html>