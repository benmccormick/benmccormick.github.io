{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018/09/17/lodash-wip/","result":{"data":{"markdownRemark":{"html":"<h1>Diving Into lodash - Merging and Cloning Objects</h1>\n<p>When working with data, it’s common to have to merge data from multiple objects to create a new object, create a copy of an existing object, or update an existing object with properties form another object.  <a href=\"https://lodash.com/\">lodash</a> makes these operations easy.  Let’s take a look at what it provides.</p>\n<h3>Merging Objects</h3>\n<p>In my last post I mentioned an example application where we want to merge 2 contact records:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> contact1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    firstName<span class=\"token punctuation\">:</span> <span class=\"token string\">'John'</span><span class=\"token punctuation\">,</span>\n    lastName<span class=\"token punctuation\">:</span> <span class=\"token string\">'Smith'</span><span class=\"token punctuation\">,</span>\n    phone<span class=\"token punctuation\">:</span> <span class=\"token string\">'919.222.7855'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> contact2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    firstName<span class=\"token punctuation\">:</span> <span class=\"token string\">'John'</span><span class=\"token punctuation\">,</span>\n    phone<span class=\"token punctuation\">:</span> <span class=\"token string\">'919.965.9999'</span><span class=\"token punctuation\">,</span>\n    email<span class=\"token punctuation\">:</span> <span class=\"token string\">'john.smith@gmail.com'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>There I talked about <code class=\"language-text\">_.assign</code> as an alternative to the native <code class=\"language-text\">Object.assign</code>.  <code class=\"language-text\">_.assign</code> is lodash’s most basic “merging” function.  <code class=\"language-text\">_.assign</code>, like <code class=\"language-text\">Object.assign</code> takes 2 or more arguments: a destination object, and 1 or more source objects. It then returns the destination object.  When there are conflicts, the rightmost object “wins”.  Using it looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//merge contact2 into contact1</span>\n_<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>contact1<span class=\"token punctuation\">,</span> contact2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">/*\n// contact1\n{\n    firstName: 'John',\n    lastName: 'Smith',\n    phone: '919.965.9999',\n    email: 'john.smith@gmail.com',\n\n}\n*/</span>\n\n<span class=\"token comment\">//merge contact1 and contact 2 into a new object</span>\n\n<span class=\"token keyword\">let</span> newContact <span class=\"token operator\">=</span> _<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> contact1<span class=\"token punctuation\">,</span> contact2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/*\n// newContact\n{\n    firstName: 'John',\n    lastName: 'Smith',\n    phone: '919.965.9999',\n    email: 'john.smith@gmail.com',\n\n}\n*/</span></code></pre></div>\n<p><code class=\"language-text\">_.assign</code> is great as a compatible stand-in for Object.assign.  But lodash provides several other variant methods for merging that give a clear unambiguous syntax for a variety of use cases.</p>\n<p><code class=\"language-text\">_.assignIn</code>  is a variant of <code class=\"language-text\">_.assign</code> that adds both enumerable “own” properties and enumerable “inherited” properties from the source objects to the destination object.  This is in contrast to <code class=\"language-text\">_.assign</code> and <code class=\"language-text\">Object.assign</code> which only add enumerable “own” properties.</p>\n<p>In JavaScript inheritance works through a “prototype object”.  Both through ES6’s class syntax and older function-based syntaxes for Object Oriented programming in JavaScript, objects that inherit from another object have the <em>parent</em> object defined as their “prototype”.  <code class=\"language-text\">_.assignIn</code> will pull enumerable properties off of each source’s prototype object (and its prototype object, and so on up the chain), and add them directly to the destination object.</p>\n<p><code class=\"language-text\">_.assignWith</code> is another <code class=\"language-text\">_.assign</code> variant that allows lodash to handle more complicated merges. In our example above, merging our 2 contacts causes us to lose contact1’s phone number.  But in a real application that is probably not what we would want.  <code class=\"language-text\">_.assignWith</code> will allow us to preserve both phone numbers by merging them into an array.  <code class=\"language-text\">_.assignWith</code> takes the same arguments as <code class=\"language-text\">_.assign</code> but adds an optional final <code class=\"language-text\">customizer</code> argument.  <code class=\"language-text\">_.assignWith</code> expects <code class=\"language-text\">customizer</code> to be a function that takes 5 arguments: (objValue, srcValue, key, object, source). When merging values, customizer is run to determine what the destination value should be.  So our example above can become:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//merge contact2 into contact1</span>\n_<span class=\"token punctuation\">.</span><span class=\"token function\">assignWith</span><span class=\"token punctuation\">(</span>contact1<span class=\"token punctuation\">,</span> contact2<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">dest<span class=\"token punctuation\">,</span> src<span class=\"token punctuation\">,</span> key</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> bothDefined <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">.</span><span class=\"token function\">isUndefined</span><span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> _<span class=\"token punctuation\">.</span><span class=\"token function\">isUndefined</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">===</span> <span class=\"token string\">'phone'</span> <span class=\"token operator\">||</span> key <span class=\"token operator\">===</span> <span class=\"token string\">'email'</span> <span class=\"token operator\">&amp;&amp;</span> bothDefined<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> _<span class=\"token punctuation\">.</span><span class=\"token function\">flatten</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>src<span class=\"token punctuation\">,</span> dest<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> _<span class=\"token punctuation\">.</span><span class=\"token function\">isUndefined</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> dest <span class=\"token punctuation\">:</span> src<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">/*\n// contact1\n{\n    firstName: 'John',\n    lastName: 'Smith',\n    phone: ['919.965.9999', '919.222.7855'],\n    email: 'john.smith@gmail.com',\n\n}\n*/</span></code></pre></div>\n<p>The customizer argument can be used for more things, including implementing a “safe” merge where an error is thrown on any conflict, or averaging 2 numeric values that are being merged.  There is also a <code class=\"language-text\">_.assignInWith</code> that combines <code class=\"language-text\">_.assignIn</code> and <code class=\"language-text\">_.assignWith</code>.</p>\n<p><code class=\"language-text\">_.defaults</code> is another variation on <code class=\"language-text\">_.assign</code>.  <code class=\"language-text\">_.assign</code> works “left to right”, starting with the destination and then adding properties on top of that from each source in the list of arguments, with objects to the right “winning” when their are conflicts.  So we get <code class=\"language-text\">{ foo: 10</code>} in the following expression:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">_.assign({foo: 0}, {foo: 5}, {foo: 10});</code></pre></div>\n<p>Sometimes we might want to reverse that flow, with the destination object “winning” any conflicts.  This is specifically helpful if we want to fill in an existing object with the “defaults” for fields that are not defined.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">let obj1 = {\n    foo: 0\n};\nlet obj2 = {\n    foo: 5,\n    bar: 10\n};\n\n_.defaults(obj1, obj2);\n// {foo: 0, bar: 10}</code></pre></div>\n<h3>Deep Merging</h3>\n<p>All of the methods we’ve looked at so far work on the top level key-value pairs of their source and destination objects.  But sometimes we need to merge nested objects.  lodash provides 3 methods for this use case: <code class=\"language-text\">_.merge</code>, <code class=\"language-text\">_.mergeWith</code> and <code class=\"language-text\">_.defaultsDeep</code>.</p>\n<p><code class=\"language-text\">_.merge</code> is similar to <code class=\"language-text\">_.assign</code>.  It takes a destination object, and multiple source objects and merges them together.  Unlike <code class=\"language-text\">_.assign</code> it is a deep merge.  So when we nest objects and arrays, we can merge like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> contact1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    firstName<span class=\"token punctuation\">:</span> <span class=\"token string\">'John'</span><span class=\"token punctuation\">,</span>\n    lastName<span class=\"token punctuation\">:</span> <span class=\"token string\">'Smith'</span><span class=\"token punctuation\">,</span>\n    address<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        street<span class=\"token punctuation\">:</span> <span class=\"token string\">'1 Main St'</span><span class=\"token punctuation\">,</span>\n        state<span class=\"token punctuation\">:</span> <span class=\"token string\">'NC'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> contact2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    firstName<span class=\"token punctuation\">:</span> <span class=\"token string\">'John'</span><span class=\"token punctuation\">,</span>\n    phone<span class=\"token punctuation\">:</span> <span class=\"token string\">'919.965.9999'</span><span class=\"token punctuation\">,</span>\n    address<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        street<span class=\"token punctuation\">:</span> <span class=\"token string\">'1 Main St'</span><span class=\"token punctuation\">,</span>\n        city<span class=\"token punctuation\">:</span> <span class=\"token string\">'Durham'</span><span class=\"token punctuation\">,</span>\n        state<span class=\"token punctuation\">:</span> <span class=\"token string\">'North Carolina'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n_<span class=\"token punctuation\">.</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>contact1<span class=\"token punctuation\">,</span> contact2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">/*\n{\n    firstName: 'John',\n    lastName: 'Smith',\n    phone: '919.965.9999',\n    address: {\n        street: '1 Main St',\n        city: 'Durham',\n        state: 'NC',\n    }\n}\n*/</span></code></pre></div>\n<p>Now that we’ve seen <code class=\"language-text\">_.merge</code>, it’s hopefully not surprising that <code class=\"language-text\">_.mergeWith</code> is similar to <code class=\"language-text\">_.assignWith</code>, with deep merging possibilities.  <code class=\"language-text\">_.mergeWith</code> has the same API as <code class=\"language-text\">_.assignWith</code>, with the only change being an extra argument, <code class=\"language-text\">stack</code>, passed to the customizer function.  <code class=\"language-text\">stack</code> is an internal lodash data structure that allows you to keep track of the traversal as you move through nested deep merges. Finally, <code class=\"language-text\">_.defaultsDeep</code> has the same API as <code class=\"language-text\">_.defaults</code> but performs a deep merge.</p>\n<p>There’s one last merging function in lodash, and it is a bit of an oddball.  <code class=\"language-text\">_.mixin</code> is a legacy function from when lodash began as a fork of underscore, and it is a bit of an oddball in terms of syntax.  <code class=\"language-text\">_.mixin</code> has only one required argument, a source object.  It does not take multiple sources.  Instead, you can optionally pass a destination object as a first object, and an options object as a 3rd object.  The original intention of <code class=\"language-text\">_.mixin</code> was providing a way to extend the <code class=\"language-text\">underscore</code>/<code class=\"language-text\">lodash</code> object, and so the default destination is <code class=\"language-text\">_</code> itself.  I’ll discuss that and the options argument more when I write about chaining lodash functions, but for now the important thing to know is that the main distinction between <code class=\"language-text\">_.mixin</code> and <code class=\"language-text\">_.assign</code> when merging a single source to a single destination is that <code class=\"language-text\">_.mixin</code> will add functions from the source object onto both the destination object and its prototype.</p>\n<h3>Cloning Objects</h3>\n<p>Like merging, cloning objects is an important operation in many programs.  Because JavaScript objects are <a href=\"http://benmccormick.org/2016/06/04/what-are-mutable-and-immutable-data-structures-2/\">mutable</a> by default, passing them around can often be unsafe if we don’t know how they’re going to be used.  If we want to pass information to a function, but don’t want to allow it to mutate “our copy”, we can clone it.</p>\n<p>After learning about lodash’s merge operations we already have everything we need to shallow clone an object using the methods above.  We can write our own shallow clone function like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const shallowClone = obj =&gt; _.extend({}, obj);</code></pre></div>\n<p>But lodash is all about simplifying common operations, so it provides its own <code class=\"language-text\">_.clone</code> function.  This function is a bit more powerful than our simple example above.  In addition to handling plain objects, it can also handle arrays, numbers, strings, Buffers and more.  It essentially tries to do something intelligent with anything you throw at it, though it will return empty objects for non-cloneable objects like functions and DOM nodes.</p>\n<p>Simple cloning is great, but we sometimes want to do something more complicated.  Let’s consider the following order record:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> order <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token number\">123</span><span class=\"token punctuation\">,</span>\n    productIds<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">12345</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6789</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    shippingAddress<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/*...*/</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    billingInfo<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/*...*/</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    total<span class=\"token punctuation\">:</span> <span class=\"token string\">'56.85'</span><span class=\"token punctuation\">,</span>\n    orderDate<span class=\"token punctuation\">:</span> <span class=\"token string\">'09/21/2015'</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If we want to allow a client to repeat their order, we might want to clone this object to make sure we capture all of the order metadata correctly.  The problem is that there are some fields we don’t want to capture, specifically id and orderDate.  We could explicitly list the fields we want to copy, but then we’d have to update the code anytime we added a new field.</p>\n<p><code class=\"language-text\">_.cloneWith</code> helps solve this problem.  Like <code class=\"language-text\">_.assignWith</code> <code class=\"language-text\">_.cloneWith</code> takes a customizer function that allows us to choose how to handle an individual key. We can either return a value to use as the cloned value, or undefined.  Returning undefined causes the method to revert to the base code.  So we can handle our clone like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">mergeFunc</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> object<span class=\"token punctuation\">,</span> stack</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">generateNewId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'date'</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">moment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">'MM/DD/YYYY'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> newOrder <span class=\"token operator\">=</span> _<span class=\"token punctuation\">.</span><span class=\"token function\">cloneWith</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">,</span> mergeFunc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The final 2 clone methods lodash provides are <code class=\"language-text\">_.cloneDeep</code> and <code class=\"language-text\">_.cloneDeepWith</code>.  If you’ve been paying attention up till now, these 2 should be self explanatory.  They work the same as <code class=\"language-text\">_.clone</code> and <code class=\"language-text\">_.cloneWith</code> but also clones nested objects.</p>\n<p>It may seem weird that lodash has 12 different functions for cloning and merging objects, but hopefully I’ve been able to show how that can be helpful.  Use the right tool for the job!</p>\n<h3>Subscribe</h3>\n<p>Thanks for taking the time to read this post!  JavaScript development is one of the main topics of this blog, so if you enjoyed the post, please consider subscribing by using the <a href=\"http://feedpress.me/benmccormick\">feed</a>, <a href=\"http://twitter.com/benmccormickorg\">Twitter</a> or my <a href=\"http://eepurl.com/WFYon\">mailing list</a>. You also might want to check out the [first post in this series][firstpost].</p>\n<p>[firstpost]:</p>","frontmatter":{"title":"Lodash WIP","keywords":"","category":"software-productivity","date":"2018/09/17","path":"/2018/09/17/lodash-wip/","layout":"post","hideFooter":null,"hideSidebar":null},"fields":{"slug":"/2018/09/17/lodash-wip/"}}},"pageContext":{"slug":"/2018/09/17/lodash-wip/","relatedPosts":[{"path":"/2018/08/02/feedback-loops/","data":{"title":"Feedback Loops","path":"/2018/08/02/feedback-loops/","description":"How smaller loops lead to better software","date":"2018/08/02","category":"soft-skills"}},{"path":"/2017/07/19/ten-things-javascript/","data":{"title":"Ten Things A Serious JavaScript Developer Should Learn","path":"/2017/07/19/ten-things-javascript/","description":"Some of the important things to pick up in the JS world","date":"2017-07-19T04:00:00+00:00","category":"javascript"}},{"path":"/2018/02/07/react-confessions/","data":{"title":"React Architecture Confessions","path":"/2018/02/07/react-confessions/","description":"The mistakes I made while learning React and why I made them","date":"2018/02/07","category":"fe-architecture"}}]}},"staticQueryHashes":[]}