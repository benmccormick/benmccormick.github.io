{
    "componentChunkName": "component---src-templates-topic-page-js",
    "path": "/topics/Code Quality",
    "result": {"pageContext":{"posts":[{"node":{"frontmatter":{"readNext":null,"topics":["Command Line","Code Quality"],"category":"tools","key":null,"title":"Creating a Build System For a Coffeescript Project with Ant","description":"Using Ant to build my coffeescript projects","layout":"post","path":"/2013/03/23/creating-a-build-system-for-a-coffeescript-project-with-ant","date":"2013-03-23T16:23:00+00:00","dontfeature":null,"isDraft":null},"html":"<p>I’ve recently taken the time to develop an organized build system for a <a href=\"http://Coffeescript.org/\">Coffeescript</a> and <a href=\"http://sass-lang.com/\">SASS</a> <a href=\"https://bitbucket.org/ben336/scratchcalc\">project</a> that I’ve been working on in my free time.  I learned a lot during the process, and I wanted to share my experience here.  I used Ant for my build system, and worked in a variety of different libraries for minification, testing and documentation.</p>\n<h3>Getting Started</h3>\n<p>The first step is to install Ant.  It comes preinstalled on OSX, is <a href=\"http://www.rndblog.com/how-to-install-ant-on-linux/\">fairly straightforward</a> to install on Linux, and is <a href=\"http://www.nczonline.net/blog/2012/04/12/how-to-install-apache-ant-on-windows/\">a bit more involved</a> to install on Windows  If you’re using my exact setup, you’ll also need <a href=\"http://nodejs.org/\">NodeJS</a> (for Coffeescript, UglifyJS,and Docco) and <a href=\"http://www.ruby-lang.org/\">Ruby</a> (for SASS) installed.</p>\n<h3>My Project Structure</h3>\n<p>I went for a structure with 4 directories.</p>\n<ul>\n<li>src</li>\n<li>build</li>\n<li>test</li>\n<li>docs</li>\n</ul>\n<p>All of the source files are in the source directory, with Javascript and Coffeescript files in a scripts directory, and SASS styles in a styles folder.  This particular app has only a single HTML file, which sits in the root of the source directory.  The test folder contains a single HTML page, and a series of unit test files written in Coffeescript, in a structure that mirrors the src directory.  The build and docs directories are initially empty.</p>\n<h3>The Basics</h3>\n<p>We start with a simple Ant setup.  We’ll create an init task, a clean task, and debug and production tasks.  The following code goes into our build.xml file, which is placed at the root of the project directory.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;project name=\"scratchcalc\" default=\"debug\">\n\n    &lt;loadproperties srcfile=\"build.properties\" />\n\n    &lt;target name=\"debug\" depends=\"clean, init\">\n        &lt;echo>ScratchCalc Version ${version} (Debug Version)&lt;/echo>\n    &lt;/target>\n\n    &lt;target name=\"production\" depends=\"clean, init\">\n        &lt;echo>ScratchCalc Version ${version}&lt;/echo>\n    &lt;/target>\n\n    &lt;target name= \"init\">\n        &lt;mkdir dir=\"${build.dir}\" />\n    &lt;/target>\n\n    &lt;target name=\"clean\">\n        &lt;delete dir=\"${build.dir}\" />\n    &lt;/target>\n\n&lt;/project></code></pre></div>\n<p>So for this project, we now have 4 tasks that we can call.  To call the init task, all we need to do is run</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Ant init</code></pre></div>\n<p>from the command line.   Both our debug and production tasks mark clean and init as dependencies, so running them will remove and restore the build directory.  Beyond that, our build doesn’t do much right now.  Lets change that.</p>\n<h3>Copying</h3>\n<p>The simplest thing we can do with our Ant file is basic copying of files.  So lets start with a task that just copies over our files from the src directory to the build directory.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>target</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>copy<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">description</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Copies files from src to build dirs<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>echo</span><span class=\"token punctuation\">></span></span>Copying JS, CSS &amp; HTML Files<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>echo</span><span class=\"token punctuation\">></span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>copy</span> <span class=\"token attr-name\">todir</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${build.dir}<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>fileset</span> <span class=\"token attr-name\">dir</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${src.dir}<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">includes</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>**/*.HTML,**/*.css,**/*.js<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>copy</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>target</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>This simply copies any HTML, CSS, or Javascript files in the src directory over to an equivalent position in the build directory.  The segments in the <code class=\"language-text\">${}</code> format are variables defined in our build.properties file.  For my project, that looks something like this so far:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">version = 0.0.1\ncopyright = Copyright 2012-2013 Ben McCormick.\nsrc.dir = ./src\nbuild.dir = ./build\ntest.dir = ./test\nlib.dir = ${src.dir}/ext</code></pre></div>\n<p>This would be a great place to start for a project thats currently running without a build system.  If you’re able to get your project to build like this, it will set you up to be able to start more interesting things going forward.</p>\n<p>And we of course want to do more interesting things.  This project uses Coffeescript and SASS, so we’ll need to do a bit more than just copy files.  So lets copy those scripts as well, but convert them to Javascript and CSS while we do.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>target</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>copy<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">description</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Compiles Coffeescript and SASS files,copies the rest<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>echo</span><span class=\"token punctuation\">></span></span>Copying Coffeescript Files<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>echo</span><span class=\"token punctuation\">></span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>copy</span> <span class=\"token attr-name\">todir</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${build.dir}<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>fileset</span> <span class=\"token attr-name\">dir</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${src.dir}<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">includes</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>**/*.HTML,**/*.css,**/*.js<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>copy</span><span class=\"token punctuation\">></span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>exec</span> <span class=\"token attr-name\">executable</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>coffee<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>--compile<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>--map<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>--output<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${build.script.dir}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${src.script.dir}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>exec</span><span class=\"token punctuation\">></span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>mkdir</span> <span class=\"token attr-name\">dir</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${build.styles.dir}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>apply</span> <span class=\"token attr-name\">executable</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sass<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">dest</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${build.dir}<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">verbose</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">force</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">failonerror</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>--unix-newlines<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>srcfile</span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>targetfile</span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>filelist</span> <span class=\"token attr-name\">dir</span> <span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${src.dir}<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">files</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>styles/scratch.sass<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token comment\">&lt;!--&lt;fileset dir=\"${src.dir}\" includes=\"**/*.sass\"  />--></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>mapper</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>glob<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">from</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>*.sass<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">to</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>*.css<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>apply</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>target</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>So along with copying the raw files, we also now copy the Coffeescript and SASS files.  For Coffeescript, we run the coffee executable against the entire src dir, and have it mirror the output to the build dir.  For Sass, we only want to run the compile on a single file, which pulls all of the other files into it through import statements.  So we use the filelist and mapper to specify the input and output files.</p>\n<h3>Concatenation</h3>\n<p>Mirroring your directory can be helpful for debugging, and is a good initial step if you’re converting to Ant from a locally run project.  But we’d really like to limit the amount of requests we make when deploying our site.  To do that, we’ll concatenate the js files together.  For my project I create 2 files, one for my external dependencies, and one for my own local files.  I may eventually reduce this to 1, but for now I like separating the 2 for debugging clarity.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>target</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>concatenatejs<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">description</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Concatenate All the JS together<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token comment\">&lt;!-- Instead of concatenating the JS files directly, use coffee to preserve the source map --></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>echo</span><span class=\"token punctuation\">></span></span>Concatenating the JS<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>echo</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>concat</span> <span class=\"token attr-name\">destfile</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${build.libs}<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>filelist</span> <span class=\"token attr-name\">dir</span> <span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${build.script.dir}<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">files</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>lib/jquery.js,lib/knockout.js,lib/BigDecimal.js<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>fileset</span> <span class=\"token attr-name\">dir</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${build.script.dir}/lib<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">includes</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>**/*.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>concat</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>apply</span> <span class=\"token attr-name\">executable</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>coffee<span class=\"token punctuation\">\"</span></span>  <span class=\"token attr-name\">verbose</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">force</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">failonerror</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">parallel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>--compile<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>--map<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>--join<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${build.script.output}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>srcfile</span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>filelist</span> <span class=\"token attr-name\">dir</span> <span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${src.script.dir}<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">files</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>editor/toolkit.coffee,editor/markupGen.coffee,parser/eqTreeBuilder.coffee,parser/NumberValue.coffee,parser/eqScanner.coffee,parser/eqTokenizer.coffee,parser/tablePlaceHolder.coffee,parser/EQParser.coffee,parser/calcFramework.coffee,editor/editor.coffee<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>apply</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>target</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>For the external libraries I use Ant’s built in <code class=\"language-text\">concat</code> task to concatenate the files together.  For the Coffeescript files, I use the coffee compiler rather than concatenating the files that I copied.  I was hoping to do this in order to preserve the source map, which allows for easier debugging.  Unfortunately the compiler has trouble generating source maps for joined files right now.  I’m hoping to fix that in the future, in the meantime I may be using a different approach, possibly using uglifyjs to concatenate the files and generate the maps.</p>\n<h2>Minify</h2>\n<p>Speaking of <a href=\"https://github.com/mishoo/UglifyJS2\">uglifyjs</a>, I use that for minifying my Javascript.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>target</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>minify<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">description</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Minify the JS for Production<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>echo</span><span class=\"token punctuation\">></span></span>Minifying the JS For Production with UglifyJS<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>echo</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>apply</span> <span class=\"token attr-name\">executable</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>uglifyjs<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">verbose</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">force</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">failonerror</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>srcfile</span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>--output<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${build.script.output}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>filelist</span>  <span class=\"token attr-name\">files</span> <span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${build.script.output}<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>apply</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>target</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>I only require this for the production task, and leave the full source available for the debug task to preserve the readability of the generated JS.</p>\n<h3>Documentation</h3>\n<p>I use <a href=\"http://jashkenas.github.com/docco\">docco</a> for my Coffeescript documentation.  It converts comments into documentation and runs them through a <a href=\"http://daringfireball.net/projects/markdown/\">Markdown</a> parser to generate a clean HTML page with the code and comments intermingled.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>target</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>documentation<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">description</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Generate Docco Documentation for coffee files<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>echo</span><span class=\"token punctuation\">></span></span>Generating Documentation with Docco<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>echo</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>apply</span> <span class=\"token attr-name\">executable</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>docco<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">verbose</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">force</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">failonerror</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>srcfile</span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>fileset</span> <span class=\"token attr-name\">dir</span> <span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${src.script.dir}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>include</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>**/*.coffee<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>fileset</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>apply</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>target</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h3>Testing</h3>\n<p>I use Jasmine for testing.  <a href=\"http://pivotal.github.com/jasmine\">Jasmine</a> is a “Behavior Driven Development” style unit testing framework for Javascript.  In an ideal world I would be setting up a build task to run on the server and display the results when I run the build.  Unfortunately I wasn’t able to find a way to do that without generating additional dependencies.  Its possible with NodeJS or RequireJS style modules and dependencies, and its also possible using phantomJS, but I didn’t want to require either of those for testing.   So instead I have my build task generate an HTML page with the test results.  I may add some scripting to open this page by default after running a production build in the future.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>target</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>test<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">description</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Generate the JS for testing with Jasmine<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token comment\">&lt;!-- Ideally this would run a server side jasmine test, but that requires better dependency management than we have right now--></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>echo</span><span class=\"token punctuation\">></span></span>Generating the Test JS with jasmine<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>echo</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>apply</span> <span class=\"token attr-name\">executable</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>coffee<span class=\"token punctuation\">\"</span></span>  <span class=\"token attr-name\">verbose</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">force</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">failonerror</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">parallel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>--compile<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>--join<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>arg</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${test.output}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>srcfile</span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>fileset</span> <span class=\"token attr-name\">dir</span> <span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${test.dir}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>include</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>**/*.coffee<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>fileset</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>apply</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>target</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h3>Summary</h3>\n<p>Adding a build system has been great for my project.  Its allowed me to be a lot more organized and to do some cool things that are a pain by hand (unit testing, Coffeescript).  I definitely recommend looking into doing this for any non-trivial Javascript/web project that you’re working on.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;project name=\"scratchcalc\" default=\"debug\">\n\n  &lt;loadproperties srcfile=\"build.properties\" />\n\n  &lt;target name=\"debug\" depends=\"clean, init, copy,concatenatejs\">\n    &lt;echo>ScratchCalc Version ${version} (Debug Version)&lt;/echo>\n  &lt;/target>\n\n  &lt;target name=\"production\" depends=\"clean, init, copy,concatenatejs,minify,documentation,test\">\n    &lt;echo>ScratchCalc Version ${version}&lt;/echo>\n  &lt;/target>\n\n  &lt;target name=\"copy\" description=\"Compiles Coffeescript and SASS files,copies the rest\">\n    &lt;echo>Copying Coffeescript Files&lt;/echo>\n     &lt;copy todir=\"${build.dir}\">\n      &lt;fileset dir=\"${src.dir}\" includes=\"**/*.HTML,**/*.css,**/*.js\" />\n     &lt;/copy>\n     &lt;exec executable=\"coffee\">\n        &lt;arg value=\"--compile\"/>\n        &lt;arg value=\"--map\" />\n        &lt;arg value=\"--output\" />\n        &lt;arg value=\"${build.script.dir}\" />\n        &lt;arg value=\"${src.script.dir}\" />\n     &lt;/exec>\n     &lt;mkdir dir=\"${build.styles.dir}\" />\n     &lt;apply executable=\"sass\" dest=\"${build.dir}\" verbose=\"true\" force=\"true\" failonerror=\"true\">\n          &lt;arg value=\"--unix-newlines\" />\n          &lt;srcfile />\n          &lt;targetfile />\n          &lt;filelist dir =\"${src.dir}\" files=\"styles/scratch.sass\" />\n          &lt;!--&lt;fileset dir=\"${src.dir}\" includes=\"**/*.sass\"  />-->\n          &lt;mapper type=\"glob\" from=\"*.sass\" to=\"*.css\"/>\n      &lt;/apply>\n  &lt;/target>\n\n  &lt;target name=\"concatenatejs\" description=\"Concatenate All the JS together\">\n    &lt;!-- Instead of concatenating the JS files directly, use coffee to preserve the source map -->\n    &lt;echo>Concatenating the JS&lt;/echo>\n    &lt;concat destfile=\"${build.libs}\">\n       &lt;filelist dir =\"${build.script.dir}\" files=\"lib/jquery.js,lib/knockout.js,lib/BigDecimal.js\" />\n\n        &lt;fileset dir=\"${build.script.dir}/lib\" includes=\"**/*.js\"/>\n    &lt;/concat>\n    &lt;apply executable=\"coffee\"  verbose=\"true\" force=\"true\" failonerror=\"true\" parallel=\"true\">\n      &lt;arg value=\"--compile\" />\n      &lt;arg value=\"--map\" />\n      &lt;arg value=\"--join\" />\n      &lt;arg value=\"${build.script.output}\" />\n      &lt;srcfile />\n      &lt;filelist dir =\"${src.script.dir}\" files=\"...\" />\n    &lt;/apply>\n  &lt;/target>\n\n  &lt;target name=\"documentation\" description=\"Generate Docco Documentation for coffee files\">\n    &lt;echo>Generating Documentation with Docco&lt;/echo>\n    &lt;apply executable=\"docco\" verbose=\"true\" force=\"true\" failonerror=\"true\">\n          &lt;srcfile />\n          &lt;fileset dir =\"${src.script.dir}\" >\n            &lt;include name=\"**/*.coffee\"/>\n          &lt;/fileset>\n      &lt;/apply>\n  &lt;/target>\n\n  &lt;target name=\"test\" description=\"Generate the JS for testing with Jasmine\">\n    &lt;!-- Ideally this would run a server side jasmine test, but that requires better dependency management than we have right now-->\n    &lt;echo>Generating the Test JS with jasmine&lt;/echo>\n    &lt;apply executable=\"coffee\"  verbose=\"true\" force=\"true\" failonerror=\"true\" parallel=\"true\">\n      &lt;arg value=\"--compile\" />\n      &lt;arg value=\"--join\" />\n      &lt;arg value=\"${test.output}\" />\n      &lt;srcfile />\n      &lt;fileset dir =\"${test.dir}\" >\n        &lt;include name=\"**/*.coffee\"/>\n      &lt;/fileset>\n    &lt;/apply>\n  &lt;/target>\n\n  &lt;target name=\"minify\" description=\"Minify the JS for Production\">\n    &lt;echo>Minifying the JS For Production with UglifyJS&lt;/echo>\n    &lt;apply executable=\"uglifyjs\" verbose=\"true\" force=\"true\" failonerror=\"true\">\n          &lt;srcfile />\n          &lt;arg value=\"--output\" />\n          &lt;arg value=\"${build.script.output}\" />\n          &lt;filelist  files =\"${build.script.output}\"/>\n      &lt;/apply>\n  &lt;/target>\n\n  &lt;target name= \"init\">\n    &lt;mkdir dir=\"${build.dir}\" />\n  &lt;/target>\n\n  &lt;target name=\"clean\">\n    &lt;delete dir=\"${build.dir}\" />\n  &lt;/target>\n\n&lt;/project></code></pre></div>\n<p><em>Update June 2014: Since writing this post, Javascript based build tools have continued to mature and grow.  These days I’d recommend <a href=\"http://gruntjs.com/\">Grunt</a> or <a href=\"http://gulpjs.com/\">Gulp</a> for your front end build script needs, though Ant is still a fine choice if you’re integrating your builds with a Java project, or have lots of experience with it.</em></p>\n<hr>\n<h3>Further Reading</h3>\n<ul>\n<li><a href=\"http://www.amazon.com/gp/product/1449327680/ref=as_li_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=1449327680&linkCode=as2&tag=productjavasc-20\">Maintainable JavaScript</a><img src=\"http://ir-na.amazon-adsystem.com/e/ir?t=productjavasc-20&amp;l=as2&amp;o=1&amp;a=1449327680\" width=\"1\" height=\"1\" border=\"0\" alt=\"\" style=\"border:none !important; margin:0px !important;\"> - This is a great little book for anyone writing Javascript applications in teams.  It has a great section on developing a Javascript build system with Ant</li>\n</ul>","fields":{"slug":"/2013/03/23/creating-a-build-system-for-a-coffeescript-project-with-ant"}}},{"node":{"frontmatter":{"readNext":null,"topics":["Code Quality","architecture"],"category":"software-productivity","key":null,"title":"How I Work:  Refactoring","description":"Describing the process that goes behind refactoring code","layout":"post","path":"/2013/02/03/how-i-work-refactoring","date":"2013-02-03T21:00:00+00:00","dontfeature":null,"isDraft":null},"html":"<p>I recently took the time to re-examine a section of code that I’ve worked on as part of a team for the last year.  Looking at it with fresh eyes I saw plenty of room for improvement.  The issues weren’t the result of one bad checkin or poor decision.  Instead they were the result of “death by a thousand cuts”, a series of small decisions made by different people that were individually justifiable but eventually resulted in brittle, hard to maintain code.</p>\n<p>Over the last few days I’ve been taking some time to refactor the code.  Doing so made me think about what questions I should be asking while refactoring code.  Here are a few of the things I look for when I’m working to clean up code:</p>\n<h4>Does each function do only one thing?</h4>\n<p>This has been the hardest bad habit for me to break.  I have a natural inclination when adding new functionality to try to toss it into a related function.  This seems great as first, but its how you go from a function that “removes special characters from a string”, to one that “removes extra characters from a string”, to one that “processes strings”, and finally to “the string function” that takes a string and returns a new output determined by a glob of unreadable code that nobody understands and everyone is scared to touch.</p>\n<p>Functions that perform only one purpose are easier to understand, easier to use, easier to test, and easier to port to new environments.  When functions start to perform multiple purposes it becomes harder to maintain <a href=\"http://en.wikipedia.org/wiki/Don&#x27;t_repeat_yourself\">DRY</a> principles.  If one function performs actions A&#x26;B, another performs B&#x26;C, and a 3rd one performs A&#x26;C, you have to duplicate each action twice, adding code bloat and opening up the risk of inconsistent changes across methods.</p>\n<h4>Does each object/concept have a consistent naming convention throughout the system?</h4>\n<p>One source of frustration I’ve had when debugging the code for my project has been the fact that different developers have started different naming conventions for objects within the code.  This results in a single object being called chartObj within function, chart within another, params in another place, and chartData in another instance.  Sometimes these different references even pop up within the same function.  This inconsistency makes it much harder for an unfamiliar developer to understand how the system functions.  This again can lead to duplicating information, if a developer modifying a function or class doesn’t realize they already have the information they need.</p>\n<h4>What assumptions have I made?</h4>\n<p>One thing that can easily add confusion within a system is making undocumented assumptions.  One common assumption thats made for javascript code is that it will always run in a browser, or have access to a specific library such as jQuery.  While some of these assumptions are necessary, its worthwhile documenting them in some way, either in the comments or through code checks that through exceptions if the assumptions are violated.</p>\n<p>This is important because requirements change.  The particular code that I’m working with was originally intended to run only in the browser, without any thought of server-side use.  When a requirement made it necessary to run it with PhantomJS, plenty of changes were needed.  This isn’t necessarily problematic, because this particular change was not likely when the original code was made, and the adaptation was not hard.  More problematic was the fact that developers not directly involved with the phantomJS work still were acting under the assumption that the code would run within a browser environment.</p>\n<p>These three questions are obviously not the only things that can be wrong in code, but in my experience they’re especially treacherous because they can come in slowly and then make every future change harder.</p>\n<hr>\n<h3>Further Reading</h3>\n<ul>\n<li><a href=\"http://www.codinghorror.com/blog/2007/03/curlys-law-do-one-thing.html\">Coding Horror: Curly’s Law</a> a readable explanation of DRY principles</li>\n<li><a href=\"http://refactoring.com/\">Refactoring.com</a>- A nice collection of resources on refactoring by Martin Fowler, who also has written a well regarded <a href=\"http://www.amazon.com/gp/product/0201485672/ref=as_li_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=0201485672&linkCode=as2&tag=productjavasc-20\">book</a><img src=\"http://ir-na.amazon-adsystem.com/e/ir?t=productjavasc-20&amp;l=as2&amp;o=1&amp;a=0201485672\" width=\"1\" height=\"1\" border=\"0\" alt=\"\" style=\"border:none !important; margin:0px !important;\"></li>\n</ul>\n<p>on refactoring.</p>","fields":{"slug":"/2013/02/03/how-i-work-refactoring"}}},{"node":{"frontmatter":{"readNext":"jest-first,saving-time-jest,mobx-first","topics":["Jest","Code Quality","testing"],"category":"tools","key":"jest-git","title":"Running Jest Tests Before Each Git Commit","description":"A simple setup to run your Jest tests before every commit","layout":"post","path":"/2017/02/26/running-jest-tests-before-each-git-commit/","date":"2017-02-26T23:00:00+00:00","dontfeature":null,"isDraft":null},"html":"<p>My main work project makes heavy use of <a href=\"https://facebook.github.io/jest/\">Jest</a> to test our JavaScript code.  For a while now I’ve wanted to set up a way to run tests every time I run a commit.  I knew that git provides <a href=\"https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks\">hooks</a> that allow scripting actions to occur before or after any commit or push, and in fact we were already using a <code class=\"language-text\">pre-commit</code> hook script to lint our code with <a href=\"http://eslint.org/\">ESLint</a>.  But it was non-obvious how to make that work well with Jest testing.  I eventually figured out a setup that worked, and the found a better way to do both the Jest and ESLint testing.  Since it took me a while to work through, I thought I’d share it here and save the rest of you some time.</p>\n<h3>What didn’t work</h3>\n<p>A naive approach to this problem would be to set up a pre-commit hook that simply ran <code class=\"language-text\">jest</code> to run all tests. The problem is that running our full test suite currently takes between 10 and 20 seconds to run all tests and that time is increasing as we grow our test suite.  Adding that overhead to every commit would cost my team a lot of time, and would be especially inefficient since the repo contains plenty non-JavaScript code that doesn’t require tests to be run when updated.</p>\n<p>For our ESLint hook, we queried git to get a list of staged files, and then ran eslint against each one of them individually, displaying a pass/fail message.  That looked something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">STAGED_FILES</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">git</span> <span class=\"token function\">diff</span> --cached --name-only --diff-filter<span class=\"token operator\">=</span>ACM <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"js$\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$STAGED_FILES</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token assign-left variable\">PASS</span><span class=\"token operator\">=</span>true\n\n<span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">FILE</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$STAGED_FILES</span>\n<span class=\"token keyword\">do</span>\n    eslint --quiet <span class=\"token string\">\"<span class=\"token variable\">$FILE</span>\"</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$?</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\t\">\\t</span><span class=\"token entity\" title=\"\\033\">\\033</span>[32mESLint Passed: <span class=\"token variable\">$FILE</span><span class=\"token entity\" title=\"\\033\">\\033</span>[0m\"</span>\n    <span class=\"token keyword\">else</span>\n        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\t\">\\t</span><span class=\"token entity\" title=\"\\033\">\\033</span>[41mESLint Failed: <span class=\"token variable\">$FILE</span><span class=\"token entity\" title=\"\\033\">\\033</span>[0m\"</span>\n        <span class=\"token assign-left variable\">PASS</span><span class=\"token operator\">=</span>false\n    <span class=\"token keyword\">fi</span>\n<span class=\"token keyword\">done</span></code></pre></div>\n<p>This works great for ESLint, but doesn’t work out of the box for Jest, because I don’t want Jest to run the files that changed, I want them to run any tests that changed AND any tests that might have been broken because of that.</p>\n<p>Jest has a wonderful command line flag <code class=\"language-text\">jest --onlyChanged</code>/<code class=\"language-text\">jest -o</code> that runs only the tests related to files that have been changed according to git.  It is extremely helpful since it is smart enough to read the dependency structure for the project and run all tests that might be changed from updating a source file. It also has a <code class=\"language-text\">--lastCommit</code> option that does the same thing for files that were in the previous commit.  Unfortunately, these options aren’t helpful at the point of committing, since <code class=\"language-text\">onlyChanged</code> does not look at files that have been staged for commit, and we haven’t actually made a commit yet for <code class=\"language-text\">lastCommit</code> to read.</p>\n<h3>What Did Work</h3>\n<p>Fortunately Jest has a lower level command that uses the same logic as <code class=\"language-text\">onlyChanged</code> and <code class=\"language-text\">lastCommit</code>.  <code class=\"language-text\">--findRelatedTests</code> is a flag that tells Jest to run any tests related to the files passed to it instead of trying to run those files as tests as it would normally do.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 570px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/9350cbcea06e8f1f423335d94d84ac98/065e2/jest-related-tests.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 81.81818181818181%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACTElEQVQ4y42T7VKbQBiFublOZ3Sm3kZ7I15KW6v/rHGm7Y9OPzRRoyYECAF2w1cCAQILkXwZT2c3TmyNzeTHmeVlmcN5931W6vfO0SZ1UJeAulSsrk9AHIo0tjAtKBali0Xp4GG8XHnNn1+SdHi6h6PTPbBEQxJ2YBp12OQWnt2E78jIIh2YeMDkyXSTpIOTXXyq7IDFCkJfRaPxC5pahapUYXauYOiX8OwGRkPzr4T/N5Y+ft7FwckO0kiGZ8u4qn+HolTRks/QJTfouTIGPQVjRrYz/PLjHb7+fIu7TEfJKPKkgyTQ0HdlsRZDE/ORLdrequU4UMBiHelAFynSSEfUV4URizvIEwP3j6metMFQ1y6gty+EYZkRUOsallEXRqPUQhZ11ia8SZLbvUESKJjkBLOCIgk1THMKzLzldKfeyuxh/GTIn0U9/vcn0nTUx+QuRJHZQiPmrMQZnOR0abZq1dkoySIV1JVvsBwOdhfEIbA9AsvmaU0EEUWQ9TDIfKE098Byb1VHj0qYjyz3IB1W3oArjVoIPBXNxm9oag1trQab3sJ3ZeRDC/PSFbp/1PwF8ffS++PX+HD8ClncQt9TBId8SKpyLjjkDIZ+C8XQAMZbtFy73sflzT5KZqBITIFMHGiIA1UgxIfE8ZkV3a0mLcV9A1lEkIRtcb1CX4HvNJHFHSEWGyvGFms8Omu3R1KVM7S1qkjBJ0rMa3F2HPIxo4LFTTfk+Z4U9VSRjJtNi64AuWREIMNrbsxTDgdtsfJj4N9w8Pne4lnCP7Q2oT5+UchTAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"an example of findRelatedTests running against the redux repo\" title=\"an example of findRelatedTests running against the redux repo\" src=\"/static/9350cbcea06e8f1f423335d94d84ac98/432e7/jest-related-tests.png\" srcset=\"/static/9350cbcea06e8f1f423335d94d84ac98/a6b04/jest-related-tests.png 143w,\n/static/9350cbcea06e8f1f423335d94d84ac98/0e2fe/jest-related-tests.png 285w,\n/static/9350cbcea06e8f1f423335d94d84ac98/432e7/jest-related-tests.png 570w,\n/static/9350cbcea06e8f1f423335d94d84ac98/065e2/jest-related-tests.png 577w\" sizes=\"(max-width: 570px) 100vw, 570px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>This is a perfect fit for a pre-commit hook.  I was able to integrate it into my existing script like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">jest --bail --findRelatedTests <span class=\"token variable\">$STAGED_FILES</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$?</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\t\">\\t</span><span class=\"token entity\" title=\"\\033\">\\033</span>[32mJest Tests Passed<span class=\"token entity\" title=\"\\033\">\\033</span>[0m\"</span>\n<span class=\"token keyword\">else</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\t\">\\t</span><span class=\"token entity\" title=\"\\033\">\\033</span>[41mJest Tests Failed<span class=\"token entity\" title=\"\\033\">\\033</span>[0m\"</span>\n    <span class=\"token assign-left variable\">PASS</span><span class=\"token operator\">=</span>false\n<span class=\"token keyword\">fi</span></code></pre></div>\n<p><code class=\"language-text\">$STAGED_FILES</code> is re-used from the eslint portion of the script, and is just a space delimited list of files that are being committed.  The <code class=\"language-text\">--bail</code> option simply stops running tests as soon as one has failed.  Including that is optional, you won’t see all the tests that have failed, but the failure will happen faster and you’ll be able to decide how to proceed, including possibly running the full test script on your own.</p>\n<p>Those lines (along with some sanity checks for the existence of Jest and error handling when PASS is set to false) are enough to get a workable commit hook going, but they’re not ideal.  pre-commit hooks aren’t persisted by git, so each user has to install the hook script individually, and any updates aren’t shared automatically.  Plus I’m inefficiently passing all staged files to eslint and Jest regardless of whether they’re JavaScript that those tools are actually meant to work on.  My ESLint code was also written before ESLint developed robust <code class=\"language-text\">--fix</code> capabilities, and doesn’t try to fix the errors it is capable of fixing.  Finally, while this is just poor coding and not an inherent limitation of my other method, I’m using globally installed versions of Jest and ESLint instead of scoping them to my project.</p>\n<h3>Making it better</h3>\n<p>Fortunately I’d discovered a better solution the other day while working on something else.  There is an npm package for making this process easier, <a href=\"https://github.com/okonet/lint-staged\">lint-staged</a>.  Lint staged abstracts away the boilerplate of getting the staged files, and makes it easy to run local node executables against specific sets of files.  I was able to replace my whole pre-commit script and address all of the problems mentioned above with only a few lines in my package.json:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"lint-staged\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"lint-staged\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"lint-staged\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"*.js\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"eslint --fix\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"git add\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"jest --bail --findRelatedTests\"</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"devDependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"eslint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.16.1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"jest\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"19.0.1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"lint-staged\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.3.1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">lint-staged</code> now handles making sure that I’m only running checks against JavaScript files, lets eslint autofix and stage any files that it can fix, and uses the local versions of jest and eslint.  It also adds a nice pretty interface for the results:</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 570px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/07049d14abcd3c0065c9779b76d22045/65654/lint-staged-errors.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 35.66433566433567%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABBklEQVQoz3WR6W7DIBCEef/Hi6zUwfiOcvgAbIzPtFMtsa00an58WhBod2eGyVLgVoSwTYyxjWGkgJEBrBLQxWm9C3RKoNcRFpviZ8jx3WeuvsNszaEKH50UmEyCuUvc54dNMZsES5c66E7NtkZUN/40HGSA69mDrrjbgJhMjIfNgDH/d4v3hq+wSXL0bYyhiWBViKbiaOsAVofOgnF9o9o30X7+NIiNOnRSpjZ2LF2yy9ssIMkkn3D/XqyY95o4VUxVHOZ6RJMfIEuOS+7hfjmiWCE7aOO25tAl8QyKrOlU6MIiZWbNgC3Sx3z3sFRfWOQJY+VjuB0wa+Embps8g8o+prtJ/gXMYBFoDE41ZQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"pretty lint-staged output\" title=\"pretty lint-staged output\" src=\"/static/07049d14abcd3c0065c9779b76d22045/432e7/lint-staged-errors.png\" srcset=\"/static/07049d14abcd3c0065c9779b76d22045/a6b04/lint-staged-errors.png 143w,\n/static/07049d14abcd3c0065c9779b76d22045/0e2fe/lint-staged-errors.png 285w,\n/static/07049d14abcd3c0065c9779b76d22045/432e7/lint-staged-errors.png 570w,\n/static/07049d14abcd3c0065c9779b76d22045/77800/lint-staged-errors.png 855w,\n/static/07049d14abcd3c0065c9779b76d22045/65654/lint-staged-errors.png 872w\" sizes=\"(max-width: 570px) 100vw, 570px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p><code class=\"language-text\">lint-staged</code> docs recommend using an npm based hooks manager like <a href=\"https://github.com/observing/pre-commit\">pre-commit</a> for running the scripts, but due to some quirks in my setup (node_modules is symlinked, and I sometimes want to run these commands inside a docker container), I found it easier to maintain a custom pre-commit script and just replace the previous logic with <code class=\"language-text\">npm run lint-staged</code>.  Either way, all of the actual logic is now checked into the repository and shared between all users.  The only manual step is adding the call to a pre-commit hook or (if you’re using a helper lib) running npm install.</p>\n<h3>More Resources</h3>\n<ul>\n<li>This maybe merits a future post on its own, but if you’re interested in automating away your code style maintenance look at combining <a href=\"https://github.com/prettier/prettier\">prettier</a> (and possibly  <a href=\"https://github.com/not-an-aardvark/eslint-plugin-prettier\">eslint-plugin-prettier</a>) with the pre-commit hooks from above.  Prettier will guarantee that your code follows a consistent style, and because it handles maximum line lengths, is much more robust than ESLint on its own.  Using its ESLint plugin within my editor and on pre-commit hooks has pretty much eliminated me manually fixing code style problems.</li>\n</ul>","fields":{"slug":"/2017/02/26/running-jest-tests-before-each-git-commit/"}}}],"topic":"Code Quality"}},
    "staticQueryHashes": []}