<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=yyxgnp97qG"/><link rel="icon" type="image/png" href="/favicon-32x32.png?v=yyxgnp97qG" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png?v=yyxgnp97qG" sizes="16x16"/><link rel="manifest" href="/manifest.json"/><link rel="mask-icon" href="/safari-pinned-tab.svg?v=yyxgnp97qG" color="#57a3e8"/><link rel="shortcut icon" href="/favicon.ico?v=yyxgnp97qG"/><meta name="theme-color" content="#ffffff"/><script type="text/javascript" src="//use.typekit.net/msd6bqv.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script><title data-react-helmet="true">Digging Into Knockout Builds | benmccormick.org</title><meta data-react-helmet="true" name="description" content="An in depth look at how KnockoutJS is organized"/><meta data-react-helmet="true" name="keywords" content=""/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:site" content="@benmccormickorg"/><meta data-react-helmet="true" name="twitter:creator" content="@ben336"/><meta data-react-helmet="true" name="twitter:title" content="Digging Into Knockout Builds"/><meta data-react-helmet="true" name="twitter:description" content="An in depth look at how KnockoutJS is organized"/><meta data-react-helmet="true" name="twitter:image" content="http://benmccormick.org/logo.png"/><script data-react-helmet="true" type="application/ld+json">{
                "@context": "http://schema.org"
                "@type": "BlogPosting",
                "headline": "Digging Into Knockout Builds",
                "genre": "Software Development",
                "keywords": "",
                "url": "http://benmccormick.org/2014/01/06/digging-into-knockout-builds/",
                "image": "http://benmccormick.org/logo.png",
                "datePublished": "2014-01-6",
                "description": "An in depth look at how KnockoutJS is organized",
                "articleBody": "<p>There’s a lot you can learn by looking through other people’s code.  This is especially true when you’re looking at widely used open-source libraries, where you can see how people have solved real problems with code that has been battle-tested and debated.</p>
<p>In this spirit of code literacy, I spent some time this past weekend to look through the source code for <a href=\"http://knockoutjs.com/\">KnockoutJS</a>.  Knockout is a MVVM library in Javascript designed to make 2 way declarative bindings easy.  I’m wanted to write a bit about what I saw in Knockout’s structure and build process.</p>
<h3>Intro</h3>
<p>Some of the first decisions a developer has to make when starting a new javascript project revolve around project structure and build processes.  They need to decide how they’ll handle things like testing and minification.  For a library like Knockout, developers also need to figure out how to make sure that they don’t expose any internal logic to the global scope.  This post takes a look at how Knockout deals with these challenges.  You can follow along by getting <a href=\"https://github.com/knockout/knockout\">the source</a> off of Github.</p>
<h3>Project Structure</h3>
<p>Knockout is organized with a traditional <code>src</code>,<code>spec</code>,<code>build</code> structure, with the main src code in the src directory, <a href=\"http://pivotal.github.io/jasmine/\">Jasmine</a> tests in the spec directory, and build-related files in the build directory.  The src directory is fairly flat, with directories for bindings, templating and subscribables.  The spec directory does not mirror it exactly.  The spec files are organized around functional categories at the root of the source files, with a separate directory holding tests for the default bindings.   The build direction contains several files related to the build process, which I’ll discuss below.  In the root directory there are dotfiles for <a href=\"https://npmjs.org/\">NPM</a>, <a href=\"http://git-scm.com/\">git</a>, and <a href=\"http://about.travis-ci.org/\">TravisCI</a>, a package.json file, and the gruntfile.</p>
<h3>Grunt</h3>
<p>Knockout’s build process is automated using Grunt, an automation tool built on <a href=\"xmpux.cisco.com\">NodeJS</a>.  Knockout’s gruntfile weighs in at a very readable 150 lines of code, and only defines one task.  That default task looks like this:</p>
<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">//Grunt Default Task</span>
grunt.registerTask(<span class=\"hljs-string\">'default'</span>, [<span class=\"hljs-string\">'clean'</span>, <span class=\"hljs-string\">'checktrailingspaces'</span>, <span class=\"hljs-string\">'build'</span>, <span class=\"hljs-string\">'test'</span>]);
</code></pre>
<p>So when you build knockout you’re executing 4 steps.</p>
<h4>Clean</h4>
<p>This deletes the knockout-latest.debug.js and knockout-latest.min.js files from the <code>build/output</code> directory</p>
<h4>Check Trailing Spaces</h4>
<p>This checks source files for trailing spaces and throws an error if they exist, ending the build.</p>
<h4>Build</h4>
<p>More detail on this below.</p>
<h4>Test</h4>
<p>Test spawns a child process which calls 2 scripts: ‘spec/runner.phantom.js’ and ‘spec/runner.node.js’.  The script runs asynchronously in the background, with the results being passed to standard out through a callback.</p>
<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">//Grunt Test Task</span>
grunt.initConfig({
    <span class=\"hljs-comment\">//...</span>
    test: {
        <span class=\"hljs-attr\">phantomjs</span>: <span class=\"hljs-string\">'spec/runner.phantom.js'</span>,
        <span class=\"hljs-attr\">node</span>: <span class=\"hljs-string\">'spec/runner.node.js'</span>
    }
});

grunt.registerMultiTask(<span class=\"hljs-string\">'test'</span>, <span class=\"hljs-string\">'Run tests'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>{
    <span class=\"hljs-keyword\">var</span> done = <span class=\"hljs-keyword\">this</span>.async();
    grunt.util.spawn({ <span class=\"hljs-attr\">cmd</span>: <span class=\"hljs-keyword\">this</span>.target, <span class=\"hljs-attr\">args</span>: [<span class=\"hljs-keyword\">this</span>.data] },
        <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error, result, code</span>) </span>{
            <span class=\"hljs-keyword\">if</span> (code === <span class=\"hljs-number\">127</span> <span class=\"hljs-comment\">/*not found*/</span>) {
                grunt.verbose.error(result.stderr);
                <span class=\"hljs-comment\">// ignore this error</span>
                done(<span class=\"hljs-literal\">true</span>);
            } <span class=\"hljs-keyword\">else</span> {
                grunt.log.writeln(result.stdout);
                <span class=\"hljs-keyword\">if</span> (error)
                    grunt.log.error(result.stderr);
                done(!error);
            }
        }
    );
});
</code></pre>
<p>Overall a few things stand out about Knockout’s gruntfile.</p>
<ol>
<li>
<p>It’s written with no dependencies other than the base grunt-cli package, which is specifically called out in package.json to be run locally.  This is in sharp contrast to most Grunt-based projects I’ve seen, which assume a global install of Grunt and then make heavy use of the Grunt plugin ecosystem.</p>
</li>
<li>
<p>The only code consistency check is flagging trailing whitespace. Rather than enforce styling with a tool like jsHint, the build process only protects the integrity of the diffs with the whitespace check. This is probably a consequence of the plugin-free build file set up.  Overall the build philosophy seems to aim to keep things as simple as possible.</p>
</li>
</ol>
<h3>The Build Process</h3>
<p>So what happens with the build command?  When it’s executed the build command runs a task which creates 2 files, knockout-latest.debug.js and knockout-latest.min. Each of them contain the same content, with the debug version wrapped in an <a href=\"http://benalman.com/news/2010/11/immediately-invoked-function-expression/\">IIFE</a>, and the minified version run through Google closure compiler.</p>
<p>The content is pulled together with the <code>getCombinedSources</code> function:</p>
<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">//Grunt Build Task</span>
<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getCombinedSources</span>(<span class=\"hljs-params\"></span>) </span>{
    <span class=\"hljs-keyword\">var</span> fragments = grunt.config(<span class=\"hljs-string\">'fragments'</span>),
        sourceFilenames = [
            fragments + <span class=\"hljs-string\">'extern-pre.js'</span>,
            fragments + <span class=\"hljs-string\">'amd-pre.js'</span>,
            getReferencedSources(fragments + <span class=\"hljs-string\">'source-references.js'</span>),
            fragments + <span class=\"hljs-string\">'amd-post.js'</span>,
            fragments + <span class=\"hljs-string\">'extern-post.js'</span>
        ],
        flattenedSourceFilenames = <span class=\"hljs-built_in\">Array</span>.prototype.concat.apply([], sourceFilenames),
        combinedSources = flattenedSourceFilenames.map(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">filename</span>) </span>{
            <span class=\"hljs-keyword\">return</span> grunt.file.read(<span class=\"hljs-string\">'./'</span> + filename);
        }).join(<span class=\"hljs-string\">''</span>);

    <span class=\"hljs-keyword\">return</span> combinedSources.replace(<span class=\"hljs-string\">'##VERSION##'</span>, grunt.config(<span class=\"hljs-string\">'pkg.version'</span>));
}
</code></pre>
<p>So this takes each of the files returned by the getReferencedSources function, and wraps them with 2 more files on each side.  Lets look at the wrapper files first.</p>
<p>extern-pre.js sets up an IIFE and defines several global values within the local scope.  This is done in order to protect against any reuse of these names in the local scope where knockout is loaded.</p>
<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">//extern-pre.js</span>
(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">undefined</span>)</span>{
    <span class=\"hljs-comment\">// (0, eval)('this') is a robust way of getting a reference to the global object</span>
    <span class=\"hljs-comment\">// For details, see http://stackoverflow.com/questions/14119988/return-this-0-evalthis/14120023#14120023</span>
    <span class=\"hljs-keyword\">var</span> <span class=\"hljs-built_in\">window</span> = <span class=\"hljs-keyword\">this</span> || (<span class=\"hljs-number\">0</span>, <span class=\"hljs-built_in\">eval</span>)(<span class=\"hljs-string\">'this'</span>),
        <span class=\"hljs-built_in\">document</span> = <span class=\"hljs-built_in\">window</span>[<span class=\"hljs-string\">'document'</span>],
        navigator = <span class=\"hljs-built_in\">window</span>[<span class=\"hljs-string\">'navigator'</span>],
        jQuery = <span class=\"hljs-built_in\">window</span>[<span class=\"hljs-string\">\"jQuery\"</span>],
        <span class=\"hljs-built_in\">JSON</span> = <span class=\"hljs-built_in\">window</span>[<span class=\"hljs-string\">\"JSON\"</span>];
</code></pre>
<p>amd-pre.js determines the type of module system in use (if any) and passes the correct object into the inner scope as koExports.</p>
<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">//amd-pre.js</span>
(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">factory</span>) </span>{
  <span class=\"hljs-comment\">// Support three module loading scenarios</span>
  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> <span class=\"hljs-built_in\">require</span> === <span class=\"hljs-string\">'function'</span> &amp;&amp; <span class=\"hljs-keyword\">typeof</span> exports === <span class=\"hljs-string\">'object'</span> &amp;&amp; <span class=\"hljs-keyword\">typeof</span> <span class=\"hljs-built_in\">module</span> === <span class=\"hljs-string\">'object'</span>) {
    <span class=\"hljs-comment\">// [1] CommonJS/Node.js</span>
    <span class=\"hljs-keyword\">var</span> target = <span class=\"hljs-built_in\">module</span>[<span class=\"hljs-string\">'exports'</span>] || exports; <span class=\"hljs-comment\">//module.exports is for Node.js</span>
    factory(target);
  } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> define === <span class=\"hljs-string\">'function'</span> &amp;&amp; define[<span class=\"hljs-string\">'amd'</span>]) {
    <span class=\"hljs-comment\">// [2] AMD anonymous module</span>
    define([<span class=\"hljs-string\">'exports'</span>], factory);
  } <span class=\"hljs-keyword\">else</span> {
    <span class=\"hljs-comment\">// [3] No module loader (plain &lt;script&gt; tag) - put directly in global namespace</span>
    factory(<span class=\"hljs-built_in\">window</span>[<span class=\"hljs-string\">'ko'</span>] = {});
  }
})
</code></pre>
<p>The *-post.js files simply close these function statements.</p>
<p>So in the end we’re left with an IIFE that wraps all of the content and defines global variables within the scope, and then executes a second IIFE which determines the module format in use and executes the inner factory function accordingly.  The factory function is made up of the various files in the src directory, concatenated together in the order specified in build/fragments/source-references.js.</p>
<h3>Initializing the library</h3>
<p>The first few files loaded into the inner function are short files designed to provide a base for the library.</p>
<p>namespace.js sets up the ko object that is referenced internally in the file.</p>
<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">//namespace.js</span>
<span class=\"hljs-comment\">// Internally, all KO objects are attached to koExports (even the non-exported ones whose names will be minified by the closure compiler).</span>
<span class=\"hljs-comment\">// In the future, the following \"ko\" variable may be made distinct from \"koExports\" so that private objects are not externally reachable.</span>
<span class=\"hljs-keyword\">var</span> ko = <span class=\"hljs-keyword\">typeof</span> koExports !== <span class=\"hljs-string\">'undefined'</span> ? koExports : {};
</code></pre>
<p>google-closure-compiler-utils.js defines two helper functions, exportSymbol and exportProperty which allow for greater minimization of the internal ko library while maintaining a consistent external api.  These functions are used everywhere throughout the library for defining externally facing function and property names.</p>
<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">//google-closure-compiler-utils.js</span>

<span class=\"hljs-comment\">// Google Closure Compiler helpers (used only to make the minified file smaller)</span>
ko.exportSymbol = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">koPath, object</span>) </span>{
    <span class=\"hljs-keyword\">var</span> tokens = koPath.split(<span class=\"hljs-string\">\".\"</span>);

    <span class=\"hljs-comment\">// In the future, \"ko\" may become distinct from \"koExports\" (so that non-exported objects are not reachable)</span>
    <span class=\"hljs-comment\">// At that point, \"target\" would be set to: (typeof koExports !== \"undefined\" ? koExports : ko)</span>
    <span class=\"hljs-keyword\">var</span> target = ko;

    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; tokens.length - <span class=\"hljs-number\">1</span>; i++)
        target = target[tokens[i]];
    target[tokens[tokens.length - <span class=\"hljs-number\">1</span>]] = object;
};
ko.exportProperty = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">owner, publicName, object</span>) </span>{
  owner[publicName] = object;
};
</code></pre>
<p>Finally version.js sets up a placeholder for ko.version, which is then replaced with the version number in Package.json as part of the grunt build task.</p>
<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">//version.js</span>
ko.version = <span class=\"hljs-string\">\"##VERSION##\"</span>;

ko.exportSymbol(<span class=\"hljs-string\">'version'</span>, ko.version);
</code></pre>
<h3>Conclusion</h3>
<p>There are a few interesting things we can note from Knockout’s build approach.</p>
<h4>Using IIFE’s to isolate local scope is a practical and important technique for library design</h4>
<p>If you’ve been counting, the debug version of the library is wrapped in 3 different levels of IIFEs before any code exposing external functionality is actually included.  This allows Knockout to provide several layers of data protection and abstraction, making sure that it is referencing the correct global variables and preventing scope leaks.</p>
<h4>Its relatively straightforward to support module formats even if your library doesn’t use them internally</h4>
<p>Take a look again at amd-pre.js.  Its 15 lines of code to support AMD loaders, CommonJS loaders and normal script tag loading.  Knockout doesn’t use a modern “module solution” approach to code organization.  Instead it uses a more traditional namespacing approach wrapped in IIFEs.  But it still plays well with others nicely.  It’s hard to see how this type of effort wouldn’t be worth it for library designers.</p>
",
                  "author": {
                    "@type": "Person",
                    "name": "Ben McCormick"
                    "email": "mailto:ben@benmccormick.org",
                    "image": "/profile_pic.jpg",
                    "jobTitle": "Software Engineer",
                    "alumniOf": "Duke",
                    "birthPlace": "Pittsburgh, PA",
                    "gender": "male",
                    "url": "http://benmccormick.org",
              	    "sameAs" : [
                      "https://www.linkedin.com/in/benmccormick",
                      "http://twitter.com/ben336",
                    ]
                 }
              }</script><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:131.25%/1.4em brandon-grotesque,Brandon Grotesque,Helvetica Neue,Helvetica,Arial,Lucida Sans,Geneva,Verdana,sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:brandon-grotesque,Brandon Grotesque,Helvetica Neue,Helvetica,Arial,Lucida Sans,Geneva,Verdana,sans-serif;font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:brandon-grotesque,Brandon Grotesque,Helvetica Neue,Helvetica,Arial,Lucida Sans,Geneva,Verdana,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.5rem;line-height:2.1rem;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:brandon-grotesque,Brandon Grotesque,Helvetica Neue,Helvetica,Arial,Lucida Sans,Geneva,Verdana,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.27542rem;line-height:2.1rem;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:brandon-grotesque,Brandon Grotesque,Helvetica Neue,Helvetica,Arial,Lucida Sans,Geneva,Verdana,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.17608rem;line-height:1.4rem;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:brandon-grotesque,Brandon Grotesque,Helvetica Neue,Helvetica,Arial,Lucida Sans,Geneva,Verdana,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.4rem;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:brandon-grotesque,Brandon Grotesque,Helvetica Neue,Helvetica,Arial,Lucida Sans,Geneva,Verdana,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.92211rem;line-height:1.4rem;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;color:inherit;font-family:brandon-grotesque,Brandon Grotesque,Helvetica Neue,Helvetica,Arial,Lucida Sans,Geneva,Verdana,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.88547rem;line-height:1.4rem;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}ul{margin-left:1.4rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.4rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;font-size:0.85rem;line-height:1.1;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.05rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;font-size:1rem;line-height:1.4rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}blockquote{margin-left:1.4rem;margin-right:1.4rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.05rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.05rem;}b{font-weight:bold;}strong{font-weight:bold;}dt{font-weight:bold;}th{font-weight:bold;}li{margin-bottom:calc(1.05rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.4rem;margin-bottom:calc(1.05rem / 2);margin-top:calc(1.05rem / 2);}li > ul{margin-left:1.4rem;margin-bottom:calc(1.05rem / 2);margin-top:calc(1.05rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.05rem / 2);}code{font-size:0.85rem;line-height:1.4rem;}kbd{font-size:0.85rem;line-height:1.4rem;}samp{font-size:0.85rem;line-height:1.4rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:tnum;-moz-font-feature-settings:tnum;-ms-font-feature-settings:tnum;-webkit-font-feature-settings:tnum;padding-left:0.93333rem;padding-right:0.93333rem;padding-top:0.7rem;padding-bottom:calc(0.7rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}tt,code{background-color:hsla(0,0%,0%,0.04);border-radius:3px;font-family:"SFMono-Regular", Consolas,"Roboto Mono","Droid Sans Mono","Liberation Mono",Menlo,Courier,monospace;padding:0;padding-top:0.2em;padding-bottom:0.2em;font-size:65%;}pre code{background:none;line-height:1.42;}code:before,code:after,tt:before,tt:after{letter-spacing:-0.2em;content:" ";}pre code:before,pre code:after,pre tt:before,pre tt:after{content:"";}h1,h2,h3,h4,h5,h6{line-height:1.1;}@media only screen and (max-width:480px){html{font-size:112.5%;}}</style><style>.header-link{color:hsla(0,0%,39%,.7)}.header-link:hover{color:#e2777a}#carbonads{height:100px;font-size:14px;width:300px;position:relative;background:#f0f0f0}.carbon-wrap{height:100px;display:-ms-flexbox;display:flex}.carbon-text{padding:5px 10px;max-height:80px;display:inline-block;overflow:hidden;line-height:1.3}.carbon-poweredby{color:hsla(0,0%,39%,.7);position:absolute;right:5px;bottom:0}@media (max-width:600px){#carbonads,.no-mobile{display:none}.subscribe-block{padding-right:0;padding:0 10px}.subscribe-block,.subscribe-block .mc-field-group{width:100%!important}.subscribe-block .mc-field-group input{width:100%!important;font-size:.8em;height:2.4em}.up-next-block{width:100%!important;padding:0 10px}}@media (max-width:321px){html{font-size:100%!important}}.subscribe-container{display:-ms-flexbox;display:flex;-ms-flex-pack:justify;justify-content:space-between;-ms-flex-wrap:wrap;flex-wrap:wrap}.subscribe-block{width:400px;padding-right:30px;overflow:hidden}.subscribe-block #mc_embed_signup form{margin-bottom:20px}.up-next-block{width:300px}.subscribe-button{color:#fff;background:#57a3e8;border-radius:4px;border:0;padding:5px 10px;margin:20px 0;cursor:pointer}.rss{padding-bottom:10px}.rss a{display:-ms-flexbox;display:flex}.rss-icon{display:block;width:17px;margin-right:.5em;height:50px}.rss-icon *{fill:#e2777a}.twitter-item{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;margin-bottom:15px}.twitter-item iframe{margin:0 0 0 10px}.hljs,.markdown pre{display:block;background:#fdf6e3;color:#657b83}.hljs{overflow-x:auto;padding:.5em}.hljs-comment,.hljs-quote{color:#93a1a1}.hljs-addition,.hljs-keyword,.hljs-selector-tag{color:#859900}.hljs-doctag,.hljs-literal,.hljs-meta .hljs-meta-string,.hljs-number,.hljs-regexp,.hljs-string{color:#2aa198}.hljs-name,.hljs-section,.hljs-selector-class,.hljs-selector-id,.hljs-title{color:#268bd2}.hljs-attr,.hljs-attribute,.hljs-class .hljs-title,.hljs-template-variable,.hljs-type,.hljs-variable{color:#b58900}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-meta .hljs-keyword,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol{color:#cb4b16}.hljs-built_in,.hljs-deletion{color:#dc322f}.hljs-formula{background:#eee8d5}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}a{color:#e2777a;text-decoration:none}blockquote{border-left:5px solid #57a3e8;font-style:italic;background:#eee;font-weight:400;font-size:.9rem;padding:10px 20px;margin:0 0 30px -25px}blockquote p{margin-bottom:.667em}h2,h3{color:#57a3e8}.explanation{padding:10px;background:#eee;border-radius:10px;margin:20px auto;font-size:.85em}.footnote p{display:inline-block;margin-bottom:0}.article-body .reading-img img{width:150px;float:right;margin:0 10px 20px}.article-body img{max-height:200px;display:block;margin:40px auto 20px}.article-body img.full-width{max-height:none}.article-body img.half-width{max-height:none;width:50%}.bordered-img{border:3px solid #57a3e8}.mc-field-group{width:400px;display:-ms-flexbox;display:flex;-ms-flex-direction:row;flex-direction:row;-ms-flex-pack:start;justify-content:flex-start;-ms-flex-align:center;align-items:center;padding:8px 0}.mc-field-group input{border-radius:3px;max-width:350px;width:80vw;border:1px solid #ccc;margin-right:10px;height:30px}.mc-field-group label{font-size:.9em;font-weight:600}#mc-embedded-subscribe{color:#fff;background:#57a3e8;border-radius:4px;border:0;padding:0 10px;margin:10px 0;cursor:pointer;width:40vw}#mc-embedded-subscribe:hover{background:#3e8acf}.twitter-row{display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap}.twitter-row>div{padding-right:20px;min-width:300px}.category-icon-wrapper{color:rgba(87,163,232,.5)}.category-icon{display:inline-block;width:.75em;margin-right:.5em}.category-icon *{fill:#57a3e8;fill:rgba(87,163,232,.5)}.category-icon>i{height:30px}</style></head><body class="landing-page" style="background:#FCFCFC;padding:0 10px;"><div id="react-mount"><div style="max-width:33.6rem;margin-left:auto;margin-right:auto;padding:2.1rem 1.05rem;" data-reactroot="" data-reactid="1" data-react-checksum="-1852450590"><div style="display:flex;padding-bottom:0.5rem;margin-bottom:0.5rem;" data-reactid="2"><div style="flex-grow:3;display:flex;flex-direction:column;justify-content:space-around;" data-reactid="3"><h3 style="margin:0;padding-bottom:0;" data-reactid="4"><a style="box-shadow:none;text-decoration:none;color:inherit;" name="title" href="/" data-reactid="5">benmccormick.org</a></h3><div style="color:rgba(100,100,100, 0.7);" data-reactid="6"><a class="header-link" href="/subscribe/" data-reactid="7">Subscribe</a><span style="padding:0 0.33rem;" data-reactid="8">•</span><a class="header-link" href="/archive/" data-reactid="9">Archive</a><span style="padding:0 0.33rem;" data-reactid="10">•</span><a class="header-link" href="http://twitter.com/ben336" data-reactid="11">Twitter</a><span style="padding:0 0.33rem;" data-reactid="12">•</span><a class="header-link" href="/about/" data-reactid="13">About</a></div></div><div style="flex-shrink:2;" data-reactid="14"><span data-reactid="15"></span></div></div><div class="markdown" data-reactid="16"><!-- react-empty: 17 --><h5 style="display:block;color:rgba(100,100,100, 0.7);margin-bottom:0.35rem;" data-reactid="18">January 6, 2014</h5><h1 style="margin-top:0;margin-bottom:1rem;" data-reactid="19">Digging Into Knockout Builds</h1><div class="article-body" data-reactid="20"><p>There’s a lot you can learn by looking through other people’s code.  This is especially true when you’re looking at widely used open-source libraries, where you can see how people have solved real problems with code that has been battle-tested and debated.</p>
<p>In this spirit of code literacy, I spent some time this past weekend to look through the source code for <a href="http://knockoutjs.com/">KnockoutJS</a>.  Knockout is a MVVM library in Javascript designed to make 2 way declarative bindings easy.  I’m wanted to write a bit about what I saw in Knockout’s structure and build process.</p>
<h3>Intro</h3>
<p>Some of the first decisions a developer has to make when starting a new javascript project revolve around project structure and build processes.  They need to decide how they’ll handle things like testing and minification.  For a library like Knockout, developers also need to figure out how to make sure that they don’t expose any internal logic to the global scope.  This post takes a look at how Knockout deals with these challenges.  You can follow along by getting <a href="https://github.com/knockout/knockout">the source</a> off of Github.</p>
<h3>Project Structure</h3>
<p>Knockout is organized with a traditional <code>src</code>,<code>spec</code>,<code>build</code> structure, with the main src code in the src directory, <a href="http://pivotal.github.io/jasmine/">Jasmine</a> tests in the spec directory, and build-related files in the build directory.  The src directory is fairly flat, with directories for bindings, templating and subscribables.  The spec directory does not mirror it exactly.  The spec files are organized around functional categories at the root of the source files, with a separate directory holding tests for the default bindings.   The build direction contains several files related to the build process, which I’ll discuss below.  In the root directory there are dotfiles for <a href="https://npmjs.org/">NPM</a>, <a href="http://git-scm.com/">git</a>, and <a href="http://about.travis-ci.org/">TravisCI</a>, a package.json file, and the gruntfile.</p>
<h3>Grunt</h3>
<p>Knockout’s build process is automated using Grunt, an automation tool built on <a href="xmpux.cisco.com">NodeJS</a>.  Knockout’s gruntfile weighs in at a very readable 150 lines of code, and only defines one task.  That default task looks like this:</p>
<pre><code class="language-javascript"><span class="hljs-comment">//Grunt Default Task</span>
grunt.registerTask(<span class="hljs-string">'default'</span>, [<span class="hljs-string">'clean'</span>, <span class="hljs-string">'checktrailingspaces'</span>, <span class="hljs-string">'build'</span>, <span class="hljs-string">'test'</span>]);
</code></pre>
<p>So when you build knockout you’re executing 4 steps.</p>
<h4>Clean</h4>
<p>This deletes the knockout-latest.debug.js and knockout-latest.min.js files from the <code>build/output</code> directory</p>
<h4>Check Trailing Spaces</h4>
<p>This checks source files for trailing spaces and throws an error if they exist, ending the build.</p>
<h4>Build</h4>
<p>More detail on this below.</p>
<h4>Test</h4>
<p>Test spawns a child process which calls 2 scripts: ‘spec/runner.phantom.js’ and ‘spec/runner.node.js’.  The script runs asynchronously in the background, with the results being passed to standard out through a callback.</p>
<pre><code class="language-javascript"><span class="hljs-comment">//Grunt Test Task</span>
grunt.initConfig({
    <span class="hljs-comment">//...</span>
    test: {
        <span class="hljs-attr">phantomjs</span>: <span class="hljs-string">'spec/runner.phantom.js'</span>,
        <span class="hljs-attr">node</span>: <span class="hljs-string">'spec/runner.node.js'</span>
    }
});

grunt.registerMultiTask(<span class="hljs-string">'test'</span>, <span class="hljs-string">'Run tests'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> done = <span class="hljs-keyword">this</span>.async();
    grunt.util.spawn({ <span class="hljs-attr">cmd</span>: <span class="hljs-keyword">this</span>.target, <span class="hljs-attr">args</span>: [<span class="hljs-keyword">this</span>.data] },
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, result, code</span>) </span>{
            <span class="hljs-keyword">if</span> (code === <span class="hljs-number">127</span> <span class="hljs-comment">/*not found*/</span>) {
                grunt.verbose.error(result.stderr);
                <span class="hljs-comment">// ignore this error</span>
                done(<span class="hljs-literal">true</span>);
            } <span class="hljs-keyword">else</span> {
                grunt.log.writeln(result.stdout);
                <span class="hljs-keyword">if</span> (error)
                    grunt.log.error(result.stderr);
                done(!error);
            }
        }
    );
});
</code></pre>
<p>Overall a few things stand out about Knockout’s gruntfile.</p>
<ol>
<li>
<p>It’s written with no dependencies other than the base grunt-cli package, which is specifically called out in package.json to be run locally.  This is in sharp contrast to most Grunt-based projects I’ve seen, which assume a global install of Grunt and then make heavy use of the Grunt plugin ecosystem.</p>
</li>
<li>
<p>The only code consistency check is flagging trailing whitespace. Rather than enforce styling with a tool like jsHint, the build process only protects the integrity of the diffs with the whitespace check. This is probably a consequence of the plugin-free build file set up.  Overall the build philosophy seems to aim to keep things as simple as possible.</p>
</li>
</ol>
<h3>The Build Process</h3>
<p>So what happens with the build command?  When it’s executed the build command runs a task which creates 2 files, knockout-latest.debug.js and knockout-latest.min. Each of them contain the same content, with the debug version wrapped in an <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/">IIFE</a>, and the minified version run through Google closure compiler.</p>
<p>The content is pulled together with the <code>getCombinedSources</code> function:</p>
<pre><code class="language-javascript"><span class="hljs-comment">//Grunt Build Task</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCombinedSources</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> fragments = grunt.config(<span class="hljs-string">'fragments'</span>),
        sourceFilenames = [
            fragments + <span class="hljs-string">'extern-pre.js'</span>,
            fragments + <span class="hljs-string">'amd-pre.js'</span>,
            getReferencedSources(fragments + <span class="hljs-string">'source-references.js'</span>),
            fragments + <span class="hljs-string">'amd-post.js'</span>,
            fragments + <span class="hljs-string">'extern-post.js'</span>
        ],
        flattenedSourceFilenames = <span class="hljs-built_in">Array</span>.prototype.concat.apply([], sourceFilenames),
        combinedSources = flattenedSourceFilenames.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filename</span>) </span>{
            <span class="hljs-keyword">return</span> grunt.file.read(<span class="hljs-string">'./'</span> + filename);
        }).join(<span class="hljs-string">''</span>);

    <span class="hljs-keyword">return</span> combinedSources.replace(<span class="hljs-string">'##VERSION##'</span>, grunt.config(<span class="hljs-string">'pkg.version'</span>));
}
</code></pre>
<p>So this takes each of the files returned by the getReferencedSources function, and wraps them with 2 more files on each side.  Lets look at the wrapper files first.</p>
<p>extern-pre.js sets up an IIFE and defines several global values within the local scope.  This is done in order to protect against any reuse of these names in the local scope where knockout is loaded.</p>
<pre><code class="language-javascript"><span class="hljs-comment">//extern-pre.js</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">undefined</span>)</span>{
    <span class="hljs-comment">// (0, eval)('this') is a robust way of getting a reference to the global object</span>
    <span class="hljs-comment">// For details, see http://stackoverflow.com/questions/14119988/return-this-0-evalthis/14120023#14120023</span>
    <span class="hljs-keyword">var</span> <span class="hljs-built_in">window</span> = <span class="hljs-keyword">this</span> || (<span class="hljs-number">0</span>, <span class="hljs-built_in">eval</span>)(<span class="hljs-string">'this'</span>),
        <span class="hljs-built_in">document</span> = <span class="hljs-built_in">window</span>[<span class="hljs-string">'document'</span>],
        navigator = <span class="hljs-built_in">window</span>[<span class="hljs-string">'navigator'</span>],
        jQuery = <span class="hljs-built_in">window</span>[<span class="hljs-string">"jQuery"</span>],
        <span class="hljs-built_in">JSON</span> = <span class="hljs-built_in">window</span>[<span class="hljs-string">"JSON"</span>];
</code></pre>
<p>amd-pre.js determines the type of module system in use (if any) and passes the correct object into the inner scope as koExports.</p>
<pre><code class="language-javascript"><span class="hljs-comment">//amd-pre.js</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">factory</span>) </span>{
  <span class="hljs-comment">// Support three module loading scenarios</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">require</span> === <span class="hljs-string">'function'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> exports === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> === <span class="hljs-string">'object'</span>) {
    <span class="hljs-comment">// [1] CommonJS/Node.js</span>
    <span class="hljs-keyword">var</span> target = <span class="hljs-built_in">module</span>[<span class="hljs-string">'exports'</span>] || exports; <span class="hljs-comment">//module.exports is for Node.js</span>
    factory(target);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define[<span class="hljs-string">'amd'</span>]) {
    <span class="hljs-comment">// [2] AMD anonymous module</span>
    define([<span class="hljs-string">'exports'</span>], factory);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// [3] No module loader (plain &lt;script&gt; tag) - put directly in global namespace</span>
    factory(<span class="hljs-built_in">window</span>[<span class="hljs-string">'ko'</span>] = {});
  }
})
</code></pre>
<p>The *-post.js files simply close these function statements.</p>
<p>So in the end we’re left with an IIFE that wraps all of the content and defines global variables within the scope, and then executes a second IIFE which determines the module format in use and executes the inner factory function accordingly.  The factory function is made up of the various files in the src directory, concatenated together in the order specified in build/fragments/source-references.js.</p>
<h3>Initializing the library</h3>
<p>The first few files loaded into the inner function are short files designed to provide a base for the library.</p>
<p>namespace.js sets up the ko object that is referenced internally in the file.</p>
<pre><code class="language-javascript"><span class="hljs-comment">//namespace.js</span>
<span class="hljs-comment">// Internally, all KO objects are attached to koExports (even the non-exported ones whose names will be minified by the closure compiler).</span>
<span class="hljs-comment">// In the future, the following "ko" variable may be made distinct from "koExports" so that private objects are not externally reachable.</span>
<span class="hljs-keyword">var</span> ko = <span class="hljs-keyword">typeof</span> koExports !== <span class="hljs-string">'undefined'</span> ? koExports : {};
</code></pre>
<p>google-closure-compiler-utils.js defines two helper functions, exportSymbol and exportProperty which allow for greater minimization of the internal ko library while maintaining a consistent external api.  These functions are used everywhere throughout the library for defining externally facing function and property names.</p>
<pre><code class="language-javascript"><span class="hljs-comment">//google-closure-compiler-utils.js</span>

<span class="hljs-comment">// Google Closure Compiler helpers (used only to make the minified file smaller)</span>
ko.exportSymbol = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">koPath, object</span>) </span>{
    <span class="hljs-keyword">var</span> tokens = koPath.split(<span class="hljs-string">"."</span>);

    <span class="hljs-comment">// In the future, "ko" may become distinct from "koExports" (so that non-exported objects are not reachable)</span>
    <span class="hljs-comment">// At that point, "target" would be set to: (typeof koExports !== "undefined" ? koExports : ko)</span>
    <span class="hljs-keyword">var</span> target = ko;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; tokens.length - <span class="hljs-number">1</span>; i++)
        target = target[tokens[i]];
    target[tokens[tokens.length - <span class="hljs-number">1</span>]] = object;
};
ko.exportProperty = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">owner, publicName, object</span>) </span>{
  owner[publicName] = object;
};
</code></pre>
<p>Finally version.js sets up a placeholder for ko.version, which is then replaced with the version number in Package.json as part of the grunt build task.</p>
<pre><code class="language-javascript"><span class="hljs-comment">//version.js</span>
ko.version = <span class="hljs-string">"##VERSION##"</span>;

ko.exportSymbol(<span class="hljs-string">'version'</span>, ko.version);
</code></pre>
<h3>Conclusion</h3>
<p>There are a few interesting things we can note from Knockout’s build approach.</p>
<h4>Using IIFE’s to isolate local scope is a practical and important technique for library design</h4>
<p>If you’ve been counting, the debug version of the library is wrapped in 3 different levels of IIFEs before any code exposing external functionality is actually included.  This allows Knockout to provide several layers of data protection and abstraction, making sure that it is referencing the correct global variables and preventing scope leaks.</p>
<h4>Its relatively straightforward to support module formats even if your library doesn’t use them internally</h4>
<p>Take a look again at amd-pre.js.  Its 15 lines of code to support AMD loaders, CommonJS loaders and normal script tag loading.  Knockout doesn’t use a modern “module solution” approach to code organization.  Instead it uses a more traditional namespacing approach wrapped in IIFEs.  But it still plays well with others nicely.  It’s hard to see how this type of effort wouldn’t be worth it for library designers.</p>
</div><div data-reactid="21"><hr data-reactid="22"/><div class="subscribe-container" data-reactid="23"><div class="subscribe-block" data-reactid="24"><p data-reactid="25"><!-- react-text: 26 -->Thanks for taking the time to read this post!<!-- /react-text --><!-- react-text: 27 --> JavaScript development<!-- /react-text --><!-- react-text: 28 --> is one of the main topics of this blog, so if you enjoyed the post, please consider subscribing by using the feed, Twitter or my mailing list.<!-- /react-text --></p><div style="margin-bottom:3.5rem;" data-reactid="29"><div id="mc_embed_signup" data-reactid="30"><h6 style="margin:0;font-size:0.8165rem;line-height:1.4rem;letter-spacing:-0.25px;" data-reactid="31">EMAIL</h6><form action="//benmccormick.us8.list-manage.com/subscribe/post?u=115446b80fd9d930ba091cc27&amp;id=f5b9f5acf2" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="" data-reactid="32"><div id="mc_embed_signup_scroll" data-reactid="33"><div class="mc-field-group" style="padding-right:30px;" data-reactid="34"><input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address" data-reactid="35"/><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button" data-reactid="36"/></div><div id="mce-responses" class="clear" data-reactid="37"><div class="response" id="mce-error-response" style="display:none;" data-reactid="38"></div><div class="response" id="mce-success-response" style="display:none;" data-reactid="39"></div></div><div style="position:absolute;left:-5000px;" aria-hidden="true" data-reactid="40"><input type="text" name="b_115446b80fd9d930ba091cc27_f5b9f5acf2" tabindex="-1" value="" data-reactid="41"/></div><div class="clear" data-reactid="42"></div></div></form></div><div class="rss" data-reactid="43"><h6 style="margin:0;font-size:0.8165rem;line-height:1.4rem;letter-spacing:-0.25px;" data-reactid="44">RSS</h6><a href="/rss/" data-reactid="45"><i class="rss-icon" data-reactid="46"><svg viewBox="0 0 10 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>rss</title><desc>Created with Sketch.</desc><defs></defs><g id="Octicons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="rss" fill="#000000"><path d="M2,13 L0,13 L0,11 C1.11,11 2,11.89 2,13 L2,13 Z M0,3 L0,4 C4.97,4 9,8.03 9,13 L10,13 C10,7.48 5.52,3 0,3 L0,3 Z M0,7 L0,8 C2.75,8 5,10.25 5,13 L6,13 C6,9.69 3.31,7 0,7 L0,7 Z" id="Shape"></path></g></g></svg></i><!-- react-text: 47 --> <!-- /react-text --><span data-reactid="48">RSS</span></a></div><div data-reactid="49"><h6 style="margin:0;font-size:0.8165rem;line-height:1.4rem;letter-spacing:-0.25px;" data-reactid="50">TWITTER</h6><div class="twitter-item" data-reactid="51"><span data-reactid="52">Site Feed: </span><a href="https://twitter.com/benmccormickorg" class="twitter-follow-button" data-show-count="false" data-reactid="53">Follow @benmccormickorg</a></div></div><div data-reactid="54"><div class="twitter-item" data-reactid="55"><span data-reactid="56">Personal Feed: </span><a href="https://twitter.com/ben336" class="twitter-follow-button" data-show-count="false" data-reactid="57">Follow @ben336</a></div></div></div></div><div class="up-next-block" data-reactid="58"><h6 style="margin:0;font-size:0.8165rem;line-height:1.4rem;letter-spacing:-0.25px;" data-reactid="59">You Might Also Like:</h6><div data-reactid="60"><h3 style="margin-top:0;margin-bottom:0.35rem;" data-reactid="61"><a href="/2015/11/25/productive-javascript-development/?readNext=true#title" data-reactid="62">Productive JavaScript Development</a></h3><p data-reactid="63">An examination of what makes JavaScript development productive</p></div><div data-reactid="64"><hr data-reactid="65"/><h3 style="margin-top:0;margin-bottom:0.35rem;" data-reactid="66"><a href="/2013/05/07/revertible-observables-in-knockout/?readNext=true#title" data-reactid="67">Revertible Observables in Knockout</a></h3><p data-reactid="68">Building an observable with simple undo functionality</p></div><div data-reactid="69"><hr data-reactid="70"/><h3 style="margin-top:0;margin-bottom:0.35rem;" data-reactid="71"><a href="/2013/01/06/book-review-effective-javascript/?readNext=true#title" data-reactid="72">Book Review: Effective Javascript</a></h3><p data-reactid="73">A book review of Effective Javascript by David Herman</p></div></div></div></div><hr style="margin-bottom:2.8rem;" data-reactid="74"/><div title="Digging Into Knockout Builds" data-reactid="75"><div id="disqus_thread" data-reactid="76"></div><noscript data-reactid="77"><span data-reactid="78"><!-- react-text: 79 -->Please enable JavaScript to view the<!-- /react-text --><a href="http://disqus.com/?ref_noscript" data-reactid="80">comments powered by Disqus.</a></span></noscript><a href="http://disqus.com" class="dsq-brlink" data-reactid="81"><!-- react-text: 82 -->Blog comments powered by <!-- /react-text --><span class="logo-disqus" data-reactid="83">Disqus</span><!-- react-text: 84 -->.<!-- /react-text --></a></div></div><span style="display:block;clear:both;" data-reactid="85"> </span></div></div><script src="/bundle.js?t=1488586324038"></script><script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-37323973-1', 'auto');
            ga('send', 'pageview');
        </script><script type="text/javascript">
              // adapted from: https://css-tricks.com/serviceworker-for-offline/
              // ServiceWorker is a progressive technology. Ignore unsupported browsers
              if ('serviceWorker' in navigator) {
              console.log('CLIENT: service worker registration in progress.');
              navigator.serviceWorker.register('/sw.js').then(function() {
                console.log('CLIENT: service worker registration complete.');
              }, function() {
                console.log('CLIENT: service worker registration failure.');
              });
              } else {
              console.log('CLIENT: service worker is not supported.');
              }
            </script></body></html>